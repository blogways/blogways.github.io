<!DOCTYPE html>
<html lang='zh-CN'>
<head>
    <title>MongoDB 入库速度和分片的关系_博汇网_www.blogways.net</title>
    <meta name=keywords content="MongoDB, Sharding, Speed, 分片, 入库速度">
    
    <meta name=description content="针对特定的应用程序，单个MongoDB实例的入库速率极限是多少？分片的片数与入库速率之间是什么关系？单台主机最合适启动的MongoDB 实例的个数？">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="http://cdn.bootcss.com/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src='/js/jquery-2.1.1.js'></script>
    <link rel='stylesheet' type='text/css' href='/bootstrap/css/bootstrap.css'>
    <link rel='stylesheet' type='text/css' href='/bootstrap/css/bootstrap-theme.css'>
    <link rel='stylesheet' type='text/css' href='/css/app.css'>
    <script src='/bootstrap/js/bootstrap.js'></script>
    <script src='/js/app.js'></script>
    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?ac29e786ae4e5463b445f1e0ad1f1d1e";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>
<body style='background-color: #f5f5f5;'>
    <div class='totop visible-lg visible-md visible-sm hidden-xs'>
        <a id='to-top' href='javascript:void(0)'>
            <span id='to-top-title'>返回</br>顶部</span>
        </a>
    </div>
    <div class='totop-xs hidden-lg hidden-md hidden-sm visible-xs'>
        <a id='to-top-xs' href='javascript:void(0)'>
            <span id='to-top-title-xs'>返回</br>顶部</span>
        </a>
    </div>
    <div class='headerbar'>
            <div class='navbar navbar-default navbar-fixed-top' role='navigation'>
        <div class='containr-fluid'>
            <div class='navbar-header'>
                <button type='button' class='navbar-toggle collapsed' data-toggle='collapse' data-target='#bw-navbar-collapse'>
                    <span class='sr-only'>下拉框</span>
                    <span class='icon-bar'></span>
                    <span class='icon-bar'></span>
                    <span class='icon-bar'></span>
                </button>
                <a class='navbar-brand' href='/'>Blog<span>ways</span></a>
            </div>
            <div class='navbar-collapse collapse' id='bw-navbar-collapse'>
                <ul class='nav navbar-nav'>
                    <li><a href='/'>主页</a></li>
                    <li class='divider visible-xs'></li>
                    
                    <li class='dropdown visible-sm visible-xs active'>
                        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>热门分类
                            <span class='caret'></span>
                        </a>
                        <ul class='dropdown-menu cate-drop-menu' role='menu'>
                            
                            <li>
                                <a href='/categories/Jekyll/'>Jekyll
                                    <span class='badge pull-right'>4</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/杂记/'>杂记
                                    <span class='badge pull-right'>28</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/JUnit/'>JUnit
                                    <span class='badge pull-right'>8</span>
                                </a>
                            </li>
                            
                            <li class='disabled active'>
                                <a href='javascript:void(0)'>NoSQL
                                    <span class='badge pull-right'>11</span>
                                </a>
                                </li>
                            
                            <li>
                                <a href='/categories/Sencha/'>Sencha
                                    <span class='badge pull-right'>5</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/Nginx/'>Nginx
                                    <span class='badge pull-right'>4</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/Apache/'>Apache
                                    <span class='badge pull-right'>10</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/Node.js/'>Node.js
                                    <span class='badge pull-right'>7</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/Express/'>Express
                                    <span class='badge pull-right'>14</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/jQuery/'>jQuery
                                    <span class='badge pull-right'>21</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/Java/'>Java
                                    <span class='badge pull-right'>8</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/Solr/'>Solr
                                    <span class='badge pull-right'>6</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/WordPress/'>WordPress
                                    <span class='badge pull-right'>3</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/drupal/'>drupal
                                    <span class='badge pull-right'>2</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/joomla/'>joomla
                                    <span class='badge pull-right'>1</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/design/'>design
                                    <span class='badge pull-right'>5</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/Web前端/'>Web前端
                                    <span class='badge pull-right'>1</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/keepalived/'>keepalived
                                    <span class='badge pull-right'>1</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/iot/'>iot
                                    <span class='badge pull-right'>1</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/web前端/'>web前端
                                    <span class='badge pull-right'>15</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/交互设计/'>交互设计
                                    <span class='badge pull-right'>6</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/Spring/'>Spring
                                    <span class='badge pull-right'>1</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/web后端/'>web后端
                                    <span class='badge pull-right'>1</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/git/'>git
                                    <span class='badge pull-right'>1</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/索引/'>索引
                                    <span class='badge pull-right'>1</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/storm/'>storm
                                    <span class='badge pull-right'>2</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/Python/'>Python
                                    <span class='badge pull-right'>2</span>
                                </a>
                            </li>
                            
                            <li>
                                <a href='/categories/nodejs/'>nodejs
                                    <span class='badge pull-right'>1</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class='dropdown'>
                        <a class='dropdown-toggle' data-toggle='dropdown' href='#'>关于我们
                            <span class='caret'></span>
                        </a>
                        <ul class='dropdown-menu' role='menu'>
                            <li><a href='/about.html'>所有信息</a></li>
                            <li class='divider'></li>
                            <li><a href='/authors/chenfan/'>陈凡</a></li>
                            <li><a href='/authors/chenwt/'>陈文婷</a></li>
                            <li><a href='/authors/fukui/'>付奎</a></li>
                            <li><a href='/authors/huangmai/'>黄劢</a></li>
                            <li><a href='/authors/huqinghai/'>胡青海</a></li>
                            <li><a href='/authors/jacky/'>Jacky</a></li>
                            <li><a href='/authors/jyjsjd/'>景阳</a></li>
                            <li><a href='/authors/liuyiwei/'>刘益伟</a></li>
                            <li><a href='/authors/tangshizhong/'>汤仕忠</a></li>
                            <li><a href='/authors/tangzhi/'>唐治</a></li>
                            <li><a href='/authors/wangdong/'>王栋</a></li>
                            <li><a href='/authors/wanghui/'>汪回</a></li>
                            <li><a href='/authors/xuwannian/'>徐万年</a></li>
                            <li><a href='/authors/wanzhou/'>万洲</a></li>
                            <li><a href='/authors/zhangke/'>张可</a></li>
                            <li><a href='/authors/zhangshaoyong/'>张少勇</a></li>
                            <li><a href='/authors/zhaojiajun/'>赵家君</a></li>
                        </ul>
                    </li>
                    <li><a href='https://github.com/blogways/blogways.github.io' title='https://github.com/blogways/blogways.github.io' target='_blank'>联系我们</a></li>
                </ul>
                <!--<form class="navbar-form navbar-right hidden-sm hidden-xs" role="search">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search">
                            <button type="submit" class="btn btn-default">Submit</button>
                    </div>
                </form>-->
                <p class="navbar-text navbar-right hidden-sm hidden-xs"><small>汇集优秀博文(关注:敏捷开发/WEB开发/移动终端开发/NOSQL/云计算...)尽在</small><a href="/" class="navbar-link">Blogways</a>!</p>
            </div>
        </div>    
    </div>

    </div>
        <script>
        $(document).ready(function(){
            (function(){
                $.getJSON("/authors.json",function(mJSON){
                    $.each( mJSON , function( i , item ){
                        var name = item.name.toLowerCase().replace(" ","") || "";
                        var page_name = "万洲".toLowerCase().replace(" ","");
                        var num = item.articles.length || 0;
                        if(name == page_name){
                            $("#pt-article-num").append( num + " 篇博文" );
                        }
                    });
                });
            })();
        });
    </script>

    <div class='container'>
        <div class='row main-content'>
            <div class='col-md-9 col-sm-12 col-xs-12 mainbar'>
                <div class='pt-article'>
                    <div class='panel panel-default pt-article-extra'>
                        <div class='panel-body'>
                            <div class='pt-article-pn row'>
                                
                                <div class='col-lg-6 col-md-6 col-sm-12 col-xs-12'>
                                    <span>上一篇:
                                        <a href='/blog/2015/05/05/mongodb-sharding-introduction-by-docs.html' title='MongoDB 分片介绍'>MongoDB 分片介绍</a>
                                    </span>
                                </div>
                                
                                
                                <div class='col-lg-6 col-md-6 col-sm-12 col-xs-12'>
                                    <span class='pull-right hidden-sm hiden-xs visible-lg visible-md'>下一篇:
                                        <a href='/blog/2015/05/05/solr-usage-4.html' title='Solr 应用（四）－企业应用'>Solr 应用（四）－企业应用</a>
                                    </span>
                                    <span class='hidden-lg hiden-md visible-sm visible-xs'>下一篇:
                                        <a href='/blog/2015/05/05/solr-usage-4.html' title='Solr 应用（四）－企业应用'>Solr 应用（四）－企业应用</a>
                                    </span>
                                </div>
                                
                            </div><!--end of article-pn-->
                            <hr class='hidden-sm hidden-xs'>
                            <div class='pt-article-info'>
                                <div class='pt-article-title'>
                                    <h2>MongoDB 入库速度和分片的关系
                                        <small class='pt-article-date hidden-xs'>
                                            <span class='glyphicon glyphicon-calendar'></span>&nbsp;
                                            <span class='sr-only'>发布于&nbsp;:&nbsp;</span>2015-05-05
                                        </small>
                                    </h2>
                                </div>
                                <div class='row pt-article-tags'>
                                    <div class='col-xs-12 post-tags'>
                                        <span class='glyphicon glyphicon-tags'></span>&nbsp;
                                        
                                        <a class='label label-info' href='#'>MongoDB</a>
                                        
                                        、
                                        
                                        <a class='label label-info' href='#'>Sharding</a>
                                        
                                        、
                                        
                                        <a class='label label-info' href='#'>Speed</a>
                                        
                                        、
                                        
                                        <a class='label label-info' href='#'>分片</a>
                                        
                                        、
                                        
                                        <a class='label label-info' href='#'>入库速度</a>
                                        
                                        
                                    </div>
                                </div>
                                <div class='pt-article-tags'>
                                    分类: <a class='label label-info' href='/categories//'>NoSQL</a>
                                </div>
                                <div class='pt-article-tags'>
                                    <!-- Baidu Button BEGIN -->
<div id="bdshare" class="bdshare_t bds_tools_32 get-codes-bdshare">
<a class="bds_qzone"></a>
<a class="bds_tsina"></a>
<a class="bds_tqq"></a>
<a class="bds_renren"></a>
<a class="bds_t163"></a>
<span class="bds_more"></span>
<a class="shareCount"></a>
</div>
<script type="text/javascript" id="bdshare_js" data="type=tools&amp;uid=59150" ></script>
<script type="text/javascript" id="bdshell_js"></script>
<script type="text/javascript">
document.getElementById("bdshell_js").src = "http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=" + Math.ceil(new Date()/3600000)
</script>
<!-- Baidu Button END -->

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class='pt-article-main'>
                        <div class='panel panel-default'>
                            <div class='panel-body'>
                                <div class='pt-article-content'>
                                    <h2 id="一背景">一、背景</h2>
<p>实时采集主机的日志文件，发送到 node.js 处理程序( 暂时叫做 <strong>load</strong> )，经过一些数据处理后插入到 MongoDB 持久存储。由于采集的主机数量较多，导致了如下问题：</p>

<ul>
  <li>每秒需要入库的数据量很大，单个 MongoDB 无法满足这些数据的入库要求，导致插入的拥堵，导致 MongoDB 中的不是实时的数据；</li>
  <li>MongoDB 缓存到内存中的热数据量太多，单台主机无法满足如此大的内存需求；</li>
  <li>MongoDB 持久化存储到本地磁盘的数据非常大( 有些表一天的数据量有上千万条 )，需要的存储空间很大，单台无法满足要求。</li>
</ul>

<p>考虑到<strong>纵向扩展</strong>的代价较高，决定采用 MongoDB 的分片机制来实现，需要探究的问题：</p>

<ol>
  <li>单个 MongoDB 实例的入库速率极限是多少；</li>
  <li><strong>load</strong>( 处理接收到的日子文件，并入库到MongoDB )的数量与入库速率的关系；</li>
  <li>分片的片数与入库速率的关系；</li>
  <li>单台主机( 8核心，16G )启动<strong>load</strong>和 MongoDB 实例的最合适个数；</li>
</ol>

<h2 id="二测试单个mongodb入库极限">二、测试单个MongoDB入库极限</h2>
<p>启动一个 MongoDB 实例，分别测试启动多个<strong>load</strong>时，MongoDB的入库速率( 10min中入库的记录条数 )，发往<strong>load</strong>的日子数量充足；</p>

<p>MongoDB 实例启动：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>mongod --dbpath /data/mongodb/db --logpath /data/mongodb/logs/mongod.log --nojournal --fork 具体命令吃处不在讲解，详见[MongoDB 安装与分布式部署](http://www.blogways.net/blog/2015/05/04/mongodb-install-and-distribution-deploy.html)
</code></pre>
</div>

<h3 id="测试结果">测试结果</h3>
<table width="100%">
<tr><th>load 个数</th><th>十分钟入库数</th><th>入库速率( 条/sec )</th></tr>
<tr><td>1</td><td>222902</td><td>372</td></tr>
<tr><td>2</td><td>260933</td><td>435</td></tr>
<tr><td>3</td><td>259581</td><td>433</td></tr>
<tr><td>4</td><td>260966</td><td>435</td></tr>
</table>

<h3 id="结论">结论</h3>
<p>针对当前<strong>load</strong> 应用处理程序，单个 MongoDB 实例的入库极限速度为：<code class="highlighter-rouge">435 条/sec</code>。</p>

<h3 id="注意">注意</h3>
<ul>
  <li>测试中还记录并且计算了其它时间长度的入库速度，有一些差异，但都在误差的范围内；</li>
  <li>针对不同的处理入库逻辑，测出的入库极限速度都不同，本内容的所有数据都是基于自己的<strong>load</strong>，仅供参考。</li>
</ul>

<h2 id="三分片数与入库速率的关系-python-">三、分片数与入库速率的关系( python )</h2>
<p>考虑到日志的抓去、<strong>load</strong>的处理和数据入库中间存在很多的不确定性，因而首先只选择测试每秒钟插入记录数来表面存在的关系。</p>

<h3 id="测试方案">测试方案</h3>
<p>分别在 3 台不同的主机上部署3个配置服务器(Config Server)，在其中的一台上面部署 3 个查询路由(Query Router)，最后在另一台主机上( 不包含在部署Config Server 和 Query Router主机内 )，分别启动1、2、3、4个分片(按照 <code class="highlighter-rouge">host</code>字段，<strong><em>Hash 分片</em></strong>)；</p>

<p>通过<code class="highlighter-rouge">ruby</code>语言编写插入记录程序( 需要pymongo插件 )，部分代码如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/env python</span>

<span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span><span class="nn">datetime</span><span class="o">,</span><span class="nn">random</span>
<span class="c"># 启动的3个查询路由</span>
<span class="n">db1</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s">'10.20.16.78:27017'</span><span class="p">)</span><span class="o">.</span><span class="n">test</span>
<span class="n">db2</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s">'10.20.16.78:27018'</span><span class="p">)</span><span class="o">.</span><span class="n">test</span>
<span class="n">db3</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s">'10.20.16.78:27019'</span><span class="p">)</span><span class="o">.</span><span class="n">test</span>

<span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
	    <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    	<span class="k">if</span> <span class="n">rand</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
	        <span class="n">db</span> <span class="o">=</span> <span class="n">db1</span>
        <span class="k">elif</span> <span class="n">rand</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        	<span class="n">db</span> <span class="o">=</span> <span class="n">db2</span>
    	<span class="k">else</span><span class="p">:</span>
	        <span class="n">db</span> <span class="o">=</span> <span class="n">db3</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="p">{</span>
        	<span class="s">"host"</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span>
        	<span class="c"># 生成插入的对象</span>
        <span class="p">}</span>
	    <span class="n">db</span><span class="o">.</span><span class="n">objInsert</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

<span class="n">insert</span><span class="p">(</span><span class="mi">300000</span><span class="p">)</span> <span class="err">上面的每个脚本表示插入</span> <span class="mi">300000</span> <span class="err">条记录到分片表中，此处为测试分三片时候的入库速率；</span>
</code></pre>
</div>

<h3 id="配置">配置</h3>
<p>将<code class="highlighter-rouge">test.objInsert</code>表按照<code class="highlighter-rouge">host</code>字段哈希分片：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sh.shardCollection('test.objInsert', {'host': 'hashed'}) 启动`python`脚本向数据库插入数据，记录10s、1min的插入速率。
</code></pre>
</div>

<h3 id="测试数据">测试数据</h3>
<p>应该很多次测试，此处只贴出一次结果：</p>

<table width="100%">
<tr><th>分片 片数</th><th>10s入库数</th><th>入库速率( 条/sec )</th></tr>
<tr><td>1 (不分片)</td><td>120263</td><td>12026</td></tr>
<tr><td>2</td><td>148543</td><td>14854</td></tr>
<tr><td>3</td><td>185022</td><td>18502</td></tr>
</table>
<p>绘制的平滑标记散点连线图，如下所示：</p>

<p><img src="/images/post/sharding-rate-result.png" alt="sharding-rate-result" /></p>

<h3 id="结论-1">结论</h3>
<p>由上图可得到一个大概的猜想：<strong><em>入库速率与分片片数呈线性关系！</em></strong></p>

<h3 id="注意-1">注意</h3>
<p>由于主机数、主机内存等愿意的限制，没法启动太多的<code class="highlighter-rouge">python</code>脚本用于数据插入，实际测试用用的两台机器来插入测试；</p>

<p>测试主机还有其它程序占用CPU等，没法长时间处于<code class="highlighter-rouge">python</code>脚步执行状态，测试只记录 10s 中的数据；还有可能涉及到其它原因，长时间插入会出现速率波动；</p>

<h2 id="四入库速度与load数量的关系">四、入库速度与load数量的关系</h2>
<p>由于 node.js 连接 MongoDB 的所有数据库操作都是异步调用的，所以很多操作只能在回调函数中进行，或通过其它方式将其转换为同步操作( 如：<code class="highlighter-rouge">async</code>、<code class="highlighter-rouge">EventProxy</code> )。</p>

<p>在测试的初期，发现有时候<strong>load</strong>占用的内存会不断的升高，有时候甚至会导致<strong>load</strong>程序崩溃，后来实验发现，是因为MongoDB 的入库速率达到了瓶颈，而又有不断的数据插入，导致回掉函数无法立即执行并积压在内存中，是的占用内存越来越高，最后程序崩溃。</p>

<p>根据上述原因，可以通过load的内存占用来侧面反应<strong>load</strong>和MongoDB的工作状态：</p>

<ul>
  <li>内存占用过高，<strong>load</strong>对接收到的日志处理不过来，或MongoDB的入库速率到达极限；</li>
  <li>内存占用正常或稍微偏高( 10 ~ 100M之内 )，<strong>load</strong>和 MongoDB都处在比较理想的工作状态；</li>
  <li>内存占用偏低，<strong>load</strong>或 MongoDB的性能部分处于闲置状态。</li>
</ul>

<p>在做本项测试的时候，需要保证 MongoDB的出来能力能满足所有<strong>load</strong>个数的限制，观察不同个数时的入库记录条数；因而在必要的时候需要启动多个分片；</p>

<h3 id="测试方案-1">测试方案</h3>
<p>分别启动1、2、3、4个<strong>load</strong>，并启动相应的分片数( 使得每个<strong>load</strong>的内存占用正常 )，启动3个配置服务器；考虑到多个<strong>load</strong>的情况，传递过来的日子数据通过<code class="highlighter-rouge">nginx</code>按 <strong>响应时间</strong> 做负载均衡处理。</p>

<h3 id="测试数据-1">测试数据</h3>
<table width="100%">
<tr><th>load 个数</th><th>10min入库数</th><th>入库速率( 条/sec )</th></tr>
<tr><td>1</td><td>227079</td><td>379</td></tr>
<tr><td>2</td><td>447980</td><td>747</td></tr>
<tr><td>3</td><td>614332</td><td>1024</td></tr>
<tr><td>4</td><td>782492</td><td>1304</td></tr>
</table>

<p>绘制的平滑标记散点连线图，如下所示：</p>

<p><img src="/images/post/sharding-rate-load-num.png" alt="" /></p>

<p>多次测量的过程中，<strong>load</strong>的内存占用都在100 ~ 250 M之间，CPU 占用率100%左右( 完全占用一个物理CPU核心 )。</p>

<h3 id="结论-2">结论</h3>
<ul>
  <li>由上图可发现，<strong>load</strong>个数和入库速率所呈现的基本是一条直线，因而得到结论<strong>load</strong>的个数与入库速率成线性关系；</li>
  <li>由于<strong>load</strong>在正常工作情况下内存占用补不超过300M，这相对于一台主机的16G的内存来说很小，因而一台机器能启动的<strong>load</strong>的个数取决于其核心数，还要留一些用作它用，因而8核心CPU主机，启动 <strong>4 ~ 7</strong>个<strong>load</strong>是比较合适的。</li>
</ul>

<h3 id="注意-2">注意</h3>
<ul>
  <li>在测试4个<strong>load</strong>的时候，开始使用了3个配置服务器，4个分片，结果每个<strong>load</strong>的内存占用都高达600M以上，说明分4片没法满足4个<strong>load</strong>的入库请求；</li>
  <li>然后使用3个配置服务器，6个分片，<strong>load</strong>的内存占用在400M以上，同样6个分片也无法满足要求；</li>
  <li>最后在启用8个分片后，内存占用降到了100M多一点，说明此时的MongoDB的处理入库速度完全够4个<strong>load</strong>使用。</li>
</ul>

<h2 id="五分片数与入库速率的关系-load-">五、分片数与入库速率的关系( load )</h2>
<p>有测试四的注意可知，4个<strong>load</strong>，3个配置服务器即可完成测试不分片、分2、3、4片时的入库速率。</p>

<h3 id="测试数据-2">测试数据</h3>
<table width="100%">
<tr><th>分片 片数</th><th>20min入库数</th><th>入库速率( 条/sec )</th></tr>
<tr><td>不分片</td><td>-</td><td>435</td></tr>
<tr><td>2</td><td>854605</td><td>712</td></tr>
<tr><td>3</td><td>1127365</td><td>940</td></tr>
<tr><td>4</td><td>14220( 2min )</td><td>1185</td></tr>
</table>

<p>绘制的平滑标记散点连线图，如下所示：</p>

<p><img src="/images/post/sharding-rate-result-load.png" alt="" /></p>

<p>每个<code class="highlighter-rouge">mongod</code>进程( 分片实例 )的CPU占用在繁忙的时候会接近100%，有时候甚至超过100%；</p>

<h3 id="结论-3">结论</h3>
<ul>
  <li>由上图可知，分片的片数与入库速率亦是成线性关系；</li>
  <li>由于CPU会超过100%的考虑，单台8核心的服务器，最多启动6个分片；</li>
</ul>

<h3 id="注意-3">注意</h3>
<ul>
  <li>单台主机的MongoDB 分片的片数选择主要考虑 CPU 的核心数；</li>
  <li>MongoDB 分片进程会讲插入的数据都保存到内存中，直到内存完全被耗光，后续的数据会持久化到磁盘空间，内存中只会保存热数据和索引。</li>
  <li>如果主机内存吃紧的话，启动分片实例的时候最好带<code class="highlighter-rouge">--nojurounal</code>启动。</li>
</ul>

<h2 id="六总结">六、总结</h2>
<ul>
  <li><strong>load</strong> 的个数和入库速率成线性关系；</li>
  <li>MongoDB 分片的片数和入库速率成线性关系；</li>
  <li>单台主机启动<strong>load</strong>的个数主要考虑因素是 CPU 核心数，最多启动 <code class="highlighter-rouge">n - 2 (n 为 cpu 核心数)</code>个；</li>
  <li>单台主机启动MongoDB 分片实例的个数，参考因素为 CPU 核心数，最多启动 <code class="highlighter-rouge">n - 2 (n 为 cpu 核心数)</code>个；</li>
</ul>

<p>&lt;/br&gt;
&lt;/br&gt;</p>

<p>===</p>

<p><strong><em>后续修改中。。。</em></strong></p>

                                </div>
                            </div>
                        </div>
                        <div class='row'>
                            
                            <div class='col-lg-6 col-md-6 col-sm-12 col-xs-12'>
                                <span>上一篇:
                                    <a href='/blog/2015/05/05/mongodb-sharding-introduction-by-docs.html' title='MongoDB 分片介绍'>MongoDB 分片介绍</a>
                                </span>
                            </div>
                            
                            
                            <div class='col-lg-6 col-md-6 col-sm-12 col-xs-12'>
                                <span class='pull-right hidden-sm hiden-xs visible-lg visible-md'>下一篇:
                                    <a href='/blog/2015/05/05/solr-usage-4.html' title='Solr 应用（四）－企业应用'>Solr 应用（四）－企业应用</a>
                                </span>
                                <span class='hidden-lg hiden-md visible-sm visible-xs'>下一篇:
                                    <a href='/blog/2015/05/05/solr-usage-4.html' title='Solr 应用（四）－企业应用'>Solr 应用（四）－企业应用</a>
                                </span>
                            </div>
                            
                        </div><!--end row-->
                    </div>
                </div>
            </div>
            <div class='col-md-3 hidden-sm hidden-xs sidebar'>

                <div class='authorbar panel panel-default'>
                    <div class='panel-heading'>
                        <h4 class='panel-title'>作品信息</h4>
                    </div>
                    <div class='pt-author-info row panel-body'>
                        <a class='col-lg-3 col-md-4'>
                            <img width='58' height='58' src='/images/pix3.jpg' alt='作者头像'>
                        </a>
                        <div class='col-md-6 media-body'>
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <h4 class='pt-author-name media-heading'>
                                <a id='pt-author-url' href='/authors/wanzhou/'>万洲</a>
                            
                            
                            
                            </h4>
                            <span id='pt-article-num'></span>
                        </div>
                    </div>
                </div><!--end of authorbar-->
                
                <div class='newbar panel panel-default' id='newbar'>
                    <div class='panel-heading'>
                        <h4 class='panel-title'>最新博文</h4>
                    </div>
                    <div class='list-group new-list'>
                        
                        <div class='list-group-item list-group-item-default'>
                            <h5 class='new-heading'>
                                <a href='/blog/2017/01/08/scrapy.html' title='Scrapy 爬虫框架入门'>Scrapy 爬虫框架入门</a>
                            </h5>
                            <span class='desc'>介绍Scrapy快速编写网络爬虫</span>
                            <div class='new-post-info'>
                                <span class='new-date'>
                                    <span class='glyphicon glyphicon-calendar'></span>
                                    <span class='sr-only'>&nbsp;:&nbsp;</span>
                                    2017-01-08
                                </span>&nbsp;&nbsp;
                                <span class='new-author'>
                                    <span class='glyphicon glyphicon-user'></span>
                                    <span class='sr-only'>&nbsp;:&nbsp;</span>
                                    
                                    <a href='/authors/jyjsjd/'>景阳</a>
                                </span>
                            </div>
                        </div>
                        <div class='list-group-item list-group-item-default'>
                            <h5 class='new-heading'>
                                <a href='/blog/2016/12/22/mysql-introduce.html' title='mysql入门及在nodejs下的简单应用'>mysql入门及在nodejs下的简单应用</a>
                            </h5>
                            <span class='desc'>MySQL是一个关系型数据库管理系统，由瑞典MySQL AB 公司开发，目...</span>
                            <div class='new-post-info'>
                                <span class='new-date'>
                                    <span class='glyphicon glyphicon-calendar'></span>
                                    <span class='sr-only'>&nbsp;:&nbsp;</span>
                                    2016-12-22
                                </span>&nbsp;&nbsp;
                                <span class='new-author'>
                                    <span class='glyphicon glyphicon-user'></span>
                                    <span class='sr-only'>&nbsp;:&nbsp;</span>
                                    
                                    <a href='/authors/huqinghai/'>胡青海</a>
                                </span>
                            </div>
                        </div>
                        <div class='list-group-item list-group-item-default'>
                            <h5 class='new-heading'>
                                <a href='/blog/2016/12/19/pm2.html' title='PM2-NodeJs生产系统进程管理器'>PM2-NodeJs生产系统进程管理器</a>
                            </h5>
                            <span class='desc'>PM2是具有内置负载平衡器的Node.js应用程序的生产流程管理器。 它可...</span>
                            <div class='new-post-info'>
                                <span class='new-date'>
                                    <span class='glyphicon glyphicon-calendar'></span>
                                    <span class='sr-only'>&nbsp;:&nbsp;</span>
                                    2016-12-19
                                </span>&nbsp;&nbsp;
                                <span class='new-author'>
                                    <span class='glyphicon glyphicon-user'></span>
                                    <span class='sr-only'>&nbsp;:&nbsp;</span>
                                    
                                    <a href='/authors/tangshizhong/'>汤仕忠</a>
                                </span>
                            </div>
                        </div>
                        <div class='list-group-item list-group-item-default'>
                            <h5 class='new-heading'>
                                <a href='/blog/2016/12/18/mocha-introduction.html' title='测试框架 Mocha入门'>测试框架 Mocha入门</a>
                            </h5>
                            <span class='desc'>Mocha（发音"摩卡"）诞生于2011年，是现在最流行的JavaScri...</span>
                            <div class='new-post-info'>
                                <span class='new-date'>
                                    <span class='glyphicon glyphicon-calendar'></span>
                                    <span class='sr-only'>&nbsp;:&nbsp;</span>
                                    2016-12-18
                                </span>&nbsp;&nbsp;
                                <span class='new-author'>
                                    <span class='glyphicon glyphicon-user'></span>
                                    <span class='sr-only'>&nbsp;:&nbsp;</span>
                                    
                                    <a href='/authors/chenfan/'>陈凡</a>
                                </span>
                            </div>
                        </div>
                        <div class='list-group-item list-group-item-default'>
                            <h5 class='new-heading'>
                                <a href='/blog/2016/12/18/canvas-3.html' title='canvas学习[3]--文本和图片'>canvas学习[3]--文本和图片</a>
                            </h5>
                            <span class='desc'>本文将介绍canvas中对于文本和图片的处理。</span>
                            <div class='new-post-info'>
                                <span class='new-date'>
                                    <span class='glyphicon glyphicon-calendar'></span>
                                    <span class='sr-only'>&nbsp;:&nbsp;</span>
                                    2016-12-18
                                </span>&nbsp;&nbsp;
                                <span class='new-author'>
                                    <span class='glyphicon glyphicon-user'></span>
                                    <span class='sr-only'>&nbsp;:&nbsp;</span>
                                    
                                    <a href='/authors/wanghui/'>汪回</a>
                                </span>
                            </div>
                        </div>
                    </div>
                </div><!--end of newestbar-->
            </div>
        </div>
    </div>

    <script src="http://s13.cnzz.com/stat.php?id=5229914&web_id=5229914" language="JavaScript"></script>
</body>
</html>	
