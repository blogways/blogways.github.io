I"<p>原文：<a href="http://expressjs.com/en/guide/behind-proxies.html">http://expressjs.com/en/guide/behind-proxies.html</a></p>

<p>当在代理服务器之后运行 <code class="language-plaintext highlighter-rouge">Express</code> 时，请将应用变量 <code class="language-plaintext highlighter-rouge">trust proxy</code> 设置（使用 <code class="language-plaintext highlighter-rouge">app.set()</code>）为下述序列中的一项。</p>
<blockquote>
  <p>如果没有设置应用变量 <code class="language-plaintext highlighter-rouge">trust proxy</code>，应用将不会运行，除非 <code class="language-plaintext highlighter-rouge">trust proxy</code> 设置正确，否则应用会误将代理服务器的 <code class="language-plaintext highlighter-rouge">IP</code> 地址注册为客户端 <code class="language-plaintext highlighter-rouge">IP</code> 地址.</p>
</blockquote>

<h2 id="1boolean">1、Boolean</h2>
<p>如果为 <code class="language-plaintext highlighter-rouge">true</code>，客户端 <code class="language-plaintext highlighter-rouge">IP</code> 地址为 <code class="language-plaintext highlighter-rouge">X-Forwarded-*</code> 头最左边的项。<br />
如果为 <code class="language-plaintext highlighter-rouge">false</code>, 应用直接面向互联网，客户端 <code class="language-plaintext highlighter-rouge">IP</code> 地址从 <code class="language-plaintext highlighter-rouge">req.connection.remoteAddress</code> 得来，这是默认的设置。</p>

<h2 id="2ip-地址">2、IP 地址</h2>
<p>IP 地址、子网或 <code class="language-plaintext highlighter-rouge">IP</code> 地址数组和可信的子网。下面是预配置的子网列表。</p>
<blockquote>
  <ul>
    <li>loopback - 127.0.0.1/8, ::1/128</li>
    <li>linklocal - 169.254.0.0/16, fe80::/10</li>
    <li>uniquelocal - 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, fc00::/7</li>
  </ul>
</blockquote>

<p>使用如下方式设置 <code class="language-plaintext highlighter-rouge">IP</code> 地址：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.set('trust proxy', 'loopback') // 指定唯一子网
app.set('trust proxy', 'loopback, 123.123.123.123') // 指定子网和 IP 地址
app.set('trust proxy', 'loopback, linklocal, uniquelocal') // 指定多个子网
app.set('trust proxy', ['loopback', 'linklocal', 'uniquelocal']) // 使用数组指定多个子网 当指定地址时，`IP` 地址或子网从地址确定过程中被除去，离应用服务器最近的非受信 `IP` 地址被当作客户端 `IP` 地址。  
</code></pre></div></div>

<h2 id="3number">3、Number</h2>
<p>将代理服务器前第 n 跳当作客户端。</p>

<h2 id="4function">4、Function</h2>
<p>定制实现，只有在您知道自己在干什么时才能这样做。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.set('trust proxy', function (ip) {
  if (ip === '127.0.0.1' || ip === '123.123.123.123') return true; // 受信的 IP 地址
  else return false;
}) 以上就是 `trust proxy` 设置项  
</code></pre></div></div>

<p>设置 <code class="language-plaintext highlighter-rouge">trust proxy</code> 为非假值会带来三个重要变化：</p>
<blockquote>
  <ul>
    <li>反向代理可能设置 <code class="language-plaintext highlighter-rouge">X-Forwarded-Proto</code> 来告诉应用使用 <code class="language-plaintext highlighter-rouge">https</code> 或简单的 <code class="language-plaintext highlighter-rouge">http</code> 协议。请参考 <code class="language-plaintext highlighter-rouge">req.protocol</code>。</li>
    <li>无论是 <code class="language-plaintext highlighter-rouge">HTTP</code>、<code class="language-plaintext highlighter-rouge">HTTPS</code> 或者是无效的名称，都可以通过反向代理来设置 <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code> 通知应用程序。这个值是通过 <code class="language-plaintext highlighter-rouge">req.protocol</code> 来反应的。</li>
    <li><code class="language-plaintext highlighter-rouge">req.ip</code> 和 <code class="language-plaintext highlighter-rouge">req.ips</code> 的值将会由 <code class="language-plaintext highlighter-rouge">X-Forwarded-For</code> 中列出的 IP 地址构成。</li>
  </ul>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">trust proxy</code> 设置由 <code class="language-plaintext highlighter-rouge">proxy-addr</code> 软件包实现，请参考其文档了解更多信息。</p>
:ET