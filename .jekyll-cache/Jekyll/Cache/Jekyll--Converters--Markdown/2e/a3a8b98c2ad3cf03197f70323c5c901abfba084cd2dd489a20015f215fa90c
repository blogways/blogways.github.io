I"„'<p>åŸæ–‡ <a href="http://expressjs.com/guide/using-middleware.html">http://expressjs.com/guide/using-middleware.html</a></p>
<h1 id="ä½¿ç”¨ä¸­é—´ä»¶">ä½¿ç”¨ä¸­é—´ä»¶</h1>

<p>Express æ˜¯ä¸€ä¸ªè‡ªèº«åŠŸèƒ½æç®€ï¼Œå®Œå…¨æ˜¯ç”±è·¯ç”±å’Œä¸­é—´ä»¶æ„æˆä¸€ä¸ªçš„ web å¼€å‘æ¡†æ¶ï¼šä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œä¸€ä¸ª Express åº”ç”¨å°±æ˜¯åœ¨è°ƒç”¨å„ç§ä¸­é—´ä»¶ã€‚</p>

<p>ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰ æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå¯ä»¥è®¿é—®è¯·æ±‚å¯¹è±¡ï¼ˆrequest object (req)ï¼‰, å“åº”å¯¹è±¡ï¼ˆresponse object (res)ï¼‰, å’Œ web åº”ç”¨ä¸­å¤„äºè¯·æ±‚-å“åº”å¾ªç¯æµç¨‹ä¸­çš„ä¸­é—´ä»¶ï¼Œä¸€èˆ¬è¢«å‘½åä¸º next çš„å˜é‡ã€‚</p>

<p>ä¸­é—´ä»¶çš„åŠŸèƒ½åŒ…æ‹¬ï¼š</p>

<p>Â·æ‰§è¡Œä»»ä½•ä»£ç ã€‚</p>

<p>Â·ä¿®æ”¹è¯·æ±‚å’Œå“åº”å¯¹è±¡ã€‚</p>

<p>Â·ç»ˆç»“è¯·æ±‚-å“åº”å¾ªç¯ã€‚</p>

<p>Â·è°ƒç”¨å †æ ˆä¸­çš„ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚</p>

<p>å¦‚æœå½“å‰ä¸­é—´ä»¶æ²¡æœ‰ç»ˆç»“è¯·æ±‚-å“åº”å¾ªç¯ï¼Œåˆ™å¿…é¡»è°ƒç”¨ next() æ–¹æ³•å°†æ§åˆ¶æƒäº¤ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¦åˆ™      è¯·æ±‚å°±ä¼šæŒ‚èµ·ã€‚</p>

<p>Express åº”ç”¨å¯ä½¿ç”¨å¦‚ä¸‹å‡ ç§ä¸­é—´ä»¶ï¼š</p>

<p>Â·åº”ç”¨çº§ä¸­é—´ä»¶</p>

<p>Â·è·¯ç”±çº§ä¸­é—´ä»¶</p>

<p>Â·é”™è¯¯å¤„ç†ä¸­é—´ä»¶</p>

<p>Â·å†…ç½®ä¸­é—´ä»¶</p>

<p>Â·ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶</p>

<p>ä½¿ç”¨å¯é€‰åˆ™æŒ‚è½½è·¯å¾„ï¼Œå¯åœ¨åº”ç”¨çº§åˆ«æˆ–è·¯ç”±çº§åˆ«è£…è½½ä¸­é—´ä»¶ã€‚å¦å¤–ï¼Œä½ è¿˜å¯ä»¥åŒæ—¶è£…åœ¨ä¸€ç³»åˆ—ä¸­é—´ä»¶å‡½æ•°ï¼Œä»è€Œåœ¨ä¸€ä¸ªæŒ‚è½½ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªå­ä¸­é—´ä»¶æ ˆã€‚</p>

<h1 id="åº”ç”¨çº§ä¸­é—´ä»¶">åº”ç”¨çº§ä¸­é—´ä»¶</h1>
<p>åº”ç”¨çº§ä¸­é—´ä»¶ç»‘å®šåˆ° app å¯¹è±¡ ä½¿ç”¨ app.use() å’Œ app.METHOD()ï¼Œ å…¶ä¸­ï¼Œ METHOD æ˜¯éœ€è¦å¤„ç†çš„ HTTP è¯·æ±‚çš„æ–¹æ³•ï¼Œä¾‹å¦‚ GET, PUT, POST ç­‰ç­‰ï¼Œå…¨éƒ¨å°å†™ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var app = express();

// æ²¡æœ‰æŒ‚è½½è·¯å¾„çš„ä¸­é—´ä»¶ï¼Œåº”ç”¨çš„æ¯ä¸ªè¯·æ±‚éƒ½ä¼šæ‰§è¡Œè¯¥ä¸­é—´ä»¶
app.use(function (req, res, next) {
  console.log('Time:', Date.now());
  next();
});

// æŒ‚è½½è‡³ /user/:id çš„ä¸­é—´ä»¶ï¼Œä»»ä½•æŒ‡å‘ /user/:id çš„è¯·æ±‚éƒ½ä¼šæ‰§è¡Œå®ƒ
app.use('/user/:id', function (req, res, next) {
  console.log('Request Type:', req.method);
  next();
});

// è·¯ç”±å’Œå¥æŸ„å‡½æ•°(ä¸­é—´ä»¶ç³»ç»Ÿ)ï¼Œå¤„ç†æŒ‡å‘ /user/:id çš„ GET è¯·æ±‚
app.get('/user/:id', function (req, res, next) {
  res.send('USER');
}); ä¸‹é¢è¿™ä¸ªä¾‹å­å±•ç¤ºäº†åœ¨ä¸€ä¸ªæŒ‚è½½ç‚¹è£…è½½ä¸€ç»„ä¸­é—´ä»¶ã€‚

// ä¸€ä¸ªä¸­é—´ä»¶æ ˆï¼Œå¯¹ä»»ä½•æŒ‡å‘ /user/:id çš„ HTTP è¯·æ±‚æ‰“å°å‡ºç›¸å…³ä¿¡æ¯
app.use('/user/:id', function(req, res, next) {
  console.log('Request URL:', req.originalUrl);
  next();
}, function (req, res, next) {
  console.log('Request Type:', req.method);
  next();
}); ä½œä¸ºä¸­é—´ä»¶ç³»ç»Ÿçš„è·¯ç”±å¥æŸ„ï¼Œä½¿å¾—ä¸ºè·¯å¾„å®šä¹‰å¤šä¸ªè·¯ç”±æˆä¸ºå¯èƒ½ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œä¸ºæŒ‡å‘ /user/:id çš„ GET è¯·æ±‚å®šä¹‰äº†ä¸¤ä¸ªè·¯ç”±ã€‚ç¬¬äºŒä¸ªè·¯ç”±è™½ç„¶ä¸ä¼šå¸¦æ¥ä»»ä½•é—®é¢˜ï¼Œä½†å´æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªè·¯ç”±å·²ç»ç»ˆæ­¢äº†è¯·æ±‚-å“åº”å¾ªç¯ã€‚

// ä¸€ä¸ªä¸­é—´ä»¶æ ˆï¼Œå¤„ç†æŒ‡å‘ /user/:id çš„ GET è¯·æ±‚
app.get('/user/:id', function (req, res, next) {
  console.log('ID:', req.params.id);
  next();
}, function (req, res, next) {
  res.send('User Info');
});

// å¤„ç† /user/:idï¼Œ æ‰“å°å‡ºç”¨æˆ· id
app.get('/user/:id', function (req, res, next) {
  res.end(req.params.id);
}); å¦‚æœéœ€è¦åœ¨ä¸­é—´ä»¶æ ˆä¸­è·³è¿‡å‰©ä½™ä¸­é—´ä»¶ï¼Œè°ƒç”¨ next('route') æ–¹æ³•å°†æ§åˆ¶æƒäº¤ç»™ä¸‹ä¸€ä¸ªè·¯ç”±ã€‚ æ³¨æ„ï¼š next('route') åªå¯¹ä½¿ç”¨ app.VERB() æˆ– router.VERB() åŠ è½½çš„ä¸­é—´ä»¶æœ‰æ•ˆã€‚

// ä¸€ä¸ªä¸­é—´ä»¶æ ˆï¼Œå¤„ç†æŒ‡å‘ /user/:id çš„ GET è¯·æ±‚
app.get('/user/:id', function (req, res, next) {
  // å¦‚æœ user id ä¸º 0, è·³åˆ°ä¸‹ä¸€ä¸ªè·¯ç”±
  if (req.params.id == 0) next('route');
  // å¦åˆ™å°†æ§åˆ¶æƒäº¤ç»™æ ˆä¸­ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
  else next(); //
}, function (req, res, next) {
  // æ¸²æŸ“å¸¸è§„é¡µé¢
  res.render('regular');
});

// å¤„ç† /user/:idï¼Œ æ¸²æŸ“ä¸€ä¸ªç‰¹æ®Šé¡µé¢
app.get('/user/:id', function (req, res, next) {
  res.render('special');
}); # è·¯ç”±çº§ä¸­é—´ä»¶ è·¯ç”±çº§ä¸­é—´ä»¶å’Œåº”ç”¨çº§ä¸­é—´ä»¶ä¸€æ ·ï¼Œåªæ˜¯å®ƒç»‘å®šçš„å¯¹è±¡ä¸º  express.Router()ã€‚

var router = express.Router(); è·¯ç”±çº§ä½¿ç”¨ router.use() æˆ– router.VERB() åŠ è½½ã€‚
</code></pre></div></div>

<p>ä¸Šè¿°åœ¨åº”ç”¨çº§åˆ›å»ºçš„ä¸­é—´ä»¶ç³»ç»Ÿï¼Œå¯é€šè¿‡å¦‚ä¸‹ä»£ç æ”¹å†™ä¸ºè·¯ç”±çº§ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var app = express();
var router = express.Router();

// æ²¡æœ‰æŒ‚è½½è·¯å¾„çš„ä¸­é—´ä»¶ï¼Œé€šè¿‡è¯¥è·¯ç”±çš„æ¯ä¸ªè¯·æ±‚éƒ½ä¼šæ‰§è¡Œè¯¥ä¸­é—´ä»¶
router.use(function (req, res, next) {
  console.log('Time:', Date.now());
  next();
});

// ä¸€ä¸ªä¸­é—´ä»¶æ ˆï¼Œæ˜¾ç¤ºä»»ä½•æŒ‡å‘ /user/:id çš„ HTTP è¯·æ±‚çš„ä¿¡æ¯
router.use('/user/:id', function(req, res, next) {
  console.log('Request URL:', req.originalUrl);
  next();
}, function (req, res, next) {
  console.log('Request Type:', req.method);
  next();
});

// ä¸€ä¸ªä¸­é—´ä»¶æ ˆï¼Œå¤„ç†æŒ‡å‘ /user/:id çš„ GET è¯·æ±‚
router.get('/user/:id', function (req, res, next) {
  // å¦‚æœ user id ä¸º 0, è·³åˆ°ä¸‹ä¸€ä¸ªè·¯ç”±
  if (req.params.id == 0) next('route');
  // è´Ÿè´£å°†æ§åˆ¶æƒäº¤ç»™æ ˆä¸­ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
  else next(); //
}, function (req, res, next) {
  // æ¸²æŸ“å¸¸è§„é¡µé¢
  res.render('regular');
});

// å¤„ç† /user/:idï¼Œ æ¸²æŸ“ä¸€ä¸ªç‰¹æ®Šé¡µé¢
router.get('/user/:id', function (req, res, next) {
  console.log(req.params.id);
  res.render('special');
});

// å°†è·¯ç”±æŒ‚è½½è‡³åº”ç”¨
app.use('/', router); # é”™è¯¯å¤„ç†ä¸­é—´ä»¶
</code></pre></div></div>

<blockquote>
  <p>é”™è¯¯å¤„ç†ä¸­é—´ä»¶æœ‰ 4 ä¸ªå‚æ•°ï¼Œå®šä¹‰é”™è¯¯å¤„ç†ä¸­é—´ä»¶æ—¶å¿…é¡»ä½¿ç”¨è¿™ 4 ä¸ªå‚æ•°ã€‚å³ä½¿ä¸éœ€è¦ next å¯¹è±¡ï¼Œä¹Ÿå¿…é¡»åœ¨ç­¾åä¸­å£°æ˜å®ƒï¼Œå¦åˆ™ä¸­é—´ä»¶ä¼šè¢«è¯†åˆ«ä¸ºä¸€ä¸ªå¸¸è§„ä¸­é—´ä»¶ï¼Œä¸èƒ½å¤„ç†é”™è¯¯ã€‚</p>
</blockquote>

<p>é”™è¯¯å¤„ç†ä¸­é—´ä»¶å’Œå…¶ä»–ä¸­é—´ä»¶å®šä¹‰ç±»ä¼¼ï¼Œåªæ˜¯è¦ä½¿ç”¨ 4 ä¸ªå‚æ•°ï¼Œè€Œä¸æ˜¯ 3 ä¸ªï¼Œå…¶ç­¾åå¦‚ä¸‹ï¼š (err, req, res, next)ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(function(err, req, res, next) {
  console.error(err.stack);
  res.status(500).send('Something broke!');
}); è¯·å‚è€ƒ é”™è¯¯å¤„ç† ä¸€ç« äº†è§£æ›´å¤šå…³äºé”™è¯¯å¤„ç†ä¸­é—´ä»¶çš„å†…å®¹ã€‚
</code></pre></div></div>

<h1 id="å†…ç½®ä¸­é—´ä»¶">å†…ç½®ä¸­é—´ä»¶</h1>
<p>ä» 4.x ç‰ˆæœ¬å¼€å§‹ï¼Œ, Express å·²ç»ä¸å†ä¾èµ– Connect äº†ã€‚é™¤äº† express.static, Express ä»¥å‰å†…ç½®çš„ä¸­é—´ä»¶ç°åœ¨å·²ç»å…¨éƒ¨å•ç‹¬ä½œä¸ºæ¨¡å—å®‰è£…ä½¿ç”¨äº†ã€‚è¯·å‚è€ƒ ä¸­é—´ä»¶åˆ—è¡¨ã€‚</p>

<h4 id="expressstaticroot-options">express.static(root, [options])</h4>

<p>express.static æ˜¯ Express å”¯ä¸€å†…ç½®çš„ä¸­é—´ä»¶ã€‚å®ƒåŸºäº serve-staticï¼Œè´Ÿè´£åœ¨ Express åº”ç”¨ä¸­ææ‰˜ç®¡é™æ€èµ„æºã€‚</p>

<p>å‚æ•° root æŒ‡æä¾›é™æ€èµ„æºçš„æ ¹ç›®å½•ã€‚</p>

<p>å¯é€‰çš„ options å‚æ•°æ‹¥æœ‰å¦‚ä¸‹å±æ€§ã€‚</p>

<table>
  <thead>
    <tr>
      <th>å±æ€§</th>
      <th>æè¿°</th>
      <th>ç±»å‹</th>
      <th>ç¼ºçœå€¼</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>dotfiles</code></td>
      <td>æ˜¯å¦å¯¹å¤–è¾“å‡ºæ–‡ä»¶åä»¥ç‚¹ï¼ˆ<code>.</code>ï¼‰å¼€å¤´çš„æ–‡ä»¶ã€‚å¯é€‰å€¼ä¸º â€œallowâ€ã€â€œdenyâ€ å’Œ â€œignoreâ€</td>
      <td>String</td>
      <td>â€œignoreâ€</td>
    </tr>
    <tr>
      <td><code>etag</code></td>
      <td>æ˜¯å¦å¯ç”¨ etag ç”Ÿæˆ</td>
      <td>Boolean</td>
      <td>true</td>
    </tr>
    <tr>
      <td><code>extensions</code></td>
      <td>è®¾ç½®æ–‡ä»¶æ‰©å±•åå¤‡ä»½é€‰é¡¹</td>
      <td>Array</td>
      <td>[]</td>
    </tr>
    <tr>
      <td><code>index</code></td>
      <td>å‘é€ç›®å½•ç´¢å¼•æ–‡ä»¶ï¼Œè®¾ç½®ä¸º false ç¦ç”¨ç›®å½•ç´¢å¼•ã€‚</td>
      <td>Mixed</td>
      <td>â€œindex.htmlâ€</td>
    </tr>
    <tr>
      <td><code>lastModified</code></td>
      <td>è®¾ç½® Last-Modified å¤´ä¸ºæ–‡ä»¶åœ¨æ“ä½œç³»ç»Ÿä¸Šçš„æœ€åä¿®æ”¹æ—¥æœŸã€‚å¯èƒ½å€¼ä¸º true æˆ– falseã€‚</td>
      <td>Boolean</td>
      <td>true</td>
    </tr>
    <tr>
      <td><code>maxAge</code></td>
      <td>ä»¥æ¯«ç§’æˆ–è€…å…¶å­—ç¬¦ä¸²æ ¼å¼&lt;/a&gt;è®¾ç½® Cache-Control å¤´çš„ max-age å±æ€§ã€‚</td>
      <td>Number</td>
      <td>0</td>
    </tr>
    <tr>
      <td><code>redirect</code></td>
      <td>å½“è·¯å¾„ä¸ºç›®å½•æ—¶ï¼Œé‡å®šå‘è‡³ â€œ/â€ã€‚</td>
      <td>Boolean</td>
      <td>true</td>
    </tr>
    <tr>
      <td><code>setHeaders</code></td>
      <td>è®¾ç½® HTTP å¤´ä»¥æä¾›æ–‡ä»¶çš„å‡½æ•°ã€‚</td>
      <td>Function</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>ä¸‹é¢çš„ä¾‹å­ä½¿ç”¨äº† express.static ä¸­é—´ä»¶ï¼Œå…¶ä¸­çš„ options å¯¹è±¡ç»è¿‡äº†ç²¾å¿ƒçš„è®¾è®¡ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var options = {
  dotfiles: 'ignore',
  etag: false,
  extensions: ['htm', 'html'],
  index: false,
  maxAge: '1d',
  redirect: false,
  setHeaders: function (res, path, stat) {
    res.set('x-timestamp', Date.now());
  }
}

app.use(express.static('public', options)); æ¯ä¸ªåº”ç”¨å¯æœ‰å¤šä¸ªé™æ€ç›®å½•ã€‚

app.use(express.static('public'));
app.use(express.static('uploads'));
app.use(express.static('files')); æ›´å¤šå…³äº serve-static å’Œå…¶å‚æ•°çš„ä¿¡æ¯ï¼Œè¯·å‚è€ƒ serve-static æ–‡æ¡£ã€‚
</code></pre></div></div>

<p>ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶
é€šè¿‡ä½¿ç”¨ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶ä»è€Œä¸º Express åº”ç”¨å¢åŠ æ›´å¤šåŠŸèƒ½ã€‚</p>

<p>å®‰è£…æ‰€éœ€åŠŸèƒ½çš„ node æ¨¡å—ï¼Œå¹¶åœ¨åº”ç”¨ä¸­åŠ è½½ï¼Œå¯ä»¥åœ¨åº”ç”¨çº§åŠ è½½ï¼Œä¹Ÿå¯ä»¥åœ¨è·¯ç”±çº§åŠ è½½ã€‚</p>

<p>ä¸‹é¢çš„ä¾‹å­å®‰è£…å¹¶åŠ è½½äº†ä¸€ä¸ªè§£æ cookie çš„ä¸­é—´ä»¶ï¼š cookie-parser</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ npm install cookie-parser
</code></pre></div></div>

<p>Â·Â·Â·Â·</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var express = require('express');
var app = express();
var cookieParser = require('cookie-parser');

// åŠ è½½ç”¨äºè§£æ cookie çš„ä¸­é—´ä»¶
app.use(cookieParser()); è¯·å‚è€ƒ ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶ è·å– Express ä¸­ç»å¸¸ç”¨åˆ°çš„ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶åˆ—è¡¨ã€‚
</code></pre></div></div>
:ET