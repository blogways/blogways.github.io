I"˜<h1 id="jstorm">JStorm</h1>

<h2 id="11åŸºæœ¬æ¦‚å¿µ">1.1åŸºæœ¬æ¦‚å¿µ</h2>

<p><img src="/images/wangtianwen/JStorm/topology.png" alt="" /></p>

<p><strong>Topologyï¼ˆæ‹“æ‰‘ï¼‰</strong>ï¼šé€šè¿‡Stream Groupingså°†Spoutså’ŒBoltsè¿æ¥èµ·æ¥æ„æˆä¸€ä¸ªTopologyï¼Œæ˜¯Stormä¸­å®æ—¶åº”ç”¨çš„ä¸€ç§å°è£…ã€‚ä¸€ä¸ªTopologyä¼šä¸€ç›´æ‰§è¡Œï¼Œæ— æ•°æ®æµç­‰å¾…ï¼Œæœ‰æ•°æ®æµæ‰§è¡Œï¼ŒçŸ¥é“è¢«kill progressã€‚</p>

<p><strong>Streamsï¼ˆæµï¼‰</strong>ï¼šæ¶ˆæ¯æµStreamæ˜¯Stormé‡Œçš„å…³é”®æŠ½è±¡ï¼Œä¸€ä¸ªæ¶ˆæ¯æµæ˜¯ä¸€ä¸ªæ²¡æœ‰è¾¹ç•Œçš„tupleåºåˆ—ï¼Œè€Œè¿™äº›tupleåºåˆ—ä¼šä»¥ä¸€ç§åˆ†å¸ƒå¼çš„æ–¹å¼å¹¶è¡Œåœ°åˆ›å»ºå’Œå¤„ç†ã€‚</p>

<p><strong>Spoutï¼ˆæ•°æ®æºï¼‰</strong>ï¼šæ¯ä¸€ä¸ªSpoutéƒ½æ˜¯ä¸€ä¸ªæ•°æ®æºï¼Œé€šå¸¸æƒ…å†µSpoutä¼šä»å¤–éƒ¨æºè¯»å–tupleï¼Œå¹¶è¾“å…¥åˆ°Topologyä¸­ã€‚Spoutå¯ä»¥æ˜¯å¯é çš„ä¹Ÿå¯ä»¥æ˜¯ä¸å¯é çš„ï¼Œå¦‚æœè¿™ä¸ªtupleæ²¡æœ‰è¢«StormæˆåŠŸå¤„ç†ï¼Œå¯é çš„æ¶ˆæ¯æºå¯ä»¥é‡æ–°å‘å°„ï¼Œä½†æ˜¯ä¸å¯é çš„ä¸€æ—¦å‘å‡ºä¸€ä¸ªtupleå°±ä¸èƒ½é‡å‘äº†ã€‚</p>

<p><strong>Boltï¼ˆæ•°æ®å¤„ç†ç»„ä»¶ï¼‰</strong>ï¼šæ‰€æœ‰çš„å¤„ç†éƒ½ä¼šåœ¨Boltä¸­è¢«æ‰§è¡Œï¼Œå¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼šè¿‡æ»¤ã€èšåˆã€æŸ¥è¯¢æ•°æ®åº“ç­‰ã€‚Boltæœ€ä¸»è¦çš„æ–¹æ³•æ˜¯executeï¼Œå®ƒä»¥ä¸€ä¸ªtupleä½œä¸ºè¾“å…¥ï¼Œä½¿ç”¨OutputCollectoræ¥å‘å°„tupleã€‚</p>

<p><strong>Stream groupingsï¼ˆæ•°æ®æµåˆ†ç»„ï¼‰</strong>ï¼šå®šä¹‰ä¸€ä¸ªTopologyçš„æ¯ä¸ªBoltæ¥å—ä»€ä¹ˆæ ·çš„æµä½œä¸ºè¾“å…¥ã€‚Stream Groupingå°±æ˜¯ç”¨æ¥å®šä¹‰ä¸€ä¸ªStreamåº”è¯¥å¦‚ä½•åˆ†é…æ•°æ®ç»™Boltä¸Šçš„å¤šä¸ªtaskã€‚Stromé‡Œæœ‰7ä¸­ç±»å‹çš„Stream Groupingã€‚</p>

<ul>
  <li>Shuffle Groupingï¼šéšæœºåˆ†ç»„ï¼Œéšæœºæ´¾å‘Streamé‡Œé¢çš„tupleï¼Œä¿è¯æ¯ä¸ªBoltæ¥æ”¶åˆ°çš„tupleæ•°ç›®å¤§è‡´ç›¸åŒã€‚</li>
  <li>Fields Groupingï¼šæŒ‰å­—æ®µåˆ†ç»„ï¼Œæ¯”å¦‚æŒ‰useridåˆ†ç»„ï¼Œç›¸åŒuseridçš„tupleä¼šè¢«åˆ†åˆ°åŒä¸€ä¸ªBoltçš„åŒä¸€ä¸ªtaskä¸­ã€‚</li>
  <li>All Groupingï¼šå¹¿æ’­å‘é€ï¼Œå¯¹äºæ¯ä¸€ä¸ªtupleï¼Œæ‰€æœ‰çš„Boltéƒ½ä¼šæ”¶åˆ°ã€‚</li>
  <li>Global Groupingï¼šå…¨å±€åˆ†ç»„ï¼Œè¿™ä¸ªtupleè¢«åˆ†é…åˆ°Stormä¸­çš„ä¸€ä¸ªBoltçš„å…¶ä¸­ä¸€ä¸ªtaskï¼Œå†å…·ä½“ä¸€ç‚¹å°±æ˜¯åˆ†é…ç»™idæœ€ä½çš„é‚£ä¸ªã€‚</li>
  <li>Non Groupingï¼šä¸åˆ†ç»„ï¼Œæ„æ€æ˜¯è¯´Streamä¸å…³å¿ƒåˆ°åº•è°ä¼šæ”¶åˆ°ä»–çš„tupleã€‚ç›®å‰è¿™ç§åˆ†ç»„å’ŒShuffle Groupingæ˜¯ä¸€æ ·çš„æ•ˆæœï¼Œæœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯Stormä¼šæŠŠè¿™ä¸ªBoltæ”¾åˆ°è¿™ä¸ªBoltçš„è®¢é˜…è€…çš„åŒä¸€ä¸ªçº¿ç¨‹é‡Œé¢å»æ‰§è¡Œã€‚</li>
  <li>Direct Groupingï¼šç›´æ¥åˆ†ç»„ï¼Œè¿™æ˜¯ä¸€ç§æ¯”è¾ƒç‰¹åˆ«çš„åˆ†ç»„æ–¹æ³•ï¼Œç”¨è¿™ç§åˆ†ç»„æ„å‘³ç€æ¶ˆæ¯çš„å‘é€è€…éœ€è¦æŒ‡å®šç”±æ¶ˆæ¯æ¥æ”¶è€…çš„å“ªä¸ªtaskå¤„ç†è¿™ä¸ªæ¶ˆæ¯ã€‚åªæœ‰è¢«å£°æ˜ä¸ºDirect Streamçš„æ¶ˆæ¯æµå¯ä»¥å£°æ˜è¿™ç§åˆ†ç»„æ–¹æ³•ï¼Œè€Œä¸”è¿™ç§æ¶ˆæ¯çš„tupleå¿…é¡»ä½¿ç”¨emitDirectæ–¹æ³•å‘å°„ã€‚æ¶ˆæ¯å¤„ç†è¿™å¯ä»¥é€šè¿‡TopologyContextè·å–å¤„ç†å®ƒçš„æ¶ˆæ¯çš„taskçš„idã€‚</li>
  <li>Local or Shuffle Groupingï¼šå¦‚æœç›®æ ‡Boltä¸­æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªtaskåœ¨åŒä¸€ä¸ªå·¥ä½œè¿›ç¨‹ä¸­ï¼Œtupleå°†ä¼šè¢«éšæœºåˆ†é…ç»™è¿™äº›taskã€‚å¦åˆ™å’Œæ™®é€šçš„Shuffle Groupingè¡Œä¸ºä¸€ç›´ã€‚</li>
</ul>

<p><strong>Taskï¼ˆä»»åŠ¡ï¼‰</strong>ï¼šæ¯ä¸€ä¸ªSpoutå’ŒBoltéƒ½ä¼šè¢«å½“ä½œå¾ˆå¤štaskåœ¨æ•´ä¸ªé›†ç¾¤é‡Œæ‰§è¡Œã€‚æ¯ä¸€ä¸ªexecutorå¯¹åº”åˆ°ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œå¤šä¸ªtaskã€‚Stream Groupingæ˜¯å®šä¹‰æ€ä¹ˆä»ä¸€å †taskå‘å°„tupleåˆ°å¦ä¸€å †taskï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨TopologyBuilderç±»çš„setSpoutå’ŒsetBoltæ¥è®¾ç½®å¹¶è¡Œåº¦ï¼Œä¹Ÿå°±æ˜¯å¤šå°‘ä¸ªtaskã€‚</p>

<ul>
  <li>
    <p>å¹¶è¡Œåº¦ï¼š</p>

    <p><img src="/images/wangtianwen/JStorm/å¹¶è¡Œåº¦.png" alt="å¹¶è¡Œåº¦" /></p>

    <p>â€‹</p>
  </li>
</ul>

<p><strong>Workerï¼ˆå·¥ä½œè¿›ç¨‹ï¼‰</strong>ï¼šä¸€ä¸ªTopologyå¯èƒ½ä¼šåœ¨ä¸€ä¸ªæˆ–å¤šä¸ªWorkeré‡Œé¢æ‰§è¡Œï¼Œæ¯ä¸ªWorkeræ˜¯ä¸€ä¸ªç‰©ç†JVMå¹¶ä¸”æ‰§è¡Œæ•´ä¸ªTopologyçš„ä¸€éƒ¨åˆ†ã€‚</p>

<h2 id="12å•è¯è®¡æ•°">1.2å•è¯è®¡æ•°</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
public class WordSpout implements IRichSpout{

    private String [] sentences = {
      "a b c",
      "c d e"
    };
    private int index = 0;
    private SpoutOutputCollector collector;

    public void open(Map map, TopologyContext topologyContext, SpoutOutputCollector spoutOutputCollector) {
        this.collector = spoutOutputCollector;
    }

    public void close() {

    }

    public void activate() {

    }

    public void deactivate() {

    }

    public void nextTuple() {
        try{
            this.collector.emit(new Values(sentences[index]));
            index++;
            if(index&gt;=sentences.length){
                index = 0;
            }
        }catch (Exception e){
           
        }
    }

    public void ack(Object o) {

    }

    public void fail(Object o) {

    }


    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) {
        outputFieldsDeclarer.declare(new Fields("sentence"));
    }

    public Map&lt;String, Object&gt; getComponentConfiguration() {
        return null;
    }
}

</code></pre></div></div>

<p>WordSpoutå‘å‡ºä¸€è¿ä¸²çš„å…ƒç»„ï¼Œåå­—ä¸ºâ€œsentenceâ€å’Œä¸€ä¸ªå­—ç¬¦ä¸²å€¼ã€‚æ¯”å¦‚ï¼š{â€sentenceâ€œ:â€a b câ€}ã€‚æˆ‘ä»¬çš„æ•°æ®æ¥æºæ˜¯ä¸€ä¸ªStringæ•°ç»„ï¼Œéå†è¿™ä¸ªæ•°ç»„ï¼Œå‘å°„å‡ºæ¯ä¸ªå…ƒç»„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
public class WordSplit implements IRichBolt{

    private OutputCollector collector;

    public void prepare(Map map, TopologyContext topologyContext, OutputCollector outputCollector) {
        this.collector = outputCollector;
    }

    public void execute(Tuple tuple) {
        try{
            String sentence = tuple.getStringByField("sentence");
            String[] words = sentence.split(" ");
            for(String word:words){
                this.collector.emit(new Values(word));
            }
        }catch (Exception e){

        }
    }

    public void cleanup() {

    }

    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) {
        outputFieldsDeclarer.declare(new Fields("word"));
    }

    public Map&lt;String, Object&gt; getComponentConfiguration() {
        return null;
    }
}

</code></pre></div></div>

<p>WordSplitè®¢é˜…WordSpoutçš„è¾“å‡ºå¯¹æ”¶åˆ°çš„æ¯ä¸ªå…ƒç»„ï¼Œè¿›è¡Œåˆ†å‰²æ“ä½œï¼Œæ¯ä¸ªå•è¯å‘å°„å‡ºä¸€ä¸ªå…ƒç»„ï¼š</p>

<p>{â€wordâ€œï¼šâ€aâ€œ}</p>

<p>{â€œwordâ€ï¼šâ€bâ€}</p>

<p>{â€œwordâ€ï¼šâ€câ€œ}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
public class WordCount implements IRichBolt{

    private HashMap&lt;String,Long&gt;counts = null;
    private OutputCollector collector;

    public void prepare(Map map, TopologyContext topologyContext, OutputCollector outputCollector) {
        this.collector = outputCollector;
        this.counts = new HashMap&lt;String, Long&gt;();
    }

    public void execute(Tuple tuple) {
        try{
            String word = tuple.getStringByField("word");
            Long count = this.counts.get(word);
            if(null == count){
                count = 0L;
            }
            count++;
            this.counts.put(word,count);
        }catch (Exception e){

        }
    }

    public void cleanup() {
        try {
            Thread.sleep(10000);
            System.out.println("=====================");
            for (Map.Entry&lt;String, Long&gt; entry : counts.entrySet()) {
                System.out.println(entry.getKey() + "=" + entry.getValue());
            }
            System.out.println("=======================");
        }catch (Exception e){
            System.out.print("cleancleancleancleancleanclean");
            return;
        }
    }

    public void declareOutputFields(OutputFieldsDeclarer outputFieldsDeclarer) {

    }

    public Map&lt;String, Object&gt; getComponentConfiguration() {
        return null;
    }
}

</code></pre></div></div>

<p>WordCountè®¢é˜…WordSplitçš„è¾“å‡ºï¼Œå¹¶å¯¹ç›¸åº”çš„å•è¯å’Œå‡ºç°çš„æ¬¡æ•°è¿›è¡Œç»Ÿè®¡ã€‚æ¯æ”¶åˆ°ä¸€ä¸ªå…ƒç»„ï¼Œå°±ä¼šæ›´æ–°æ•°é‡ï¼Œæœ€ç»ˆæ‰“å°ç»“æœã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
public class WordTopology {
    public static void main(String[]args) throws InterruptedException {
        try {
            TopologyBuilder builder = new TopologyBuilder();
            builder.setSpout("spout", new WordSpout());
            builder.setBolt("split", new WordSplit()).allGrouping("spout");
            builder.setBolt("count", new WordCount()).allGrouping("split");

            Config config = new Config();
            config.put(Config.TOPOLOGY_MAX_SPOUT_PENDING, 1);
            LocalCluster cluster = new LocalCluster();
            cluster.submitTopology("topo", config, builder.createTopology());
            Utils.sleep(1000);
            cluster.killTopology("topo");
            cluster.shutdown();
        }catch (Exception e){

        }
    }
}

</code></pre></div></div>

<h2 id="13å®šæ—¶ä»»åŠ¡">1.3å®šæ—¶ä»»åŠ¡</h2>

<p>åˆ©ç”¨ç³»ç»Ÿè‡ªå¸¦çš„å®šæ—¶tupleæ¥å®Œæˆï¼Œç›¸å½“äºç³»ç»Ÿè‡ªåŠ¨å‘ä¸€ä¸ªå¸¦æœ‰ç‰¹æ®Šæ ‡è®°çš„tupleï¼Œç„¶ååœ¨boltä¸­åˆ¤æ–­ï¼Œè‹¥ä¸ºæ­¤ç‰¹æ®Štupleï¼Œåˆ™æ‰§è¡Œå®šæ—¶å‡½æ•°ã€‚</p>

<p>ç¬¬ä¸€ç§æ–¹æ³•ï¼šå¦‚æœæ‰€æœ‰çš„boltéƒ½éœ€è¦å®šæ—¶ï¼Œå¯åœ¨topologyå…¥å£å¤„é€šè¿‡configè®¾ç½®ã€‚</p>

<p>ç¬¬äºŒç§æ–¹æ³•ï¼šå¦‚æœåªæœ‰æŸä¸€ç±»boltéœ€è¦å®šæ—¶ï¼Œå¯åœ¨è¯¥boltå†…éƒ¨é‡å†™getComponenrConfiguration æ–¹æ³•ï¼Œåœ¨é‡Œé¢è®¾ç½®å®šæ—¶é—´éš”ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TopologyTimer01</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MySpout</span> <span class="kd">extends</span> <span class="nc">BaseRichSpout</span><span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Map</span> <span class="n">conf</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">TopologyContext</span> <span class="n">context</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">SpoutOutputCollector</span> <span class="n">collector</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="o">(</span><span class="nc">Map</span> <span class="n">map</span><span class="o">,</span> <span class="nc">TopologyContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">SpoutOutputCollector</span> <span class="n">collector</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">conf</span> <span class="o">=</span> <span class="n">conf</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">collector</span> <span class="o">=</span> <span class="n">collector</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">nextTuple</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">num</span><span class="o">++;</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"spout:"</span><span class="o">+</span><span class="n">num</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">collector</span><span class="o">.</span><span class="na">emit</span><span class="o">(</span><span class="k">new</span> <span class="nc">Values</span><span class="o">(</span><span class="n">num</span><span class="o">));</span>
            <span class="nc">Utils</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">declareOutputFields</span><span class="o">(</span><span class="nc">OutputFieldsDeclarer</span> <span class="n">declarer</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">declarer</span><span class="o">.</span><span class="na">declare</span><span class="o">(</span><span class="k">new</span> <span class="nc">Fields</span><span class="o">(</span><span class="s">"num"</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyBolt</span> <span class="kd">extends</span> <span class="nc">BaseRichBolt</span><span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Map</span> <span class="n">stormConf</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">TopologyContext</span> <span class="n">context</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">OutputCollector</span> <span class="n">collector</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">(</span><span class="nc">Map</span> <span class="n">stormConf</span><span class="o">,</span> <span class="nc">TopologyContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">OutputCollector</span> <span class="n">collector</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">stormConf</span> <span class="o">=</span> <span class="n">stormConf</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">collector</span> <span class="o">=</span> <span class="n">collector</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">Tuple</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="na">getSourceComponent</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">Constants</span><span class="o">.</span><span class="na">SYSTEM_COMPONENT_ID</span><span class="o">)){</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ—¶é—´åˆ°äº†"</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                <span class="nc">Integer</span> <span class="n">num</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">getIntegerByField</span><span class="o">(</span><span class="s">"num"</span><span class="o">);</span>
                <span class="n">sum</span> <span class="o">+=</span> <span class="n">num</span><span class="o">;</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"sum="</span><span class="o">+</span><span class="n">sum</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">declareOutputFields</span><span class="o">(</span><span class="nc">OutputFieldsDeclarer</span> <span class="n">outputFieldsDeclarer</span><span class="o">)</span> <span class="o">{</span>

        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span><span class="n">args</span><span class="o">){</span>
        <span class="nc">TopologyBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TopologyBuilder</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">spout_id</span> <span class="o">=</span> <span class="nc">MySpout</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">bolt_id</span> <span class="o">=</span> <span class="nc">MyBolt</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>

        <span class="n">builder</span><span class="o">.</span><span class="na">setSpout</span><span class="o">(</span><span class="n">spout_id</span><span class="o">,</span><span class="k">new</span> <span class="nc">MySpout</span><span class="o">());</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="n">bolt_id</span><span class="o">,</span><span class="k">new</span> <span class="nc">MyBolt</span><span class="o">());</span>

        <span class="nc">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Config</span><span class="o">();</span>
        <span class="n">config</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">TOPOLOGY_TICK_TUPLE_FREQ_SECS</span><span class="o">,</span><span class="mi">10</span><span class="o">);</span><span class="c1">//æ¯éš”10ç§’ç»™topologyæ‰€æœ‰boltå‘é€ä¸€ä¸ªç³»ç»Ÿçº§åˆ«çš„tuple</span>
        <span class="nc">String</span> <span class="n">topology_name</span> <span class="o">=</span> <span class="nc">TopologyTimer01</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>

        <span class="nc">LocalCluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LocalCluster</span><span class="o">();</span>
        <span class="n">cluster</span><span class="o">.</span><span class="na">submitTopology</span><span class="o">(</span><span class="n">topology_name</span><span class="o">,</span><span class="n">config</span><span class="o">,</span><span class="n">builder</span><span class="o">.</span><span class="na">createTopology</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/images/wangtianwen/JStorm/stormå®šæ—¶ä»»åŠ¡02.png" alt="å®šæ—¶ä»»åŠ¡01ç»“æœ" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TopologyTimer02</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MySpout</span> <span class="kd">extends</span> <span class="nc">BaseRichSpout</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Map</span> <span class="n">conf</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">TopologyContext</span> <span class="n">context</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">SpoutOutputCollector</span> <span class="n">collector</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="o">(</span><span class="nc">Map</span> <span class="n">map</span><span class="o">,</span> <span class="nc">TopologyContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">SpoutOutputCollector</span> <span class="n">collector</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">conf</span> <span class="o">=</span> <span class="n">conf</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">collector</span> <span class="o">=</span> <span class="n">collector</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">nextTuple</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">num</span><span class="o">++;</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"spout:"</span><span class="o">+</span><span class="n">num</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">collector</span><span class="o">.</span><span class="na">emit</span><span class="o">(</span><span class="k">new</span> <span class="nc">Values</span><span class="o">(</span><span class="n">num</span><span class="o">));</span>
            <span class="nc">Utils</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">declareOutputFields</span><span class="o">(</span><span class="nc">OutputFieldsDeclarer</span> <span class="n">declarer</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">declarer</span><span class="o">.</span><span class="na">declare</span><span class="o">(</span><span class="k">new</span> <span class="nc">Fields</span><span class="o">(</span><span class="s">"num"</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyBolt1</span> <span class="kd">extends</span> <span class="nc">BaseRichBolt</span><span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Map</span> <span class="n">stormConfig</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">TopologyContext</span> <span class="n">context</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">OutputCollector</span> <span class="n">collector</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">(</span><span class="nc">Map</span> <span class="n">stormConfig</span><span class="o">,</span> <span class="nc">TopologyContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">OutputCollector</span> <span class="n">collector</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">stormConfig</span> <span class="o">=</span> <span class="n">stormConfig</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">collector</span> <span class="o">=</span> <span class="n">collector</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">Tuple</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="na">getSourceComponent</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">Constants</span><span class="o">.</span><span class="na">SYSTEM_COMPONENT_ID</span><span class="o">)){</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MyBolt 01 å®šæ—¶æ—¶é—´åˆ°"</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                <span class="nc">Integer</span> <span class="n">num</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">getIntegerByField</span><span class="o">(</span><span class="s">"num"</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MyBolt 01:"</span> <span class="o">+</span> <span class="n">num</span><span class="o">);</span>
                <span class="k">this</span><span class="o">.</span><span class="na">collector</span><span class="o">.</span><span class="na">emit</span><span class="o">(</span><span class="k">new</span> <span class="nc">Values</span><span class="o">(</span><span class="n">num</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">declareOutputFields</span><span class="o">(</span><span class="nc">OutputFieldsDeclarer</span> <span class="n">declarer</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">declarer</span><span class="o">.</span><span class="na">declare</span><span class="o">(</span><span class="k">new</span> <span class="nc">Fields</span><span class="o">(</span><span class="s">"num01"</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">getComponentConfiguration</span><span class="o">(){</span>
          	<span class="c1">//ç»™å½“å‰boltè®¾ç½®å®šæ—¶ä»»åŠ¡</span>
            <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span><span class="n">hashMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;();</span>
            <span class="n">hashMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">Config</span><span class="o">.</span><span class="na">TOPOLOGY_TICK_TUPLE_FREQ_SECS</span><span class="o">,</span><span class="mi">10</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">hashMap</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MyBolt2</span> <span class="kd">extends</span> <span class="nc">BaseRichBolt</span><span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Map</span> <span class="n">stormConfig</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">TopologyContext</span> <span class="n">context</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">OutputCollector</span> <span class="n">collector</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">(</span><span class="nc">Map</span> <span class="n">stormConfig</span><span class="o">,</span> <span class="nc">TopologyContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">OutputCollector</span> <span class="n">collector</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">stormConfig</span> <span class="o">=</span> <span class="n">stormConfig</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">collector</span> <span class="o">=</span> <span class="n">collector</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">Tuple</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Integer</span> <span class="n">num</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">getIntegerByField</span><span class="o">(</span><span class="s">"num01"</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MyBolt 02:"</span><span class="o">+</span><span class="n">num</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">declareOutputFields</span><span class="o">(</span><span class="nc">OutputFieldsDeclarer</span> <span class="n">declarer</span><span class="o">)</span> <span class="o">{</span>

        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span><span class="n">args</span><span class="o">){</span>
        <span class="nc">TopologyBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TopologyBuilder</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">spout_id</span> <span class="o">=</span> <span class="nc">TopologyTimer02</span><span class="o">.</span><span class="na">MySpout</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">bolt01_id</span> <span class="o">=</span> <span class="nc">TopologyTimer02</span><span class="o">.</span><span class="na">MyBolt1</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">bolt02_id</span> <span class="o">=</span> <span class="nc">TopologyTimer02</span><span class="o">.</span><span class="na">MyBolt2</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">topology_name</span> <span class="o">=</span> <span class="nc">TopologyTimer02</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>

        <span class="n">builder</span><span class="o">.</span><span class="na">setSpout</span><span class="o">(</span><span class="n">spout_id</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MySpout</span><span class="o">());</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="n">bolt01_id</span><span class="o">,</span><span class="k">new</span> <span class="nc">TopologyTimer02</span><span class="o">.</span><span class="na">MyBolt1</span><span class="o">()).</span><span class="na">shuffleGrouping</span><span class="o">(</span><span class="n">spout_id</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="n">bolt02_id</span><span class="o">,</span><span class="k">new</span> <span class="nc">TopologyTimer02</span><span class="o">.</span><span class="na">MyBolt2</span><span class="o">()).</span><span class="na">shuffleGrouping</span><span class="o">(</span><span class="n">bolt01_id</span><span class="o">);</span>
      
        <span class="nc">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Config</span><span class="o">();</span>
        <span class="nc">LocalCluster</span> <span class="n">cluster</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LocalCluster</span><span class="o">();</span>
        <span class="n">cluster</span><span class="o">.</span><span class="na">submitTopology</span><span class="o">(</span><span class="n">topology_name</span><span class="o">,</span><span class="n">config</span><span class="o">,</span><span class="n">builder</span><span class="o">.</span><span class="na">createTopology</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><img src="/images/wangtianwen/JStorm/stormå®šæ—¶ä»»åŠ¡02.png" alt="å®šæ—¶ä»»åŠ¡02ç»“æœ" /></p>

<h2 id="14ç³»ç»Ÿæ¶æ„">1.4ç³»ç»Ÿæ¶æ„</h2>

<p>JStormç³»ç»Ÿä¸­æœ‰ä¸‰ç§ä¸åŒçš„Daemonè¿›ç¨‹ï¼š</p>

<p>Nimbusï¼šJStormä¸­çš„ä¸»æ§èŠ‚ç‚¹ï¼Œè´Ÿè´£æ¥æ”¶å’ŒéªŒè¯å®¢æˆ·ç«¯æäº¤çš„Topologyï¼Œåˆ†é…ä»»åŠ¡ï¼Œå‘ZKå†™å…¥ä»»åŠ¡ç›¸å…³çš„å…ƒä¿¡æ¯ï¼Œæ­¤å¤–ï¼ŒNimbusè¿˜è´Ÿè´£é€šè¿‡ZKæ¥ç›‘æ§èŠ‚ç‚¹å’Œä»»åŠ¡å¥åº·æƒ…å†µï¼Œå½“æœ‰SupervisorèŠ‚ç‚¹å˜åŒ–æˆ–è€…Workerè¿›ç¨‹å‡ºç°é—®é¢˜æ—¶åŠæ—¶è¿›è¡Œä»»åŠ¡é‡æ–°åˆ†é…ã€‚Nimbusåˆ†é…ä»»åŠ¡çš„ç»“æœä¸æ˜¯ç›´æ¥ä¸‹å‘ç»™Supervisorï¼Œä¹Ÿæ˜¯é€šè¿‡ZKç»´æŠ¤åˆ†é…æ•°æ®è¿›è¡Œè¿‡æ¸¡ã€‚ç‰¹åˆ«åœ°ï¼ŒJStorm 0.9.0é¢†å…ˆApache Stormå®ç°äº†Nimbus HAï¼ˆHAæŒ‡çš„æ˜¯åŒæœºä¸»å¤‡æ¨¡å¼ï¼Œå¦‚æœä¸»æœºå‡ºç°å®•æœºï¼Œå¤‡ç”¨æœºä¼šé¡¶æ›¿ä¸Šæ¥ï¼Œä»è€Œä½¿æ•´ä¸ªé›†ç¾¤ç»§ç»­å·¥ä½œï¼‰ã€‚</p>

<p>Supervisorï¼šJStormä¸­çš„å·¥ä½œèŠ‚ç‚¹ï¼ŒSupervisorç±»ä¼¼äºMRçš„TTï¼Œsubscribe ZKåˆ†é…åˆ°è¯¥èŠ‚ç‚¹çš„ä»»åŠ¡æ•°æ®ï¼Œæ ¹æ®Nimbusçš„ä»»åŠ¡åˆ†é…æƒ…å†µå¯åŠ¨/åœæ­¢å·¥ä½œè¿›ç¨‹Workerã€‚Supervisoréœ€è¦å®šæœŸå‘ZKå†™å…¥æ´»è·ƒç«¯å£ä¿¡æ¯ä»¥ä¾¿NimbusåŠæ—¶ç›‘æ§ã€‚Supervisorä¸æ‰§è¡Œå…·ä½“çš„æ•°æ®å¤„ç†å·¥ä½œï¼Œæ‰€æœ‰çš„æ•°æ®å¤„ç†å·¥ä½œéƒ½äº¤ç»™Workerå®Œæˆã€‚</p>

<p>Workerï¼šJStormä¸­ä»»åŠ¡æ‰§è¡Œè€…ï¼ŒWorkerç±»ä¼¼äºMRçš„Taskï¼Œæ‰€æœ‰å®é™…çš„æ•°æ®å¤„ç†å·¥ä½œæœ€åéƒ½åœ¨Workerå†…æ‰§è¡Œå®Œæˆã€‚Workeréœ€è¦å®šæœŸå‘Supervsioræ±‡æŠ¥å¿ƒè·³ï¼Œç”±äºåœ¨åŒä¸€èŠ‚ç‚¹ï¼ŒåŒæ—¶ä¸ºä¿æŒèŠ‚ç‚¹çš„æ— çŠ¶æ€ï¼ŒWorkerå®šæœŸå°†çŠ¶æ€ä¿¡æ¯å†™å…¥æœ¬åœ°ç£ç›˜ï¼ŒSupervisoré€šè¿‡è¯»æœ¬åœ°ç£ç›˜çŠ¶æ€ä¿¡æ¯å®Œæˆå¿ƒè·³äº¤äº’è¿‡ç¨‹ã€‚Workerç»‘å®šä¸€ä¸ªç‹¬ç«‹ç«¯å£ï¼ŒWorkerå†…æ‰€æœ‰å•å…ƒå…±äº«Workerçš„é€šä¿¡èƒ½åŠ›ã€‚</p>

<p><img src="/images/wangtianwen/Jstorm/jstormé›†ç¾¤æ¡†æ¶å›¾.jpg" alt="" /></p>

:ET