I"Ä'<h2 id="1å„ç±»webæ¨é€æŠ€æœ¯ä¼˜ç¼ºç‚¹">1.å„ç±»webæ¨é€æŠ€æœ¯ä¼˜ç¼ºç‚¹</h2>

<blockquote>
  <p>ä¸æ–­åœ°è½®è¯¢ï¼ˆä¿—ç§°â€œæ‹‰â€ï¼Œpollingï¼‰æ˜¯è·å–å®æ—¶æ¶ˆæ¯çš„ä¸€ä¸ªæ‰‹æ®µ</p>
</blockquote>

<p>Ajax éš”ä¸€æ®µæ—¶é—´ï¼ˆé€šå¸¸ä½¿ç”¨ JavaScript çš„ setTimeout å‡½æ•°ï¼‰å°±å»æœåŠ¡å™¨æŸ¥è¯¢æ˜¯å¦æœ‰æ”¹å˜ï¼Œä»è€Œè¿›è¡Œå¢é‡å¼çš„æ›´æ–°ã€‚ä½†æ˜¯é—´éš”å¤šé•¿æ—¶é—´å»æŸ¥è¯¢æˆäº†é—®é¢˜ï¼Œå› ä¸ºæ€§èƒ½å’Œå³æ—¶æ€§é€ æˆäº†ä¸¥é‡çš„åæ¯”å…³ç³»ã€‚é—´éš”å¤ªçŸ­ï¼Œè¿ç»­ä¸æ–­çš„è¯·æ±‚ä¼šå†²å®æœåŠ¡å™¨ï¼Œé—´éš”å¤ªé•¿ï¼ŒæœåŠ¡å™¨ä¸Šçš„æ–°æ•°æ®å°±éœ€è¦è¶Šå¤šçš„æ—¶é—´æ‰èƒ½åˆ°è¾¾å®¢æˆ·æœºã€‚</p>

<p>ä¼˜ç‚¹ï¼šæœåŠ¡ç«¯é€»è¾‘ç®€å•ï¼›</p>

<p>ç¼ºç‚¹ï¼šå…¶ä¸­å¤§å¤šæ•°è¯·æ±‚å¯èƒ½æ˜¯æ— æ•ˆè¯·æ±‚ï¼Œåœ¨å¤§é‡ç”¨æˆ·è½®è¯¢å¾ˆé¢‘ç¹çš„æƒ…å†µä¸‹å¯¹æœåŠ¡å™¨çš„å‹åŠ›å¾ˆå¤§ï¼›</p>

<p>åº”ç”¨ï¼šå¹¶å‘ç”¨æˆ·é‡å°‘ï¼Œè€Œä¸”è¦æ±‚æ¶ˆæ¯çš„å®æ—¶æ€§ä¸é«˜ï¼Œä¸€èˆ¬å¾ˆå°‘é‡‡ç”¨ï¼›</p>

<blockquote>
  <p>é•¿è½®è¯¢æŠ€æœ¯ï¼ˆlong-pollingï¼‰</p>
</blockquote>

<p>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€Ajaxè¯·æ±‚ï¼ŒæœåŠ¡å™¨æ¥åˆ°è¯·æ±‚åholdä½è¿æ¥ï¼Œç›´åˆ°æœ‰æ–°æ¶ˆæ¯æˆ–è¶…æ—¶ï¼ˆè®¾ç½®ï¼‰æ‰è¿”å›å“åº”ä¿¡æ¯å¹¶å…³é—­è¿æ¥ï¼Œå®¢æˆ·ç«¯å¤„ç†å®Œå“åº”ä¿¡æ¯åå†å‘æœåŠ¡å™¨å‘é€æ–°çš„è¯·æ±‚ã€‚</p>

<p>ä¼˜ç‚¹ï¼šå®æ—¶æ€§é«˜ï¼Œæ— æ¶ˆæ¯çš„æƒ…å†µä¸‹ä¸ä¼šè¿›è¡Œé¢‘ç¹çš„è¯·æ±‚ï¼›</p>

<p>ç¼ºç‚¹ï¼šæœåŠ¡å™¨ç»´æŒç€è¿æ¥æœŸé—´ä¼šæ¶ˆè€—èµ„æºï¼›</p>

<blockquote>
  <p>åŸºäºIframeåŠhtmlfileçš„æµï¼ˆstreamingï¼‰æ–¹å¼</p>
</blockquote>

<p>iframeæµæ–¹å¼æ˜¯åœ¨é¡µé¢ä¸­æ’å…¥ä¸€ä¸ªéšè—çš„iframeï¼Œåˆ©ç”¨å…¶srcå±æ€§åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´åˆ›å»ºä¸€æ¡é•¿é“¾æ¥ï¼ŒæœåŠ¡å™¨å‘iframeä¼ è¾“æ•°æ®ï¼ˆé€šå¸¸æ˜¯HTMLï¼Œå†…æœ‰è´Ÿè´£æ’å…¥ä¿¡æ¯çš„javascriptï¼‰ï¼Œæ¥å®æ—¶æ›´æ–°é¡µé¢ã€‚</p>

<p>ä¼˜ç‚¹ï¼šæ¶ˆæ¯èƒ½å¤Ÿå®æ—¶åˆ°è¾¾ï¼›</p>

<p>ç¼ºç‚¹ï¼šæœåŠ¡å™¨ç»´æŒç€é•¿è¿æ¥æœŸä¼šæ¶ˆè€—èµ„æºï¼›</p>

<blockquote>
  <p>æ’ä»¶æä¾›socketæ–¹å¼</p>
</blockquote>

<p>æ¯”å¦‚åˆ©ç”¨Flash XMLSocketï¼ŒJava Appletå¥—æ¥å£ï¼ŒActivexåŒ…è£…çš„socketã€‚</p>

<p>ä¼˜ç‚¹ï¼šåŸç”Ÿsocketçš„æ”¯æŒï¼Œå’ŒPCç«¯å’Œç§»åŠ¨ç«¯çš„å®ç°æ–¹å¼ç›¸ä¼¼ï¼›</p>

<p>ç¼ºç‚¹ï¼šæµè§ˆå™¨ç«¯éœ€è¦è£…ç›¸åº”çš„æ’ä»¶ï¼›</p>

<blockquote>
  <p>WebSocket</p>
</blockquote>

<p>æ˜¯HTML5å¼€å§‹æä¾›çš„ä¸€ç§æµè§ˆå™¨ä¸æœåŠ¡å™¨é—´è¿›è¡Œå…¨åŒå·¥é€šè®¯çš„ç½‘ç»œæŠ€æœ¯ã€‚</p>

<p>ä¼˜ç‚¹ï¼šæ›´å¥½çš„èŠ‚çœæœåŠ¡å™¨èµ„æºå’Œå¸¦å®½å¹¶è¾¾åˆ°å®æ—¶é€šè®¯ï¼›</p>

<p>ç¼ºç‚¹ï¼šç›®å‰è¿˜æœªæ™®åŠï¼Œæµè§ˆå™¨æ”¯æŒä¸å¥½ï¼›</p>

<p><strong>ç»¼ä¸Šï¼Œè€ƒè™‘åˆ°æµè§ˆå™¨å…¼å®¹æ€§å’Œæ€§èƒ½é—®é¢˜ï¼Œé‡‡ç”¨é•¿è½®è¯¢ï¼ˆlong-pollingï¼‰æ˜¯ä¸€ç§æ¯”è¾ƒå¥½çš„æ–¹å¼ã€‚</strong></p>

<p><strong>netty-socketioæ˜¯ä¸€ä¸ªå¼€æºçš„SocketæœåŠ¡å™¨ç«¯çš„ä¸€ä¸ªjavaçš„å®ç°ï¼Œ å®ƒåŸºäºNettyæ¡†æ¶ã€‚</strong></p>

<h2 id="2ä½¿ç”¨åœºæ™¯">2.ä½¿ç”¨åœºæ™¯</h2>

<ul>
  <li>webç‰ˆèŠå¤©å®¤åº”ç”¨</li>
  <li>è‚¡ç¥¨äº¤æ˜“èµ°åŠ¿</li>
  <li>è½¦è¾†å®æ—¶ç›‘æ§</li>
</ul>

<p><strong>ç¤ºä¾‹ï¼šæ¨¡æ‹Ÿè½¦è”ç½‘åº”ç”¨ä¸­è½¦è¾†åœ¨åœ°å›¾ä¸ŠåŠ¨æ€ç§»åŠ¨ï¼Œç§»åŠ¨æ•°æ®ä»åå°è·å–ï¼Œç„¶åé€šè¿‡socketé€šä¿¡æ¨é€åˆ°å‰ç«¯é¡µé¢ï¼Œ
ä½¿ç”¨ç™¾åº¦åœ°å›¾APIå®ç°å‰ç«¯è¦†ç›–ç‰©çš„åŠ¨æ€ç§»åŠ¨ã€‚</strong></p>

<p><img src="/images/zhaojiajun/20170404img01.jpg" alt="20170404img01" /></p>

<h2 id="3serverç«¯å®ç°">3.Serverç«¯å®ç°</h2>

<h3 id="å¼•å…¥jaråŒ…">å¼•å…¥jaråŒ…</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!-- netty-socket.io --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.corundumstudio.socketio&lt;/groupId&gt;
  &lt;artifactId&gt;netty-socketio&lt;/artifactId&gt;
  &lt;version&gt;1.7.7&lt;/version&gt;
  	&lt;/dependency&gt;
</code></pre></div></div>

<h3 id="serveræœåŠ¡å®ç°">serveræœåŠ¡å®ç°</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Configuration config = new Configuration();
config.setHostname("localhost");
config.setPort(9092);

final SocketIOServer server = new SocketIOServer(config);

//å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ç›‘å¬
server.addDisconnectListener(new DisconnectListener() {
    @Override
    public void onDisconnect(SocketIOClient client) {
        System.out.println("**************onDisconnect****************");
        //ç›‘å¬æ–­å¼€çš„è¿æ¥å­˜æ”¾åœ¨setä¸­ï¼Œç”¨äºåç»­åˆ¤æ–­ç»“æŸå¯¹åº”çš„åå°çº¿ç¨‹
        disconnectSet.add(client.getSessionId());
    }
});

//æ ¹æ®ä¸åŒçš„å‘½åç©ºé—´ï¼Œå•ä¸ªå®¢æˆ·ç«¯è§¦å‘
server.addNamespace("/position").addEventListener("msgevent", MsgObject.class, new DataListener&lt;MsgObject&gt;() {
    @Override
    public void onData(SocketIOClient client, MsgObject data, AckRequest ackRequest) {
    	//æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥å¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹
    	MsgThread msgThread = new MsgThread(client, data); 
    	msgThread.start();
    }
});

//å¹¿æ’­å¼æ¶ˆæ¯
server.addNamespace("/notice").addEventListener("msgevent", MsgObject.class, new DataListener&lt;MsgObject&gt;() {
    @Override
    public void onData(SocketIOClient client, MsgObject data, AckRequest ackRequest) {
    	server.getRoomOperations("/notice").sendEvent("msgevent", data);
    }
});

//å¯åŠ¨æœåŠ¡
server.start();
</code></pre></div></div>

<h3 id="å®šä¹‰ä¸€ä¸ªå†…éƒ¨ç±»ç”¨äºå¤„ç†æ¶ˆæ¯å‘é€çš„çº¿ç¨‹">å®šä¹‰ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œç”¨äºå¤„ç†æ¶ˆæ¯å‘é€çš„çº¿ç¨‹</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class MsgThread extends Thread {

	private SocketIOClient client;
	private MsgObject data;
	
	//åˆå§‹åŒ–æ–¹æ³•
	public MsgThread(SocketIOClient client, MsgObject data){
		this.client = client;
		this.data = data;
	}
	
	public void run() {
		String temp = data.getMessage();
    	PositionObject posArray[] = new PositionObject[Integer.parseInt(data.getMessage())];
    	//æ­¤å¤„æ¨¡æ‹Ÿåç«¯æœåŠ¡ä¸æ–­è·å–æ•°æ®å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
    	while(true){
    		if(MsgServer.disconnectSet.contains(client.getSessionId())){
    			MsgServer.disconnectSet.remove(client.getSessionId());
    			//å¦‚æœå®¢æˆ·ç«¯æ–­å¼€åˆ™åå°åœæ­¢å¯¹åº”çš„çº¿ç¨‹
    			client.disconnect();
    			Thread.interrupted();
    			break;
    		}
    		data.setMessage(temp+":"+String.valueOf(Math.random()));
    		for(int i=0; i&lt;posArray.length; i++){
    			//æ¨¡æ‹Ÿå¤šè½¦GPSç»çº¬åº¦å˜åŒ–
    			PositionObject position = new PositionObject();
        		position.setX(116.380967+Math.random()*0.01);
        		position.setY(39.913285+Math.random()*0.01);
    			posArray[i] = position;
    		}
    		data.setPosArray(posArray);
    		//å…ˆå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
    		client.sendEvent("msgevent", data);
    		try {
				Thread.sleep(3000);
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
    	}
    }
}
</code></pre></div></div>

<h2 id="4clientç«¯webå®ç°">4.Clientç«¯ï¼ˆWebå®ç°ï¼‰</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
	&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;
	&lt;meta name="viewport" content="initial-scale=1.0, user-scalable=no" /&gt;
	&lt;style type="text/css"&gt;
		body, html,#allmap {width: 100%;height: 80%;overflow: hidden;margin:0;font-family:"å¾®è½¯é›…é»‘";}
	&lt;/style&gt;
	&lt;script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&amp;ak=ç™¾åº¦åœ°å›¾AK"&gt;&lt;/script&gt;
	&lt;script src="js/socket.io/socket.io.js"&gt;&lt;/script&gt;
	&lt;script src="http://code.jquery.com/jquery-1.10.1.min.js"&gt;&lt;/script&gt;
	&lt;title&gt;æ¨¡æ‹Ÿè½¦è¾†æ ¹æ®GPSæ•°æ®å®æ—¶ç§»åŠ¨&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;div id="allmap"&gt;&lt;/div&gt;
	&lt;div id="status"&gt;&lt;/div&gt;
	&lt;div id="console"&gt;&lt;/div&gt;
	&lt;button type="button" onClick="connect('http://localhost:9092/position','msgevent')" id="send"&gt;connect&lt;/button&gt;
	&lt;button type="button" onClick="disconnect()"&gt;disconnect&lt;/button&gt;
	&lt;input id="msg" class="input-xlarge" type="text" placeholder="Type something..." /&gt;
	&lt;button type="button" onClick="sendMsg()" id="send"&gt;Send&lt;/button&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;script type="text/javascript"&gt;
	// ç™¾åº¦åœ°å›¾APIåŠŸèƒ½
	var map = new BMap.Map("allmap");
	map.centerAndZoom(new BMap.Point(116.404, 39.915), 15);
	var myIcon = new BMap.Icon("http://developer.baidu.com/map/jsdemo/img/Mario.png", new BMap.Size(32, 70), {    //å°è½¦å›¾ç‰‡
		//offset: new BMap.Size(0, -5),    //ç›¸å½“äºCSSç²¾çµ
		imageOffset: new BMap.Size(0, 0)    //å›¾ç‰‡çš„åç§»é‡ã€‚ä¸ºäº†æ˜¯å›¾ç‰‡åº•éƒ¨ä¸­å¿ƒå¯¹å‡†åæ ‡ç‚¹ã€‚
	});

	var socket;
	var eventN;
	var carMkes=new Array();
	var userName = 'user' + Math.floor((Math.random() * 1000) + 1);
	var message;
	function connect(url, eventName){
		socket = io.connect(url, {
		    'force new connection': true,
		    reconnect: true,
		    'connect timeout': 5000,
		    'reconnection delay': 200
		});
		eventN = eventName;
		socket.on('connect', function() {
			$('#status').html('Client has connected to the server!');
		});
		socket.on(eventName, function(data) {
			$('#console').html(data.userName + '=' + data.message);
			doPosition(data);
		});
		socket.on('disconnect',function() {
			$('#status').html('The client has disconnected!');
			clearMap();
		});
		socket.on('reconnect', function() {
			$('#status').html('Client has reconnected to the server!');
		});
		if(message!=null){
			sendMsg();
		}
	}

	//æ–­å¼€socketè¿æ¥
	function disconnect() {
		socket.disconnect();
	}

	//å‘æœåŠ¡ç«¯å‘é€æ•°æ®
	function emitMsg(param) {
		socket.emit(eventN, param);
	}

	function sendMsg(){
		message = $('#msg').val();
		var param = {userName : userName,message : message};
		emitMsg(param);
		//æ¨¡æ‹Ÿå¤šè¾†è½¦å­
		for(var i=0; i&lt;message; i++){
			var point = new BMap.Point(116.380967,39.913285);
			var carMk = new BMap.Marker(point,{icon:myIcon});
			carMkes[i] = carMk;
			map.addOverlay(carMk);
		}
	}

	//åœ°å›¾è¦†ç›–ç‰©å®šä½æ˜¾ç¤ºï¼Œç›¸å½“äºè½¦è¾†ä½ç½®ç§»åŠ¨
	function doPosition(data){
		var posArray = data.posArray;
		for(var j=0; j&lt;posArray.length; j++){
			var point = new BMap.Point(posArray[j].x,posArray[j].y);
			carMkes[j].setPosition(point);
		}
	}

	//æ¸…ç©ºåœ°å›¾è¦†ç›–ç‰©
	function clearMap(){
		map.clearOverlays();
		carMkes = [];
	}
&lt;/script&gt;
</code></pre></div></div>
:ET