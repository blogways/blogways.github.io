I"÷:<h2 id="ä¸€expresså®‰è£…">ä¸€ã€Expresså®‰è£…</h2>
<p>Expressæ˜¯ä¸€ä¸ªnode.jsæ¨¡å—ï¼Œé‡‡ç”¨npmå…¨å±€æ¨¡å—ã€‚</p>

<p>npm install -g express</p>

<h3 id="äºŒæ–°å»ºé¡¹ç›®">äºŒã€æ–°å»ºé¡¹ç›®</h3>

<p>åˆ›å»ºä¸€ä¸ªé¡¹ç›®express testExpress,ä¼šè‡ªåŠ¨ç”Ÿæˆç›®å½•ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   create : testExpress
   create : testExpress/package.json
   create : testExpress/app.js
   create : testExpress/public
   create : testExpress/public/images
   create : testExpress/views
   create : testExpress/views/layout.jade
   create : testExpress/views/index.jade
   create : testExpress/routes
   create : testExpress/routes/index.js
   create : testExpress/routes/user.js
   create : testExpress/public/stylesheets
   create : testExpress/public/stylesheets/style.css
   create : testExpress/public/javascripts
</code></pre></div></div>

<p>è¿è¡Œnode app.js ï¼ˆè¿è¡Œç¨‹åºï¼Œé»˜è®¤åœ°å€æ˜¯http://localhost:3000ï¼‰
å¦‚æœæ‰“å¼€é¡µé¢å‡ºé”™ï¼Œå¯èƒ½ä½ æ²¡æœ‰å®‰è£…jadeæ¨¡å—ï¼Œé‚£å°±è¾“å…¥npm install jadeè¿›è¡Œå®‰è£…ï¼Œåœ¨æˆ‘ä»¬
æ—¥å¿—åˆ†æç³»ç»Ÿä¸­æ²¡æœ‰ç”¨jadeæ¨¡æ¿ï¼Œç”¨çš„ejsæ¨¡æ¿ã€‚</p>

<h3 id="ä¸‰expressé¡¹ç›®ç›®å½•æ–‡ä»¶ä»‹ç»">ä¸‰ã€expressé¡¹ç›®ç›®å½•æ–‡ä»¶ä»‹ç»</h3>

<p>Expressç›®å½•ä»‹ç»ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ç›®å½•/æ–‡ä»¶	                                  è¯´æ˜

package.json	 						npmä¾èµ–é…ç½®æ–‡ä»¶ï¼Œ java Mavenä¸­çš„pom.xmlæ–‡ä»¶
app.js                                  é¡¹ç›®çš„å…¥å£æ–‡ä»¶
routes/                                 ç”¨äºå­˜æ”¾è·¯ç”±æ–‡ä»¶
public/                                 é™æ€æ–‡ä»¶
javascript/                             js
stylesheets/                            css
images/                                 å›¾ç‰‡
views/                                  æ¨¡æ¿æ–‡ä»¶, expressé»˜è®¤é‡‡ç”¨jade
node_modules/                           å­˜æ”¾npmå®‰è£…åˆ°æœ¬åœ°ä¾èµ–åŒ…ï¼Œä¾èµ–åŒ…åœ¨package.jsonæ–‡ä»¶
										ä¸­å£°æ˜ï¼Œä½¿ç”¨npm installæŒ‡ä»¤å®‰è£…
</code></pre></div></div>

<p>ç”³æ˜ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ä»¥ä¸Šç›®å½•æ–‡ä»¶ä»‹ç»ä»…å¯¹äºexpressæ¡†æ¶è‡ªåŠ¨ç”Ÿæˆç›®å½•ï¼Œæ¡†æ¶æ²¡æœ‰é™¤äº†package.jsonæ–‡ä»¶å’Œ node_modulesç›®å½•ï¼Œ
æ²¡æœ‰é™å®šå…¶ä»–æ–‡ä»¶åç§°å’Œç›®å½•ç»“æ„ï¼Œå¤§å®¶åœ¨å®é™…å¼€å‘ä¸­å¯ä»¥æ ¹æ®é¡¹ç›®éœ€è¦é‡æ–°å®šä¹‰ç›®å½•ç»“æ„ã€‚
</code></pre></div></div>

<h3 id="å››è¿è¡ŒåŸç†">å››ã€è¿è¡ŒåŸç†</h3>

<p>4.1ã€€åº•å±‚ï¼šhttpæ¨¡å—</p>

<p>Expressæ¡†æ¶å»ºç«‹åœ¨node.jså†…ç½®çš„httpæ¨¡å—ä¸Šã€‚httpæ¨¡å—ç”ŸæˆæœåŠ¡å™¨çš„åŸå§‹ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var http = require("http");

var app = http.createServer(function(request, response) {
  response.writeHead(200, {"Content-Type": "text/plain"});
  response.end("Hello world!\n");
});

app.listen(3000, "localhost");
console.log("Server running at http://localhost:3000/");
</code></pre></div></div>

<p>ä¸Šé¢ä»£ç çš„å…³é”®æ˜¯httpæ¨¡å—çš„createServeræ–¹æ³•ï¼Œè¡¨ç¤ºç”Ÿæˆä¸€ä¸ªHTTPæœåŠ¡å™¨å®ä¾‹ã€‚è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°çš„å‚æ•°ï¼Œåˆ†åˆ«ä¸ºä»£è¡¨HTTPè¯·æ±‚å’ŒHTTPå›åº”çš„requestå¯¹è±¡å’Œresponseå¯¹è±¡ã€‚</p>

<p>4.2ã€€å¯¹httpæ¨¡å—çš„å†åŒ…è£…</p>

<p>Expressæ¡†æ¶çš„æ ¸å¿ƒæ˜¯å¯¹httpæ¨¡å—çš„å†åŒ…è£…ã€‚ä¸Šé¢çš„ä»£ç ç”¨Expressæ”¹å†™å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var express = require("express");
var http = require("http");

var app = express();

app.use(function(request, response) {
  response.writeHead(200, { "Content-Type": "text/plain" });
  response.end("Hello world!\n");
});

http.createServer(app).listen(3000);
</code></pre></div></div>

<p>æ¯”è¾ƒä¸¤æ®µä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å®ƒä»¬éå¸¸æ¥è¿‘ï¼Œå”¯ä¸€çš„å·®åˆ«æ˜¯createServeræ–¹æ³•çš„å‚æ•°ï¼Œä»ä¸€ä¸ªå›è°ƒå‡½æ•°å˜æˆäº†ä¸€ä¸ªEpresså¯¹è±¡çš„å®ä¾‹ã€‚è€Œè¿™ä¸ªå®ä¾‹ä½¿ç”¨äº†useæ–¹æ³•ï¼ŒåŠ è½½äº†ä¸ä¸Šä¸€æ®µä»£ç ç›¸åŒçš„å›è°ƒå‡½æ•°ã€‚</p>

<p>Expressæ¡†æ¶ç­‰äºåœ¨httpæ¨¡å—ä¹‹ä¸Šï¼ŒåŠ äº†ä¸€ä¸ªä¸­é—´å±‚ï¼Œè€Œuseæ–¹æ³•åˆ™ç›¸å½“äºè°ƒç”¨ä¸­é—´ä»¶ã€‚</p>

<p>4.3ã€€ä¸­é—´ä»¶</p>

<p>ç®€å•è¯´ï¼Œä¸­é—´ä»¶ï¼ˆmiddlewareï¼‰å°±æ˜¯å¤„ç†HTTPè¯·æ±‚çš„å‡½æ•°ï¼Œç”¨æ¥å®Œæˆå„ç§ç‰¹å®šçš„ä»»åŠ¡ï¼Œæ¯”å¦‚æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ã€åˆ†ææ•°æ®ã€ä»¥åŠå…¶ä»–åœ¨éœ€è¦æœ€ç»ˆå°†æ•°æ®å‘é€ç»™ç”¨æˆ·ä¹‹å‰å®Œæˆçš„ä»»åŠ¡ã€‚å®ƒæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯ï¼Œä¸€ä¸ªä¸­é—´ä»¶å¤„ç†å®Œï¼Œå†ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚</p>

<p>node.jsçš„å†…ç½®æ¨¡å—httpçš„createServeræ–¹æ³•ï¼Œå¯ä»¥ç”Ÿæˆä¸€ä¸ªæœåŠ¡å™¨å®ä¾‹ï¼Œè¯¥å®ä¾‹å…è®¸åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨ä¸€ç³»åˆ—å‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯ä¸­é—´ä»¶ï¼‰ã€‚å½“ä¸€ä¸ªHTTPè¯·æ±‚è¿›å…¥æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å®ä¾‹ä¼šè°ƒç”¨ç¬¬ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå®Œæˆåæ ¹æ®è®¾ç½®ï¼Œå†³å®šæ˜¯å¦å†è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚ä¸­é—´ä»¶å†…éƒ¨å¯ä»¥ä½¿ç”¨æœåŠ¡å™¨å®ä¾‹çš„responseå¯¹è±¡ï¼ˆServerResponseï¼Œå³å›è°ƒå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼‰ï¼Œä»¥åŠä¸€ä¸ªnextå›è°ƒå‡½æ•°ï¼ˆå³ç¬¬ä¸‰ä¸ªå‚æ•°ï¼‰ã€‚æ¯ä¸ªä¸­é—´ä»¶éƒ½å¯ä»¥å¯¹HTTPè¯·æ±‚ï¼ˆrequestå¯¹è±¡ï¼‰åšå‡ºå›åº”ï¼Œå¹¶ä¸”å†³å®šæ˜¯å¦è°ƒç”¨nextæ–¹æ³•ï¼Œå°†requestå¯¹è±¡å†ä¼ ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€‚</p>

<p>ä¸€ä¸ªä¸è¿›è¡Œä»»ä½•æ“ä½œã€åªä¼ é€’requestå¯¹è±¡çš„ä¸­é—´ä»¶ï¼Œå¤§æ¦‚æ˜¯ä¸‹é¢è¿™æ ·ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function uselessMiddleware(req, res, next) { 
	next();
}
</code></pre></div></div>

<p>ä¸Šé¢ä»£ç çš„nextä¸ºä¸­é—´ä»¶çš„å›è°ƒå‡½æ•°ã€‚å¦‚æœå®ƒå¸¦æœ‰å‚æ•°ï¼Œåˆ™ä»£è¡¨æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå‚æ•°ä¸ºé”™è¯¯æ–‡æœ¬ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function uselessMiddleware(req, res, next) { 
	next('å‡ºé”™äº†ï¼');
} æŠ›å‡ºé”™è¯¯ä»¥åï¼Œåé¢çš„ä¸­é—´ä»¶å°†ä¸å†æ‰§è¡Œï¼Œç›´åˆ°å‘ç°ä¸€ä¸ªé”™è¯¯å¤„ç†å‡½æ•°ä¸ºæ­¢ã€‚
</code></pre></div></div>

<p>4.4ã€€useæ–¹æ³•</p>

<p>useæ˜¯expressè°ƒç”¨ä¸­é—´ä»¶çš„æ–¹æ³•ï¼Œå®ƒè¿”å›ä¸€ä¸ªå‡½æ•°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè¿ç»­è°ƒç”¨ä¸¤ä¸ªä¸­é—´ä»¶çš„ä¾‹å­ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var express = require("express");
var http = require("http");

var app = express();

app.use(function(request, response, next) {
  console.log("In comes a " + request.method + " to " + request.url);
  next();
});

app.use(function(request, response) {
  response.writeHead(200, { "Content-Type": "text/plain" });
  response.end("Hello world!\n");
});

http.createServer(app).listen(3000);
</code></pre></div></div>

<p>ä¸Šé¢ä»£ç å…ˆè°ƒç”¨ç¬¬ä¸€ä¸ªä¸­é—´ä»¶ï¼Œåœ¨æ§åˆ¶å°è¾“å‡ºä¸€è¡Œä¿¡æ¯ï¼Œç„¶åé€šè¿‡nextæ–¹æ³•ï¼Œè°ƒç”¨ç¬¬äºŒä¸ªä¸­é—´ä»¶ï¼Œè¾“å‡ºHTTPå›åº”ã€‚ç”±äºç¬¬äºŒä¸ªä¸­é—´ä»¶æ²¡æœ‰è°ƒç”¨nextæ–¹æ³•ï¼Œæ‰€ä»¥ä¸å†requestå¯¹è±¡å°±ä¸å†å‘åä¼ é€’äº†ã€‚</p>

<p>ä½¿ç”¨useæ–¹æ³•ï¼Œå¯ä»¥æ ¹æ®è¯·æ±‚çš„ç½‘å€ï¼Œè¿”å›ä¸åŒçš„ç½‘é¡µå†…å®¹ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var express = require("express");
var http = require("http");

var app = express();

app.use(function(request, response, next) {
  if (request.url == "/") {
    response.writeHead(200, { "Content-Type": "text/plain" });
    response.end("Welcome to the homepage!\n");
  } else {
    next();
  }
});

app.use(function(request, response, next) {
  if (request.url == "/about") {
    response.writeHead(200, { "Content-Type": "text/plain" });
  } else {
    next();
  }
});

app.use(function(request, response) {
  response.writeHead(404, { "Content-Type": "text/plain" });
  response.end("404 error!\n");
});

http.createServer(app).listen(3000);
</code></pre></div></div>

<p>ä¸Šé¢ä»£ç é€šè¿‡request.urlå±æ€§ï¼Œåˆ¤æ–­è¯·æ±‚çš„ç½‘å€ï¼Œä»è€Œè¿”å›ä¸åŒçš„å†…å®¹ã€‚</p>

<p>é™¤äº†åœ¨å›è°ƒå‡½æ•°å†…éƒ¨ï¼Œåˆ¤æ–­è¯·æ±‚çš„ç½‘å€ï¼ŒExpressä¹Ÿå…è®¸å°†è¯·æ±‚çš„ç½‘å€å†™åœ¨useæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use('/', someMiddleware);
</code></pre></div></div>

<p>ä¸Šé¢ä»£ç è¡¨ç¤ºï¼Œåªå¯¹æ ¹ç›®å½•çš„è¯·æ±‚ï¼Œè°ƒç”¨æŸä¸ªä¸­é—´ä»¶ã€‚</p>

<h3 id="äº”expressçš„æ–¹æ³•">äº”ã€Expressçš„æ–¹æ³•</h3>

<p>5.1ã€€allæ–¹æ³•å’ŒHTTPåŠ¨è¯æ–¹æ³•</p>

<p>é’ˆå¯¹ä¸åŒçš„è¯·æ±‚ï¼ŒExpressæä¾›äº†useæ–¹æ³•çš„ä¸€äº›åˆ«åã€‚æ¯”å¦‚ï¼Œä¸Šé¢ä»£ç ä¹Ÿå¯ä»¥ç”¨åˆ«åçš„å½¢å¼æ¥å†™ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var express = require("express");
var http = require("http");
var app = express();

app.all("*", function(request, response, next) {
  response.writeHead(200, { "Content-Type": "text/plain" });
  next();
});

app.get("/", function(request, response) {
  response.end("Welcome to the homepage!");
});

app.get("/about", function(request, response) {
  response.end("Welcome to the about page!");
});

app.get("*", function(request, response) {
  response.end("404!");
});

http.createServer(app).listen(3000);
</code></pre></div></div>

<p>ä¸Šé¢ä»£ç çš„allæ–¹æ³•è¡¨ç¤ºï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å¿…é¡»é€šè¿‡è¯¥ä¸­é—´ä»¶ï¼Œå‚æ•°ä¸­çš„â€œ*â€è¡¨ç¤ºå¯¹æ‰€æœ‰è·¯å¾„æœ‰æ•ˆã€‚getæ–¹æ³•åˆ™æ˜¯åªæœ‰GETåŠ¨è¯çš„HTTPè¯·æ±‚é€šè¿‡è¯¥ä¸­é—´ä»¶ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¯·æ±‚çš„è·¯å¾„ã€‚ç”±äºgetæ–¹æ³•çš„å›è°ƒå‡½æ•°æ²¡æœ‰è°ƒç”¨nextæ–¹æ³•ï¼Œæ‰€ä»¥åªè¦æœ‰ä¸€ä¸ªä¸­é—´ä»¶è¢«è°ƒç”¨äº†ï¼Œåé¢çš„ä¸­é—´ä»¶å°±ä¸ä¼šå†è¢«è°ƒç”¨äº†ã€‚</p>

<p>é™¤äº†getæ–¹æ³•ä»¥å¤–ï¼ŒExpressè¿˜æä¾›postã€putã€deleteæ–¹æ³•ï¼Œå³HTTPåŠ¨è¯éƒ½æ˜¯Expressçš„æ–¹æ³•ã€‚</p>

<p>è¿™äº›æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œéƒ½æ˜¯è¯·æ±‚çš„è·¯å¾„ã€‚é™¤äº†ç»å¯¹åŒ¹é…ä»¥å¤–ï¼ŒExpresså…è®¸æ¨¡å¼åŒ¹é…ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.get("/hello/:who", function(req, res) {
  res.end("Hello, " + req.params.who + ".");
});
</code></pre></div></div>

<p>ä¸Šé¢ä»£ç å°†åŒ¹é…â€œ/hello/aliceâ€ç½‘å€ï¼Œç½‘å€ä¸­çš„aliceå°†è¢«æ•è·ï¼Œä½œä¸ºreq.params.whoå±æ€§çš„å€¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ•è·åéœ€è¦å¯¹ç½‘å€è¿›è¡Œæ£€æŸ¥ï¼Œè¿‡æ»¤ä¸å®‰å…¨å­—ç¬¦ï¼Œä¸Šé¢çš„å†™æ³•åªæ˜¯ä¸ºäº†æ¼”ç¤ºï¼Œç”Ÿäº§ä¸­ä¸åº”è¿™æ ·ç›´æ¥ä½¿ç”¨ç”¨æˆ·æä¾›çš„å€¼ã€‚</p>

<p>å¦‚æœåœ¨æ¨¡å¼å‚æ•°åé¢åŠ ä¸Šé—®å·ï¼Œè¡¨ç¤ºè¯¥å‚æ•°å¯é€‰ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.get('/hello/:who?',function(req,res) {
if(req.params.id) {
    res.end("Hello, " + req.params.who + ".");
}
else {
    res.send("Hello, Guest.");
}
});
</code></pre></div></div>

<p>5.2ã€€setæ–¹æ³•</p>

<p>setæ–¹æ³•ç”¨äºæŒ‡å®šå˜é‡çš„å€¼ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.set("views", __dirname + "/views");
app.set("view engine", "jade");
</code></pre></div></div>

<p>ä¸Šé¢ä»£ç ä½¿ç”¨setæ–¹æ³•ï¼Œä¸ºç³»ç»Ÿå˜é‡â€œviewsâ€å’Œâ€œview engineâ€æŒ‡å®šå€¼ã€‚</p>

<p>5.3ã€€responseå¯¹è±¡</p>

<p>ï¼ˆ1ï¼‰response.redirectæ–¹æ³•</p>

<p>response.redirectæ–¹æ³•å…è®¸ç½‘å€çš„é‡å®šå‘ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>response.redirect("/hello/anime");
response.redirect("http://www.example.com");
response.redirect(301, "http://www.example.com"); 
</code></pre></div></div>

<p>ï¼ˆ2ï¼‰response.sendFileæ–¹æ³•</p>

<p>response.sendFileæ–¹æ³•ç”¨äºå‘é€æ–‡ä»¶ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>response.sendFile("/path/to/anime.mp4");
</code></pre></div></div>

<p>ï¼ˆ3ï¼‰response.renderæ–¹æ³•</p>

<p>response.renderæ–¹æ³•ç”¨äºæ¸²æŸ“ç½‘é¡µæ¨¡æ¿ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.get("/", function(request, response) {
  response.render("index", { message: "Hello World" });
});
</code></pre></div></div>

<p>ä¸Šé¢ä»£ç ä½¿ç”¨renderæ–¹æ³•ï¼Œå°†messageå˜é‡ä¼ å…¥indexæ¨¡æ¿ï¼Œæ¸²æŸ“æˆHTMLç½‘é¡µã€‚</p>

<p>5.4ã€€requstå¯¹è±¡</p>

<p>ï¼ˆ1ï¼‰request.ip</p>

<p>request.ipå±æ€§ç”¨äºè·å¾—HTTPè¯·æ±‚çš„IPåœ°å€ã€‚</p>

<p>ï¼ˆ2ï¼‰request.files</p>

<p>request.filesç”¨äºè·å–ä¸Šä¼ çš„æ–‡ä»¶ã€‚</p>

<h3 id="å…­æ—¥å¿—ç³»ç»Ÿéƒ¨åˆ†é…ç½®">å…­ã€æ—¥å¿—ç³»ç»Ÿéƒ¨åˆ†é…ç½®</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// should be placed before express.static
app.use(express.compress({
  filter: function (req, res) {
    return /json|text|javascript|css/.test(res.getHeader('Content-Type'))
  },
  level: 9
}))

app.use(express.favicon('public/favicon.ico'))
app.use(express.static(config.root + '/public'))

// don't use logger for test env
if (process.env.NODE_ENV !== 'test') {
  app.use(express.logger('dev'))
}

// set views path, template engine and default layout
  app.engine('html', require('ejs').__express)
app.set('views', config.root + '/app/views')
app.set('view engine', 'html')

app.use(partials());
app.use(pjax());


// cookieParser should be above session
app.use(express.cookieParser())


// bodyParser should be above methodOverride
app.use(express.bodyParser())
app.use(express.methodOverride())

//log4js
log.use(app);

 app.use(function(req, res, next){
	res.on('header', function() {
		if (!req.session) return;
		if (req.session.cookie.expires==null) return;
		req.session.cookie.expires = new Date(Date.now() + 1000*60*60*24*14)
	})
	next()
});

// express/mongo session storage
app.use(express.session({
  secret: 'logAnalyse-pangu',
  cookie: { maxAge: 900000 },  //15 minute
  store: new mongoStore({
    url: config.db,
    collection : 'sessions'
  })
}))



// connect flash for flash messages - should be declared after sessions
app.use(flash())

// adds CSRF support
if (process.env.NODE_ENV !== 'test') {
    app.use(express.csrf())
}

app.use(function(req, res, next){
  //if(req.url != "/faye")
      res.locals.csrf_token = req.csrfToken();
  next()
})


//menu Plug-in technology    
var menus = [];
require('../app/controllers/menu').loadMenu(config.root+'/app/controllers/menu',
function(m){menus = m;});

  
//Public Response Information 
app.use(function(req, res, next){         
    if (req.session.user){ 
        res.locals.menus = menus;
        res.locals.current_user = req.session.user;
    }else{ 
                 
       if(req.url != "/login.html" &amp;&amp; req.url != "/auth.html" &amp;&amp; req.url != "/logout" 
       &amp;&amp; req.url != "/register" &amp;&amp; req.url != "/registerAction"){
            if (req.url == "/getInbox.html"){
               ContentType = "text/plain";
               res.StatusCode =500;
               res.write("ä¼šè¯è¶…æ—¶ï¼Œè¯·é‡æ–°ç™»å½•ï¼");
               res.end();
               return;
            }
            return res.redirect('/login.html')
       }
    }
    return next();   
});

            
//Plug-in technology    
plugin(app).require(config.root+'/app/controllers/plugin').load();

// routes should be at the last
app.use(app.router)
</code></pre></div></div>

:ET