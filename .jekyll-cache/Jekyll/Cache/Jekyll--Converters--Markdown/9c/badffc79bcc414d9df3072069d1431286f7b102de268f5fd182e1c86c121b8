I"Š <h2 id="ä¸€å‰è¨€">ä¸€ã€å‰è¨€</h2>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç» Flyway åœ¨ç®¡ç†èœ‚çªç³»ç»Ÿæ•°æ®åº“ç»“æ„å’Œæ•°æ®ä¸­çš„åº”ç”¨ã€‚åœ¨èœ‚çªé¡¹ç›®ä¸­åº”ç”¨ Flyway ä¸»è¦è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
  <li>å¦‚ä½•ç®¡ç†å¤šä¸ªæ•°æ®åº“ï¼›</li>
  <li>å¦‚ä½•ç®¡ç†ä¸åŒç¯å¢ƒçš„æ•°æ®åº“ã€‚</li>
</ul>

<p>æœ¬æ–‡ä»ç„¶ä½¿ç”¨ Flyway maven æ’ä»¶ï¼ŒCommand line å’Œ gradle å®é™…ä¸Šå’Œ maven æ˜¯ç±»ä¼¼çš„ï¼ŒJava API èƒ½æä¾›ä¸€äº›<code class="language-plaintext highlighter-rouge">é’©å­</code>ã€‚</p>

<h2 id="äºŒflyway-ç®¡ç†å¤šä¸ªæ•°æ®åº“">äºŒã€Flyway ç®¡ç†å¤šä¸ªæ•°æ®åº“</h2>

<h3 id="1å»ºç«‹è¿ç§»è„šæœ¬ç›®å½•">1ã€å»ºç«‹è¿ç§»è„šæœ¬ç›®å½•</h3>
<p>èœ‚çªè¦ç®¡ç†ä¸¤ä¸ªæ•°æ®åº“ï¼Œä¸ºæ¯ä¸ªæ•°æ®åº“å»ºç«‹ä¸€ä¸ª SQL è¿ç§»è„šæœ¬<code class="language-plaintext highlighter-rouge">ç›®å½•</code>ã€‚å¦‚å›¾åœ¨ <code class="language-plaintext highlighter-rouge">db/migration</code> ç›®å½•ä¸­ï¼Œä¸º info å’Œ cen åº“å„è‡ªå»ºç«‹ä¸€ä¸ªç›®å½•ï¼š</p>

<p><img src="/images/jyjsjd/flyway_dir2.png" alt="flyway_dir2.png" /></p>

<h3 id="2ä¿®æ”¹-pomxml">2ã€ä¿®æ”¹ pom.xml</h3>

<p>ï¼ˆ1ï¼‰æ·»åŠ  Flyway æ’ä»¶</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;plugin&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.flywaydb<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>flyway-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>5.0.5<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div></div>

<p>ï¼ˆ2ï¼‰æ·»åŠ  executions
åœ¨ <code class="language-plaintext highlighter-rouge">executions</code> æ ‡ç­¾ä¸­ä¸ºä¸¤ä¸ªæ•°æ®åº“å®ä¾‹å„æ·»åŠ ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">execution</code>ï¼Œç”¨ <code class="language-plaintext highlighter-rouge">id</code> åŒºåˆ†ã€‚æ³¨æ„æŒ‡å®š SQL è¿ç§»è„šæœ¬çš„ç›®å½•ä½ç½® <code class="language-plaintext highlighter-rouge">location</code>ã€‚å¦‚ä¸‹æŒ‡å®šäº† info åº“çš„å‚æ•°ï¼›cen åº“ç±»ä¼¼ï¼Œåªè¦ä¿®æ”¹è¿æ¥å‚æ•°ã€ç”¨æˆ·åå’Œå¯†ç å³å¯ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;execution&gt;</span>
  <span class="nt">&lt;id&gt;</span>info<span class="nt">&lt;/id&gt;</span>
  <span class="nt">&lt;phase&gt;</span>compile<span class="nt">&lt;/phase&gt;</span>
  <span class="nt">&lt;goals&gt;</span>
    <span class="nt">&lt;goal&gt;</span>migrate<span class="nt">&lt;/goal&gt;</span>
  <span class="nt">&lt;/goals&gt;</span>
  <span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;url&gt;</span>jdbc:mysql://hostname:port#/db_name<span class="nt">&lt;/url&gt;</span>
    <span class="nt">&lt;user&gt;</span>username<span class="nt">&lt;/user&gt;</span>
    <span class="nt">&lt;password&gt;</span>password<span class="nt">&lt;/password&gt;</span>
    <span class="nt">&lt;locations&gt;</span>
      <span class="nt">&lt;location&gt;</span>filesystem:src/main/resources/db/migration/info<span class="nt">&lt;/location&gt;</span>
    <span class="nt">&lt;/locations&gt;</span>
  <span class="nt">&lt;/configuration&gt;</span>
<span class="nt">&lt;/execution&gt;</span>
</code></pre></div></div>

<p>ï¼ˆ3ï¼‰æ‰§è¡Œæ•°æ®åº“è¿ç§»</p>
<ul>
  <li>å¯¼å‡º info å’Œ cen åº“åŸæœ‰æ•°æ®å’Œç»“æ„ï¼Œåˆ†åˆ«æ”¾å…¥å„è‡ªçš„ <code class="language-plaintext highlighter-rouge">db/migration</code> ç›®å½•ï¼Œå‘½åä¸º <code class="language-plaintext highlighter-rouge">V1__Base_line.sql</code>ï¼Œè¿è¡Œå‘½ä»¤ï¼š<code class="language-plaintext highlighter-rouge">mvn flyway:baseline</code>ï¼›</li>
  <li>æ‰§è¡Œæ•°æ®åº“ç»“æ„æˆ–å†…å®¹ä¿®æ”¹ï¼š<code class="language-plaintext highlighter-rouge">mvn flyway:migrate</code>ï¼›</li>
  <li>æ³¨æ„ï¼šä¸ºäº†æ˜ç¡®æŒ‡å®šæ‰§è¡ŒæŸä¸ªæ•°æ®çš„è¿ç§»è„šæœ¬ï¼Œå¿…é¡»åŠ ä¸Š <code class="language-plaintext highlighter-rouge">execution</code> ä¸­çš„ <code class="language-plaintext highlighter-rouge">id</code>ï¼Œå¦‚è¦æ‰§è¡Œ info åº“çš„è¿ç§»ï¼š<code class="language-plaintext highlighter-rouge">mvn flyway:migrate@info</code>ã€‚</li>
</ul>

<p>è¿è¡Œå®Œæˆä¹‹åï¼Œinfo åº“ä¸­ä¼šå»ºç«‹è¡¨ <code class="language-plaintext highlighter-rouge">flyway_schema_history</code> è·Ÿè¸ªæ•°æ®åº“ç‰ˆæœ¬ï¼Œå¹¶æ’å…¥ç¬¬ä¸€æ¬¡è¿ç§»è®°å½•ã€‚cen åº“åŒç†ã€‚</p>

<h2 id="ä¸‰flyway-ç®¡ç†ä¸åŒç¯å¢ƒçš„æ•°æ®åº“">ä¸‰ã€Flyway ç®¡ç†ä¸åŒç¯å¢ƒçš„æ•°æ®åº“</h2>
<p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œä¸ä»…æœ‰å¤šä¸ªæ•°æ®åº“å®ä¾‹ï¼Œè¿˜æœ‰å¤šä¸ªç¯å¢ƒï¼Œå¦‚å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒã€‚ä¸ºäº†èƒ½å¤Ÿç»Ÿä¸€ç®¡ç†ï¼Œéœ€è¦ä¸ºä¸åŒç¯å¢ƒé…ç½®ä¸åŒå‚æ•°ã€‚</p>

<p>ï¼ˆ1ï¼‰profile
åœ¨ pom.xml ä¸­ï¼Œæ·»åŠ  <code class="language-plaintext highlighter-rouge">profiles</code>ï¼Œå¹¶æ·»åŠ ä¸‰ä¸ª <code class="language-plaintext highlighter-rouge">profile</code>ï¼š<code class="language-plaintext highlighter-rouge">dev</code>ã€<code class="language-plaintext highlighter-rouge">qa</code> å’Œ <code class="language-plaintext highlighter-rouge">prod</code>ï¼Œåˆ†åˆ«ç®¡ç†ä¸åŒç¯å¢ƒçš„<code class="language-plaintext highlighter-rouge">æ•°æ®åº“è¿æ¥</code>ã€<code class="language-plaintext highlighter-rouge">ç”¨æˆ·å</code>å’Œ<code class="language-plaintext highlighter-rouge">å¯†ç </code>ï¼š</p>

<p><img src="/images/jyjsjd/profile.png" alt="profile.png" /></p>

<p>é»˜è®¤æ¿€æ´» <code class="language-plaintext highlighter-rouge">dev</code> ç¯å¢ƒï¼Œæ·»åŠ ï¼š</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;activation&gt;</span>
  <span class="nt">&lt;activeByDefault&gt;</span>true<span class="nt">&lt;/activeByDefault&gt;</span>
<span class="nt">&lt;/activation&gt;</span>
</code></pre></div></div>

<p>ï¼ˆ2ï¼‰å ä½ç¬¦
æŠŠ configuration ä¸­çš„å‚æ•°æ›¿æ¢ä¸º<code class="language-plaintext highlighter-rouge">å ä½ç¬¦</code>ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;url&gt;</span>${info.url}<span class="nt">&lt;/url&gt;</span>
  <span class="nt">&lt;user&gt;</span>${info.user}<span class="nt">&lt;/user&gt;</span>
  <span class="nt">&lt;password&gt;</span>${info.password}<span class="nt">&lt;/password&gt;</span>
  <span class="nt">&lt;locations&gt;</span>
    <span class="nt">&lt;location&gt;</span>filesystem:src/main/resources/db/migration/info<span class="nt">&lt;/location&gt;</span>
  <span class="nt">&lt;/locations&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></div>

<p>ï¼ˆ3ï¼‰åœ¨ä¸åŒç¯å¢ƒæ‰§è¡Œè„šæœ¬è¿ç§»
ç»™ mvn å‘½ä»¤æ·»åŠ å‚æ•° <code class="language-plaintext highlighter-rouge">-P</code>ï¼Œ<code class="language-plaintext highlighter-rouge">mvn flyway:migrate@info -P ç¯å¢ƒid</code>ã€‚</p>

<p>å¦‚åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œè¿ç§»ï¼š<code class="language-plaintext highlighter-rouge">mvn flyway:migrate@info -P prod</code>ã€‚</p>

<h2 id="å››é…ç½®é’©å­">å››ã€é…ç½®é’©å­</h2>
<p>Flyway æä¾›å¤šç§é’©å­ï¼Œå¯ä»¥åœ¨æ‰§è¡Œ migrateï¼Œinfoï¼Œcleanï¼Œvalidateï¼Œbaseline ç­‰å‘½ä»¤<code class="language-plaintext highlighter-rouge">å‰å</code>æ‰§è¡Œã€‚</p>

<p>Java API æä¾›äº† <code class="language-plaintext highlighter-rouge">FlywayCallback</code> æ¥å£ï¼Œæˆ–è€…å¯ä»¥ç»§æ‰¿ <code class="language-plaintext highlighter-rouge">BaseFlywayCallback</code>ï¼Œå®ç°æ‰€éœ€æ–¹æ³•ã€‚</p>

<p>æœ€ååœ¨ pom.xml æ–‡ä»¶é…ç½® <code class="language-plaintext highlighter-rouge">callback</code>ã€‚åœ¨ <code class="language-plaintext highlighter-rouge">configuration</code> æ ‡ç­¾é‡Œæ·»åŠ ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;callbacks&gt;
  &lt;callback&gt;CallbackClassName&lt;/callback&gt;
&lt;/callbacks&gt;
</code></pre></div></div>

<h2 id="äº”å‚è€ƒæ–‡çŒ®">äº”ã€å‚è€ƒæ–‡çŒ®</h2>
<p><a href="https://stackoverflow.com/questions/23545657/how-to-use-flyway-configuration-to-handle-multiple-databases">Stack Overflow</a> â€œHow to use Flyway configuration to handle multiple databasesâ€</p>

<p><a href="https://flywaydb.org/documentation/faq#multiple-schemas">Flyway FAQ</a> â€œDoes Flyway support multiple schemas?â€</p>

<p><a href="https://flywaydb.org/documentation/api/hooks">Flyway Hooks</a> â€œHooksâ€</p>
:ET