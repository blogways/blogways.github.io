I"¸%<h2 id="express4x-api-ç¿»è¯‘2--request">Express4.x API ç¿»è¯‘[2] â€“ Request</h2>

<h3 id="reqparams">req.params</h3>

<p>æ­¤å±æ€§æ˜¯ä¸€ä¸ªåŒ…å«æ˜ å°„è·¯ç”±â€parametersâ€çš„å¯¹è±¡ã€‚ä¾‹å¦‚ä½ ä½¿ç”¨/user/:nameè·¯ç”±ï¼Œé‚£ä¹ˆâ€nameâ€å±æ€§å¯¹ä½ æ¥è¯´å°±æ˜¯ä¸€ä¸ªreq.params.nameå˜é‡ã€‚è¯¥å¯¹è±¡é»˜è®¤ä¸º{}ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// GET /user/tj
req.params.name
// =&gt; "tj"
</code></pre></div></div>

<p>å½“åœ¨å®šä¹‰è·¯ç”±è§„åˆ™æ—¶ä½¿ç”¨äº†æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½¿ç”¨req.params[N]è·å–æ‰€æœ‰å‚æ•°åŒ¹é…æ•°ç»„ï¼Œå…¶ä¸­Nè¡¨ç¤ºæ•°ç»„çš„ç¬¬å‡ ä¸ªã€‚æ­¤è§„åˆ™é€‚ç”¨äºåŒ…å«æœªå®šä¹‰çš„é€šé…ç¬¦çš„è·¯ç”±å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚<code class="language-plaintext highlighter-rouge">/file/*</code>ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// GET /file/javascripts/jquery.js
req.params[0]
// =&gt; "javascripts/jquery.js" ### req.query
</code></pre></div></div>

<p>æ­¤å±æ€§æ˜¯ä¸€ä¸ªåŒ…å«è§£ææŸ¥è¯¢å­—ç¬¦ä¸²çš„å¯¹è±¡ï¼Œé»˜è®¤ä¸º{}ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// GET /search?q=tobi+ferret
req.query.q
// =&gt; "tobi ferret"

// GET /shoes?order=desc&amp;shoe[color]=blue&amp;shoe[type]=converse
req.query.order
// =&gt; "desc"

req.query.shoe.color
// =&gt; "blue"

req.query.shoe.type
// =&gt; "converse" ### req.param(name)
</code></pre></div></div>

<p>è¿”å›å½“å‰nameå‚æ•°çš„å€¼ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ?name=tobi
req.param('name')
// =&gt; "tobi"

// POST name=tobi
req.param('name')
// =&gt; "tobi"

// /user/tobi for /user/:name 
req.param('name')
// =&gt; "tobi"
</code></pre></div></div>

<p>æŸ¥æ‰¾ä¼˜å…ˆçº§å¦‚ä¸‹ï¼š</p>

<ul>
  <li>req.params</li>
  <li>req.body</li>
  <li>req.query</li>
</ul>

<p>ç›´æ¥ä½¿ç”¨req.bodyï¼Œreq.paramsï¼Œå’Œreq.queryåº”è¯¥æ›´æ–°æ¸…æ™°ï¼Œé™¤éä½ ç¡®å®éœ€è¦æ¥æ”¶æ¯ä¸ªå¯¹è±¡çš„è¾“å…¥ã€‚</p>

<h3 id="reqroute">req.route</h3>

<p>å½“å‰åŒ¹é…çš„è·¯ç”±åŒ…å«å¤šä¸ªå±æ€§ï¼Œå¦‚è·¯ç”±çš„åŸå§‹è·¯å¾„å­—ç¬¦ä¸²ä»¥åŠè½¬æ¢åçš„æ­£åˆ™è¡¨è¾¾å¼ç­‰ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.get('/user/:id?', function(req, res){
  console.log(req.route);
});
</code></pre></div></div>

<p>ä¸Šé¢çš„ä»£ç è¾“å‡ºç»“æœï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ path: '/user/:id?',
  keys: [ { name: 'id', optional: true } ],
  regexp: /^\/user(?:\/([^\/]+?))?\/?$/i,
  params: [ id: '12' ] } ### req.cookies
</code></pre></div></div>

<p>å½“cookieParser()ä¸­é—´ä»¶ä½¿ç”¨æ—¶è¯¥å¯¹è±¡é»˜è®¤ä¸º{}ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜åŒ…å«ç”±ç”¨æˆ·ä»£ç†å‘é€çš„cookiesã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Cookie: name=tj
req.cookies.name
// =&gt; "tj"
</code></pre></div></div>

<p>å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®è¯·å‚é˜…cookie-parseré™„åŠ æ–‡æ¡£ã€‚</p>

<h3 id="reqsignedcookies">req.signedCookies</h3>

<p>å½“cookieParser(secret)ä¸­é—´ä»¶ä½¿ç”¨è¯¥å¯¹è±¡é»˜è®¤ä¸º{}ï¼Œè¿˜åŒ…æ‹¬ç”¨æˆ·ä»£ç†å‘é€çš„ç­¾åcookiesï¼Œæœªç­¾åä»¥åŠå‡†å¤‡ä½¿ç”¨çš„ã€‚ç­¾åcookieså­˜æ”¾äºä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡ï¼Œä»¥æ˜¾ç¤ºå¼€å‘è€…çš„æ„å›¾ï¼Œå¦åˆ™å¯ä»¥é€šè¿‡åœ¨req.cookieè®¾ç½®å€¼å‘èµ·æ¶æ„æ”»å‡»ï¼Œä»è€Œå¾ˆè½»æ˜“çš„æ¬ºéª—ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ç­¾åçš„cookieå¹¶ä¸æ„å‘³ç€å®ƒæ˜¯éšè—çš„æˆ–è€…æ˜¯åŠ å¯†çš„ï¼Œè¿™ä¸ªé˜²æ­¢ç¯¡æ”¹çš„ç§˜å¯†åªæ˜¯ç®€å•çš„å°†ç­¾åç§æœ‰åŒ–ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Cookie: user=tobi.CP7AWaXDfAKIRfH49dQzKJx7sKzzSoPq7/AcBBRVwlI3
req.signedCookies.user
// =&gt; "tobi" å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®è¯·å‚é˜…cookie-parseré™„åŠ æ–‡æ¡£ã€‚
</code></pre></div></div>

<h3 id="reqgetfield">req.get(field)</h3>

<p>è·å–è¯·æ±‚å¤´å†…çš„fieldå­—æ®µï¼Œä¸åŒºåˆ†å¤§å°å†™ã€‚Referrerå’ŒRefererå­—æ®µå¯ä»¥äº’æ¢ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>req.get('Content-Type');
// =&gt; "text/plain"

req.get('content-type');
// =&gt; "text/plain"

req.get('Something');
// =&gt; undefined åˆ«åä¸ºreq.header(field)ã€‚
</code></pre></div></div>

<h3 id="reqacceptstypes">req.accepts(types)</h3>

<p>æ£€æŸ¥ç»™å®šçš„typesæ˜¯ä¸æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå½“ç»“æœä¸ºtrueæ—¶è¿”å›æœ€ä½³åŒ¹é…ï¼Œå¦åˆ™è¿”å›undefinedï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä½ åº”è¯¥è¿”å›406â€Not Acceptableâ€ã€‚</p>

<p>typeå¯ä»¥æ˜¯å•ä¸€çš„mineç±»å‹çš„å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚â€application/jsonâ€ï¼Œæ‰©å±•åå¦‚â€jsonâ€ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»¥é€—å·åˆ†éš”çš„åˆ—è¡¨æˆ–è€…æ•°ç»„ã€‚å½“ä¸ºåˆ—è¡¨æˆ–æ•°ç»„æ—¶å°†è¿”å›æœ€ä½³åŒ¹é…ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Accept: text/html
req.accepts('html');
// =&gt; "html"

// Accept: text/*, application/json
req.accepts('html');
// =&gt; "html"
req.accepts('text/html');
// =&gt; "text/html"
req.accepts('json, text');
// =&gt; "json"
req.accepts('application/json');
// =&gt; "application/json"

// Accept: text/*, application/json
req.accepts('image/png');
req.accepts('png');
// =&gt; undefined

// Accept: text/*;q=.5, application/json
req.accepts(['html', 'json']);
req.accepts('html, json');
// =&gt; "json"
</code></pre></div></div>

<p>å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®ï¼Œè¯·å‚é˜…acceptsé™„åŠ æ–‡æ¡£ã€‚</p>

<h3 id="reqacceptscharsetcharset">req.acceptsCharset(charset)</h3>
<p>æ£€æŸ¥ç»™å®šçš„å­—ç¬¦é›†æ˜¯å¦å¯ä»¥æ”¯æŒã€‚</p>

<p>å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®ï¼Œè¯·å‚é˜…acceptsé™„åŠ æ–‡æ¡£ã€‚</p>

<h3 id="reqacceptslanguagelang">req.acceptsLanguage(lang)</h3>
<p>æ£€æŸ¥ç»™å®šçš„langæ˜¯å¦æ”¯æŒã€‚</p>

<p>å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®ï¼Œè¯·å‚é˜…acceptsé™„åŠ æ–‡æ¡£ã€‚</p>

<h3 id="reqistype">req.is(type)</h3>

<p>æ£€æŸ¥ä¼ å…¥è¯·æ±‚å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«äº†â€Content-Typeâ€å¤´å­—æ®µï¼Œå¹¶ä¸”ç»™å‡ºåŒ¹é…çš„mineç±»å‹ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// With Content-Type: text/html; charset=utf-8
req.is('html');
req.is('text/html');
req.is('text/*');
// =&gt; true

// When Content-Type is application/json
req.is('json');
req.is('application/json');
req.is('application/*');
// =&gt; true

req.is('html');
// =&gt; false
</code></pre></div></div>

<p>å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®ï¼Œè¯·å‚é˜…type-isé™„åŠ æ–‡æ¡£ã€‚</p>

<h3 id="reqip">req.ip</h3>

<p>è¿”å›è¿œç¨‹åœ°å€ï¼Œæˆ–è€…å½“ä¿¡ä»»ä»£ç†å·²å¯ç”¨æ—¶è¿”å›ä»£ç†åœ°å€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>req.ip
// =&gt; "127.0.0.1" ### req.ips
</code></pre></div></div>

<p>å½“ä¿¡ä»»ä»£ç†ä¸ºtrueæ—¶ï¼Œè§£æâ€X-Forwarded-Forâ€ipåœ°å€åˆ—è¡¨è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªç©ºæ•°ç»„ã€‚ä¾‹å¦‚å½“å€¼ä¸ºâ€client, proxy1, proxy2â€æ—¶ä½ ä¼šè·å¾—[â€œclientâ€, â€œproxy1â€, â€œproxy2â€]æ•°ç»„ï¼Œå…¶ä¸­â€proxy2â€æ˜¯æœ€è¿œçš„ä¸‹æ¸¸åœ°å€ã€‚</p>

<h3 id="reqpath">req.path</h3>
<p>è¿”å›è¯·æ±‚çš„URLè·¯å¾„åã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// example.com/users?sort=desc
req.path
// =&gt; "/users" ### req.host Returns the hostname from the "Host" header field (void of portno).
</code></pre></div></div>

<p>è¿”å›ä»â€Hostâ€å¤´å­—æ®µå†…å–å‡ºçš„ä¸»æœºå(ä¸åŒ…å«ç«¯å£)ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Host: "example.com:3000"
req.host
// =&gt; "example.com" ### req.fresh
</code></pre></div></div>

<p>æ£€æŸ¥è¯·æ±‚æ˜¯å¦åˆ·æ–°ï¼Œé€šè¿‡å¯¹Last-Modifiedå’Œ/æˆ–ETagè¿›è¡ŒåŒ¹é…ï¼Œè¡¨æ˜èµ„æºæ˜¯ä¸æ˜¯æœ€æ–°çš„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>req.fresh
// =&gt; true å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®ï¼Œè¯·å‚é˜…freshé™„åŠ æ–‡æ¡£ã€‚
</code></pre></div></div>

<h3 id="reqstale">req.stale</h3>

<p>æ£€æŸ¥è¯·æ±‚æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœLast-Modifiedå’Œ/æˆ–ETagä¸åŒ¹é…ï¼Œè¡¨æœ‰èµ„æºæ˜¯è¿‡æœŸçš„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>req.stale
// =&gt; true ### req.xhr
</code></pre></div></div>

<p>æ£€æŸ¥è¯·æ±‚å¤´é‡Œæ˜¯å¦åŒ…å«â€X-Requested-Withâ€å­—æ®µå¹¶ä¸”å€¼ä¸ºâ€XMLHttpRequestâ€(jQueryç­‰)ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>req.xhr
// =&gt; true ### req.protocol å½“ä½¿ç”¨TLSè¯·æ±‚æ—¶è¿”å›"http"æˆ–"https"åè®®å­—ç¬¦ä¸²ã€‚å½“ä¿¡ä»»è·¯ç”±è®¾ç½®ä¸ºå¼€å¯æ—¶"X-Forwarded-Proto"å¤´å­—æ®µå°†è¢«ä¿¡ä»»ã€‚å¦‚æœä½ æ­£åœ¨è¿è¡Œä¸€ä¸ªæ”¯æŒhttpsåè®®çš„åå‘ä»£ç†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ˜¯æ”¯æŒçš„ã€‚


req.protocol
// =&gt; "http" ### req.secure
</code></pre></div></div>

<p>æ£€æŸ¥TLSè¿æ¥æ˜¯å¦å»ºç«‹ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å†™ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'https' == req.protocol; ### req.subdomains Return subdomains as an array. è¿”å›å­åŸŸæ•°ç»„ã€‚

// Host: "tobi.ferrets.example.com"
req.subdomains
// =&gt; ["ferrets", "tobi"] ### req.originalUrl
</code></pre></div></div>

<p>æ­¤å±æ€§å¾ˆåƒreq.urlï¼Œä½†å®ƒä¿ç•™äº†åŸå§‹è¯·æ±‚çš„urlï¼Œå…è®¸ä½ åœ¨åšå†…éƒ¨è·¯ç”±æ—¶è‡ªç”±é‡å†™req.urlã€‚ä¾‹å¦‚app.use()ä¸­é—´ä»¶å°†é‡å†™req.urlé‡æ–°å®šä¹‰æŒ‚è½½ç‚¹ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// GET /search?q=something
req.originalUrl
// =&gt; "/search?q=something"
</code></pre></div></div>
:ET