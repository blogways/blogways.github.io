I"'à<table>
  <thead>
    <tr>
      <th>Â </th>
      <th><em>ç›® å½•</em></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td><a href="#link1">Esperç®€ä»‹</a></td>
    </tr>
    <tr>
      <td>2</td>
      <td><a href="#link2">äº‹ä»¶ç±»å‹</a></td>
    </tr>
    <tr>
      <td>3</td>
      <td><a href="#link3">å¤„ç†æ¨¡å‹</a></td>
    </tr>
    <tr>
      <td>4</td>
      <td><a href="#link4">æœªå®Œå¾…ç»­â€¦</a></td>
    </tr>
  </tbody>
</table>

<p><a id="link1"></a></p>
<style>
.red { color: red; }
.blue { color: blue; }
</style>

<p><a id="link1"></a></p>

<h2 id="ä¸€esperç®€ä»‹">ä¸€ã€Esperç®€ä»‹</h2>
<p>å°†<code class="language-plaintext highlighter-rouge">Espser</code>ä¹‹å‰ï¼Œé¦–å…ˆè¦è®²<code class="language-plaintext highlighter-rouge">CEP</code>ï¼Œæ˜¯ä¸€ç§å®æ—¶äº‹ä»¶å¤„ç†å¹¶ä»å¤§é‡äº‹ä»¶æ•°æ®æµä¸­æŒ–æ˜å¤æ‚æ¨¡å¼çš„æŠ€æœ¯ï¼Œå…¨ç§°ä¸ºComplex Event Processingï¼Œå³å¤æ‚äº‹ä»¶å¤„ç†ã€‚<code class="language-plaintext highlighter-rouge">CEP</code>æ˜¯ä¸€ç§æ ‡å‡†ï¼Œ<code class="language-plaintext highlighter-rouge">Esper</code>åªæ˜¯å¯¹è¿™ä¸ªæ ‡å‡†çš„ä¸€ç§å¼€æºå®ç°ã€‚</p>

<p>å¬èµ·æ¥å¥½åƒå¾ˆå¤æ‚ï¼Œå®é™…ä¸Šå°±æ˜¯åŸºäºäº‹ä»¶æµè¿›è¡Œæ•°æ®å¤„ç†ï¼ŒæŠŠè¦åˆ†æçš„æ•°æ®æŠ½è±¡æˆäº‹ä»¶ï¼Œç„¶åå°†æ•°æ®å‘é€åˆ°<code class="language-plaintext highlighter-rouge">CEP</code>å¼•æ“ï¼Œå¼•æ“å°±ä¼šæ ¹æ®äº‹ä»¶çš„è¾“å…¥å’Œæœ€åˆæ³¨å†Œçš„å¤„ç†æ¨¡å‹ï¼Œå¾—åˆ°äº‹ä»¶å¤„ç†ç»“æœã€‚</p>

<p><code class="language-plaintext highlighter-rouge">CEP</code>çš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹å°±æ˜¯ä»–æ˜¯ä¸€ä¸ª<i class="red">å†…å­˜è®¡ç®—</i>å·¥å…·å’Œ<i class="red">ç±»SQL</i>è¯­å¥ã€‚</p>

<p>æœ‰æœ‹å‹å¯èƒ½ä¼šæƒ³åˆ°ç›®å‰å¾ˆæµè¡Œçš„ä¸€ä¸ªå®æ—¶è®¡ç®—æ¡†æ¶â€”â€”<code class="language-plaintext highlighter-rouge">Storm</code>ï¼Œä½†è¿™ä¸¤ä¸ªå®Œå…¨ä¸æ˜¯ä¸€ç±»ä¸œè¥¿ã€‚<code class="language-plaintext highlighter-rouge">Esper</code>çš„ç‰¹ç‚¹åœ¨äºå®ƒçš„å¤æ‚å¤„ç†é€»è¾‘å¯ä»¥ç”¨ç±»SQLè¯­å¥ï¼ˆEPLï¼‰å¼€å‘ï¼Œè€Œ<code class="language-plaintext highlighter-rouge">Storm</code>çš„ç‰¹ç‚¹åœ¨äº<strong><em>å¹¶è¡Œè®¡ç®—</em></strong>å’Œ<strong><em>å¿«é€Ÿæ¢å¤</em></strong>ï¼Œä½†æ˜¯è®¡ç®—é€»è¾‘æ˜¯éœ€è¦è‡ªå·±ç”¨ä»£ç å®ç°çš„ã€‚</p>

<p>å‰é¢è¯´äº†ï¼Œ<code class="language-plaintext highlighter-rouge">Esper</code>ï¼Œæ˜¯<code class="language-plaintext highlighter-rouge">CEP</code>çš„ä¸€ä¸ªå¼€æºå®ç°ï¼Œå®ƒæ˜¯ä¸€ä¸ªJavaçš„äº‹ä»¶æµå¤„ç†å’Œå¤æ‚äº‹ä»¶å¤„ç†çš„å¼•æ“ï¼ˆ.NETä¸ºNEsperï¼‰ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">Esper</code>å¼•æ“å¯åº”ç”¨äºå¦‚ä¸‹ç­‰é¢†åŸŸï¼š</p>

<ul>
  <li>ç½‘ç»œå…¥ä¾µæ¢æµ‹</li>
  <li>SLAç›‘æµ‹</li>
  <li>RFIDè¯»å–</li>
  <li>èˆªç©ºè¿è¾“è°ƒæ§</li>
  <li>é‡‘èæ–¹é¢(é£é™©ç®¡ç†ï¼Œæ¬ºè¯ˆæ¢æµ‹)ç­‰</li>
</ul>

<p>å…¶ç‰¹ç‚¹æ˜¯èƒ½å¤Ÿå¿«é€Ÿå¼€å‘å‡ºå¤æ‚çš„å®æ—¶è®¡ç®—ç­–ç•¥ï¼Œå¹¶ä¸”æœ‰ç€é«˜ååé‡ä»¥åŠä½å»¶è¿Ÿçš„ç‰¹ç‚¹ï¼Œç‰¹åˆ«é€‚åˆ<i class="red">å¤§é‡æ•°æ®çš„å®æ—¶è®¡ç®—</i>ã€‚</p>

<p><i class="red"><strong>æ³¨æ„</strong>ï¼š</i></p>

<ul>
  <li>åç»­æ‰€æœ‰æµ‹è¯•ä¾‹å­ä¸­çš„<code class="language-plaintext highlighter-rouge">Java Bean</code>éƒ½æ²¡æœ‰å†™å‡º<code class="language-plaintext highlighter-rouge">getter</code>ï¼Œ<code class="language-plaintext highlighter-rouge">setter</code>ï¼Œ<code class="language-plaintext highlighter-rouge">toString</code>ï¼Œå¦‚æœ‰éœ€è¦è¯·è‡ªè¡Œæ·»åŠ ã€‚</li>
</ul>

<h3 id="11-epl-ç®€è¿°">1.1 EPL ç®€è¿°</h3>
<p><code class="language-plaintext highlighter-rouge">EPL</code>ï¼Œå³Event Proess Languageï¼Œ<code class="language-plaintext highlighter-rouge">CEP</code>çš„ç±»SQLè¯­å¥ï¼Œå¯ä»¥ç†è§£ä¸ºå¤„ç†æ¨¡å‹çš„å®šä¹‰ä¸æè¿°ã€‚</p>

<p>è¿™æ˜¯è¿è¡Œåœ¨<code class="language-plaintext highlighter-rouge">CEP</code>å¼•æ“ä¸­çš„ç‰¹æ®Šè¯­å¥ï¼Œä¹‹æ‰€ä»¥å«ä»–ç±»SQLï¼Œæ˜¯å› ä¸ºå®ƒå’ŒSQLç¡®å®å¾ˆåƒï¼Œé™¤äº†<code class="language-plaintext highlighter-rouge">select</code>ï¼Œ<code class="language-plaintext highlighter-rouge">insert</code>ï¼Œ<code class="language-plaintext highlighter-rouge">delete</code>ï¼Œ<code class="language-plaintext highlighter-rouge">update</code>ï¼Œè€Œä¸”ä¹Ÿæœ‰<code class="language-plaintext highlighter-rouge">avg</code>ï¼Œ<code class="language-plaintext highlighter-rouge">count</code>ç­‰å‡½æ•°ã€‚æ‰€ä»¥å¯¹äºä¼šSQLçš„äººæ¥è¯´ï¼Œä»–çš„è¯­æ³•ç»“æ„å¤§è‡´è¿˜æ˜¯èƒ½çŒœå‡ºä¸€äºŒçš„ã€‚</p>

<p>å·¥ä½œæ¨¡å¼æœ‰ç‚¹ç±»ä¼¼äºä¸€ä¸ªæ•°æ®åº“çš„ <i class="red"><strong>å€’ç½®</strong></i>ï¼Œå®ƒå…è®¸åº”ç”¨ç¨‹åºå­˜å‚¨æŸ¥è¯¢å¹¶è®©æ•°æ®é€šè¿‡ï¼Œè€Œä¸æ˜¯å­˜å‚¨æ•°æ®å¹¶åœ¨å­˜å‚¨çš„æ•°æ®ä¸Šè¿è¡ŒæŸ¥è¯¢è¯­å¥ï¼ˆåº”ç”¨ç¨‹åºå­˜å‚¨æŸ¥è¯¢ï¼Œå¹¶è®©æ•°æ®è¿è¡Œé€šè¿‡ï¼‰ã€‚å½“åŒ¹é…æŸ¥è¯¢çš„æ¡ä»¶æ—¶ï¼Œå“åº”é€»è¾‘è§¦å‘ã€‚</p>

<p>æ•°æ®åº“æ˜¯å…ˆå­˜å‚¨æ•°æ®ï¼Œé€šè¿‡ç¼–è¯‘è§£æSQLï¼Œå®Œæˆå·²å­˜å‚¨æ•°æ®çš„æŸ¥è¯¢ï¼ŒEsperåˆ™æ˜¯å…ˆç¼–è¯‘EPLè¯­å¥ï¼Œå½¢æˆä¸€ä¸ªè¿‡æ»¤ï¼ˆæˆ–å¤„ç†ï¼‰å±‚ï¼ˆæˆ–è€…ç½‘ï¼‰ï¼Œå®æ—¶è¿‡æ¥çš„æ•°æ®ï¼Œé€šè¿‡è¿™ä¸ªè¿‡æ»¤å±‚å®Œæˆæœ‰æ•ˆäº‹ä»¶çš„ç­›é€‰æˆ–å½¢æˆæœ‰æ•ˆäº‹ä»¶ã€‚</p>

<p>å¦‚ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select * from Apple
select avg(price) from Apple.win:length_batch(3)
</code></pre></div></div>

<p>æµ‹è¯•ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * Created by wanzhou on 16/8/1.
 */
import com.espertech.esper.client.*;

class Apple
{
  private int id;
  private int price;
}

class AppleListener implements UpdateListener
{

  public void update(EventBean[] newEvents, EventBean[] oldEvents)
  {
    if (newEvents != null)
    {
//      Double avg = (Double) newEvents[0].get("avg(price)");
//      System.out.println("Apple's average price is " + avg);
      for (int i = 0; i &lt; newEvents.length; i++) {
        System.out.println(newEvents[i].getUnderlying());
      }
    }
  }

}

public class AverageTest {
  public static void main(String[] args) throws InterruptedException {
    EPServiceProvider epService = EPServiceProviderManager.getDefaultProvider();

    EPAdministrator admin = epService.getEPAdministrator();

    EPRuntime runtime = epService.getEPRuntime();

    String product = Apple.class.getName();
    String epl = "select avg(price) from " + product + ".win:length_batch(2)";
	// String epl = "select * from Apple.win:length_batch(2)";

    EPStatement state = admin.createEPL(epl);
    state.addListener(new AppleListener());


    Apple apple1 = new Apple();
    apple1.setId(1);
    apple1.setPrice(5);
    runtime.sendEvent(apple1);

    Apple apple2 = new Apple();
    apple2.setId(2);
    apple2.setPrice(2);
    runtime.sendEvent(apple2);

    Apple apple3 = new Apple();
    apple3.setId(3);
    apple3.setPrice(5);
    runtime.sendEvent(apple3);

    Apple apple4 = new Apple();
    apple4.setId(4);
    apple4.setPrice(6);
    runtime.sendEvent(apple4);

    Apple apple5 = new Apple();
    apple5.setId(5);
    apple5.setPrice(7);
    runtime.sendEvent(apple5);
  }
}
</code></pre></div></div>

<h3 id="12-äº‹ä»¶ç±»å‹">1.2 äº‹ä»¶ç±»å‹</h3>
<p><code class="language-plaintext highlighter-rouge">Esper</code> å¯¹å¤„ç†çš„æ•°æ®ç»“æ„æœ‰æ˜ç¡®çš„è¦æ±‚ï¼Œèƒ½å¤„ç†çš„æ•°æ®ç»“æ„ï¼š</p>

<ul>
  <li>POJO ( java.lang.Object )</li>
  <li>java.util.Map</li>
  <li>Object[]</li>
  <li>XML</li>
</ul>

<p>ç‰¹ç‚¹ï¼š</p>

<ul>
  <li>æ”¯æŒnestedã€indexedã€mappedå±æ€§ï¼ˆåµŒå¥—æ²¡æœ‰å±‚æ•°é™åˆ¶ï¼‰</li>
  <li>éœ€è¦å‘ŠçŸ¥å¼•æ“ç±»å‹å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬åµŒå¥—çš„æ•°æ®ã€‚</li>
  <li>èƒ½æ”¹å˜å±æ€§é¡ºåºï¼Œæˆ–æŠ½å–éƒ¨åˆ†å±æ€§åˆ°ä¸€ä¸ªæ–°çš„äº‹ä»¶ã€‚</li>
  <li>Objectã€Map å’Œ Object[] ç±»å‹æ”¯æŒè¶…ç±»( Supertype )</li>
</ul>

<h3 id="13-äº‹ä»¶å±æ€§">1.3 äº‹ä»¶å±æ€§</h3>
<p>| <strong><em>ç±»å‹</em></strong>|  <strong><em>è¯´æ˜</em></strong> | <strong><em>è¯­æ³•</em></strong> | <strong><em>å®ä¾‹</em></strong>|
| â€” | â€” | â€” | â€” |
| Simple | åªåŒ…å«å•ä¸ªå€¼å¾—å±æ€§ | name | price |
| Indexed | ç´¢å¼• | name[index] | price[0] |
| Mapped | mapå±æ€§ | name[â€˜keyâ€™] | apple(â€˜priceâ€™) |
| nested | å±æ€§åµŒå¥— | name.nestedname | apple.price|</p>

<p>ç»„åˆä¸Šè¿°æ‰€æœ‰çš„å±æ€§ï¼Œå¦‚ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>person.address(â€˜homeâ€™).street[0]
</code></pre></div></div>

<ul>
  <li>
    <p>äº‹ä»¶å±æ€§ç¤ºä¾‹</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  public class MyEventType {
  String myMapKey;
  int myIndexValue;
  int myInnerIndexValue;
  Map&lt;String, InnerType&gt; innerTypesMap; // mapped property
  InnerType[] innerTypesArray; // indexed property
  }
  public class InnerType {
  String name;
  int[] ids;
  }
	
  select innerTypesMap('somekey').ids[1],
  // innerTypesMap(myMapKey).getIds(myIndexValue),
  innerTypesArray[1].ids[2],
  // innerTypesArray(myIndexValue).getIds(myInnerIndexValue)
  from MyEventType
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="14-åŠ¨æ€äº‹ä»¶å±æ€§">1.4 åŠ¨æ€äº‹ä»¶å±æ€§</h3>
<p>| <strong><em>ç±»å‹</em></strong> | <strong><em>è¯­æ³•</em></strong> |
| â€” | â€” |
| Dynamic Simple | name? |
| Dynamic Indexed | name[index]? |
| Dynamic Mapped | name(â€˜keyâ€™)? |
| Dynamic Nested | name?.nestedname |</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select timestamp? from OrderEvent

select detail?.driection from OrderEvent
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">OrderEvent</code> æ‹¥æœ‰å¤šä¸ªæ¥å£ç±»ï¼Œå…¶ä¸­æŸä¸ªæˆ–æŸäº›æœ‰<code class="language-plaintext highlighter-rouge">timestamp</code>å±æ€§ï¼Œåˆ™å…¶åŠ¨æ€å±æ€§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select timestamp? from OrderEvent
</code></pre></div></div>

<p>å¦‚æœåŠ¨æ€å±æ€§æ˜¯åµŒå¥—å±æ€§ï¼Œåˆ™</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select detail?.driection from OrderEvent ç­‰ä»·äº

select detail?.direction? from OrderEvent
</code></pre></div></div>

<ul>
  <li>
    <p>ç¤ºä¾‹</p>

    <p>åŠ¨æ€å±æ€§è¿”å›å€¼æ€»æ˜¯ <code class="language-plaintext highlighter-rouge">java.lang.Object</code> ç±»å‹ï¼Œåœ¨äº‹ä»¶è¿›ç¨‹è¿è¡Œæ—¶ï¼ŒåŠ¨æ€å±æ€§ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› <code class="language-plaintext highlighter-rouge">null</code>ã€‚</p>

    <p>å¦‚ï¼šäº‹ä»¶<code class="language-plaintext highlighter-rouge">OrderEvent</code>æ‹¥æœ‰ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">item</code>å±æ€§ï¼Œé€šè¿‡åŠ¨æ€å±æ€§æŒ‡å®šä¸€ä¸ªæŸ¥è¯¢æ¥å–å¾—<code class="language-plaintext highlighter-rouge">Service</code>æˆ–<code class="language-plaintext highlighter-rouge">Product</code>çš„ä»·æ ¼ï¼Œå¦‚ï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select item.price? from OrderEvent
</code></pre></div>    </div>

    <p>å¦‚æœ<code class="language-plaintext highlighter-rouge">OrderEvent</code> æ‹¥æœ‰å¤šä¸ªæ¥å£ç±»ï¼Œå…¶ä¸­æŸä¸ªæˆ–æŸäº›æœ‰<code class="language-plaintext highlighter-rouge">timestamp</code>å±æ€§ï¼Œåˆ™å…¶åŠ¨æ€å±æ€§ï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select timestamp? from OrderEvent
</code></pre></div>    </div>

    <p>å¦‚æœåŠ¨æ€å±æ€§æ˜¯åµŒå¥—å±æ€§ï¼Œåˆ™åŠ¨æ€å±æ€§ä¸‹çš„æ‰€æœ‰åµŒå¥—å±æ€§éƒ½ä¸ºåŠ¨æ€å±æ€§ï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select detail?.driection from OrderEvent   ç­‰ä»·äº

  select detail?.direction? from OrderEvent
</code></pre></div>    </div>
  </li>
  <li>
    <p>æµ‹è¯•ä»£ç </p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  class OrderEvent {
    Object item;
  }
	
  class Serivce {
    String name;
    int price;
  }
	
  class Product {
    String name;
    int price;
    String info;
  }
	
  class DynamicListener implements UpdateListener
  {
	
    public void update(EventBean[] newEvents, EventBean[] oldEvents)
    {
      if (newEvents != null)
      {
  //      Double avg = (Double) newEvents[0].get("item.price?");
  //      System.out.println("Apple's average price is " + avg);
        for (int i = 0; i &lt; newEvents.length; i++) {
          System.out.println(newEvents[i].getUnderlying());
        }
      }
    }
	
  }
	
  public class DynamicProps {
    public static void main(String[] args) throws InterruptedException {
      EPServiceProvider epService = EPServiceProviderManager.getDefaultProvider();
	
      EPAdministrator admin = epService.getEPAdministrator();
	
      String epl = "select item.info? from OrderEvent";
	
      EPStatement state = admin.createEPL(epl);
      state.addListener(new AppleListener());
	
      EPRuntime runtime = epService.getEPRuntime();
	
      Product product = new Product();
      product.setName("pdt1");
      product.setPrice(5);
      product.setInfo("Product Info.");
	
      OrderEvent oe1 = new OrderEvent();
      oe1.setItem(product);
      runtime.sendEvent(oe1);
	
      Serivce svr = new Serivce();
      svr.setName("svr");
      svr.setPrice(10);
	
      OrderEvent oe2 = new OrderEvent();
      oe2.setItem(svr);
      runtime.sendEvent(oe2);
    }
  }
</code></pre></div>    </div>
  </li>
</ul>

<p><a id="link2"></a></p>

<h2 id="äºŒäº‹ä»¶ç±»å‹">äºŒã€äº‹ä»¶ç±»å‹</h2>

<h3 id="21-pojojavalangobject">2.1 POJOï¼ˆ<code class="language-plaintext highlighter-rouge">java.lang.Object</code>ï¼‰</h3>

<p>å¯¹äºPOJOï¼Œ<code class="language-plaintext highlighter-rouge">Esper</code>è¦æ±‚å¯¹æ¯ä¸€ä¸ªç§æœ‰å±æ€§è¦æœ‰<code class="language-plaintext highlighter-rouge">getter</code>æ–¹æ³•ã€‚<code class="language-plaintext highlighter-rouge">Esper</code>å…è®¸ä¸å¿…æŒ‰ç…§<code class="language-plaintext highlighter-rouge">JavaBean</code>è§„å®šçš„æ ¼å¼ï¼Œä½†æ˜¯<code class="language-plaintext highlighter-rouge">getter</code>æ–¹æ³•æ˜¯å¿…é¡»çš„ã€‚åˆæˆ–è€…å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®å¯è®¿é—®çš„æ–¹æ³•æ¥ä»£æ›¿<code class="language-plaintext highlighter-rouge">getter</code>ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class Person  
{  
    String name;  
    int age;  
    public String getName()  
    {  
        return name;  
    }  
    public int getAge()  
    {  
        return age;  
    }  
} 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Esper</code>å¯¹POJOçš„æ”¯æŒåŸºæœ¬ä¸Šå°±æ˜¯ä¸Šé¢æ‰€è¯´çš„ï¼Œå¦å¤–ä»–è¿˜æ”¯æŒå®ç°äº†å¤šä¸ªæ¥å£ç±»æˆ–è€…æŠ½è±¡ç±»çš„POJOï¼Œä½¿ç”¨æ–¹æ³•å’Œæ™®é€šçš„POJOæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œè¿™é‡Œå°±ä¸åˆ—ä¸¾äº†ã€‚</p>

<p>å½“<code class="language-plaintext highlighter-rouge">Person</code>çš„nameå±æ€§ä¸ºtestæ—¶ï¼Œå¾—åˆ°å¯¹åº”çš„age,æ‰€æœ‰childrenå’Œaddress.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select age,children,address from Person where name="test"  å½“Personçš„nameå±æ€§ä¸ºtestæ—¶ï¼Œå¾—åˆ°å¯¹åº”çš„ç¬¬äºŒä¸ªå­©å­,å®¶é‡Œçš„ç”µè¯å’Œå®¶åº­ä½å€åœ¨å“ªæ¡è·¯ä¸Š  

select children[1], phones('home'), address.road from Person where name="testâ€
public Child getChildren(int index) { // è¿”å›å¯¹åº”ä¸‹æ ‡çš„childrenä¿¡æ¯
	return children.get(index);
}
</code></pre></div></div>

<p>å½“<code class="language-plaintext highlighter-rouge">Person</code>çš„nameå±æ€§ä¸ºtestæ—¶ï¼Œæ›´æ–°å®¶é‡Œçš„ç”µè¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>update Person set phones('home') = 123456789 where name="test" 
public void setPhones(String name, Integer number) {  
   phones.put(name, number); // ç”¨äº phones å±æ€§çš„æ›´æ–°
} 
</code></pre></div></div>

<ul>
  <li>
    <p>PojoPersonTest æµ‹è¯•ç¤ºä¾‹ï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  class PojoPerson implements Serializable {
    String pname;
    int age;
    List&lt;Child&gt; children;
    Map&lt;String, Integer&gt; phones;
    Address address;
	
    public String getPname() {
      return pname;
    }
	
    public void setPname(String pname) {
      this.pname = pname;
    }
	
    public int getAge() {
      return age;
    }
	
    public void setAge(int age) {
      this.age = age;
    }
	
    public List&lt;Child&gt; getChildren() {
      return children;
    }
	
    public Child getChildren(int index) {
      return children.get(index);
    }
	
    public void setChildren(List&lt;Child&gt; children) {
      this.children = children;
    }
	
    public Map&lt;String, Integer&gt; getPhones() {
      return phones;
    }
	
    public void setPhones(Map&lt;String, Integer&gt; phones) {
      this.phones = phones;
    }
	
    public void setPhones(String name, Integer number) {
      System.out.println("=======");
      phones.put(name, number);
    }
	
    public Address getAddress() {
      return address;
    }
	
    public void setAddress(Address address) {
      this.address = address;
    }
	
    @Override
    public String toString() {
      return "PojoPerson{" +
          "name='" + pname + '\'' +
          ", age=" + age +
          ", children=" + children +
          ", phones=" + phones +
          ", address=" + address +
          '}';
    }
  }
	
  class Child
  {
    String cname;
    int gender;
	
    public String getCname() {
      return cname;
    }
	
    public void setCname(String cname) {
      this.cname = cname;
    }
	
    public int getGender() {
      return gender;
    }
	
    @Override
    public String toString() {
      return "Child{" +
          "name='" + cname + '\'' +
          ", gender=" + gender +
          '}';
    }
	
    public void setGender(int gender) {
      this.gender = gender;
    }
  }
	
  class Address
  {
    String road;
    String street;
    int houseNo;
	
    public String getRoad() {
      return road;
    }
	
    public void setRoad(String road) {
      this.road = road;
    }
	
    public String getStreet() {
      return street;
    }
	
    public void setStreet(String street) {
      this.street = street;
    }
	
    public int getHouseNo() {
      return houseNo;
    }
	
    public void setHouseNo(int houseNo) {
      this.houseNo = houseNo;
    }
	
    @Override
    public String toString() {
      return "Address{" +
          "road='" + road + '\'' +
          ", street='" + street + '\'' +
          ", houseNo=" + houseNo +
          '}';
    }
  }
	
	
  public class PojoPersonTest {
    public static void main(String[] args) {
	
      EPServiceProvider epService = EPServiceProviderManager.getDefaultProvider();
      EPAdministrator admin = epService.getEPAdministrator();
      EPRuntime runtime = epService.getEPRuntime();
	
      String qry1 = "select age,children,address from PojoPerson where pname = \"å¼ ä¸‰\"";
      String qry2 = "select children[1], phones('home'), address.road from PojoPerson where pname=\"æå››\"";
      String qry = "select * from PojoPerson";
	
      EPStatement state1 = admin.createEPL(qry1);
      state1.addListener(new UpdateListener() {
        public void update(EventBean[] newEvents, EventBean[] oldEvents) {
          if (null != newEvents) {
            System.out.print("qry1=====  ");
            System.out.println(newEvents[0].getUnderlying());
          }
        }
      });
	
      EPStatement state2 = admin.createEPL(qry2);
      state2.addListener(new UpdateListener() {
        public void update(EventBean[] newEvents, EventBean[] oldEvents) {
          if (null != newEvents) {
            System.out.print("qry2+++++  ");
            System.out.println(newEvents[0].getUnderlying());
          }
        }
      });
	
	
      EPStatement state = admin.createEPL(qry);
      state.addListener(new UpdateListener() {
        public void update(EventBean[] newEvents, EventBean[] oldEvents) {
          if (null != newEvents) {
            System.out.print("qry----  ");
            for (int i = 0; i &lt; newEvents.length; i++) {
              System.out.println(newEvents[i].getUnderlying());
            }
          }
        }
      });
	
      PojoPerson pp1 = new PojoPerson();
      Address a1 = new Address();
      a1.setHouseNo(100);
      a1.setRoad("Address 1");
      a1.setStreet("Street 1");
      pp1.setAddress(a1);
      pp1.setPname("å¼ ä¸‰");
      pp1.setAge(30);
      Map&lt;String, Integer&gt; p1 = new HashMap&lt;String, Integer&gt;();
      p1.put("home", 1333333333);
      p1.put("work", 1333333334);
      pp1.setPhones(p1);
      List&lt;Child&gt; lc1 = new ArrayList&lt;Child&gt;();
      Child ch1 = new Child();
      ch1.setCname("å¼ å››");
      ch1.setGender(1);
      lc1.add(ch1);
      pp1.setChildren(lc1);
      runtime.sendEvent(pp1);
	
      PojoPerson pp2 = new PojoPerson();
      Address a2 = new Address();
      a2.setHouseNo(100);
      a2.setRoad("Address 1");
      a2.setStreet("Street 1");
      pp2.setAddress(a2);
      pp2.setPname("æå››");
      pp2.setAge(30);
      Map&lt;String, Integer&gt; p2 = new HashMap&lt;String, Integer&gt;();
      p2.put("home", 1444444444);
      p2.put("work", 1444444445);
      pp2.setPhones(p2);
      List&lt;Child&gt; lc2 = new ArrayList&lt;Child&gt;();
      Child ch21 = new Child();
      ch21.setCname("æäº”");
      ch21.setGender(1);
      lc2.add(ch21);
      Child ch22 = new Child();
      ch22.setCname("æå…­");
      ch22.setGender(0);
      lc2.add(ch22);
      pp2.setChildren(lc2);
      runtime.sendEvent(pp2);
	
      PojoPerson pp3 = new PojoPerson();
      Address a3 = new Address();
      a3.setHouseNo(100);
      a3.setRoad("Address 1");
      a3.setStreet("Street 1");
      pp3.setAddress(a3);
      pp3.setPname("test");
      pp3.setAge(30);
      Map&lt;String, Integer&gt; p3 = new HashMap&lt;String, Integer&gt;();
      p3.put("home", 1555555555);
      p3.put("work", 1555555556);
      pp3.setPhones(p3);
      List&lt;Child&gt; lc3 = new ArrayList&lt;Child&gt;();
      Child ch31 = new Child();
      ch31.setCname("ç‹å…­");
      ch31.setGender(1);
      lc3.add(ch31);
      pp3.setChildren(lc3);
	
      runtime.sendEvent(pp3);
    }
  }
</code></pre></div>    </div>
  </li>
  <li>
    <p>UpdateTest æµ‹è¯•ä»£ç </p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  public class UpdateTest {
    public static void main(String[] args) {
	
      EPServiceProvider epService = EPServiceProviderManager.getDefaultProvider();
      EPAdministrator admin = epService.getEPAdministrator();
      EPRuntime runtime = epService.getEPRuntime();
	
      String ctr = "create window UPerson.win:keepall() as Person";
      String update = "on Person as p1 update UPerson as p2 set p2.age = 40 where p2.name = 'test'";
  //    String update = "update Person set age = 40 where name = 'test'";
      String qry = "select * from Person";
	
	
      admin.createEPL(ctr);
      admin.createEPL("insert into UPerson select * from Person");
      EPStatement state3 = admin.createEPL(update);
      state3.addListener(new UpdateListener() {
        public void update(EventBean[] newEvents, EventBean[] oldEvents) {
          if (null != newEvents) {
            System.out.print("update==&gt;  ");
            for (int i = 0; i &lt; newEvents.length; i++) {
              System.out.println(newEvents[i].getUnderlying());
            }
          }
        }
      });
	
      EPStatement state = admin.createEPL(qry);
      state.addListener(new UpdateListener() {
        public void update(EventBean[] newEvents, EventBean[] oldEvents) {
          if (null != newEvents) {
            System.out.print("qry==&gt;  ");
            for (int i = 0; i &lt; newEvents.length; i++) {
              System.out.println(newEvents[i].getUnderlying());
            }
          }
        }
      });
	
      Person p1 = new Person();
      p1.setName("test");
      p1.setAge(22);
      runtime.sendEvent(p1);
	
      Person p2 = new Person();
      p2.setName("test2");
      p2.setAge(23);
      runtime.sendEvent(p2);
		
    }
  }
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="22-javautilmap">2.2 <code class="language-plaintext highlighter-rouge">java.util.Map</code></h3>
<p><code class="language-plaintext highlighter-rouge">Esper</code>æ”¯æŒåŸç”Ÿ<code class="language-plaintext highlighter-rouge">Java Map</code>ç»“æ„çš„äº‹ä»¶ã€‚ç›¸å¯¹äºPOJOæ¥è¯´ï¼Œ<code class="language-plaintext highlighter-rouge">Map</code>çš„ç»“æ„æ›´åˆ©äºäº‹ä»¶ç±»å‹çš„çƒ­åŠ è½½ï¼Œæ¯•ç«Ÿä¸æ˜¯<code class="language-plaintext highlighter-rouge">class</code>ï¼Œæ‰€ä»¥ä¸éœ€è¦é‡å¯JVMã€‚</p>

<p>æ‰€ä»¥å¦‚æœç³»ç»Ÿå¯¹é‡å¯æ¯”è¾ƒæ•æ„Ÿï¼Œå»ºè®®ä½¿ç”¨Mapæ¥å®šä¹‰äº‹ä»¶çš„ç»“æ„ã€‚<code class="language-plaintext highlighter-rouge">Map</code>çš„ç»“æ„å¾ˆç®€å•ï¼Œä¸»è¦åˆ†ä¸ºäº‹ä»¶å®šä¹‰åå’Œäº‹ä»¶å±æ€§åˆ—è¡¨ã€‚</p>

<p>é€šè¿‡ <code class="language-plaintext highlighter-rouge">sendEvent(Map map, String eventTypeName)</code> æ–¹æ³•å‘é€äº‹ä»¶ã€‚</p>

<p>å¯¹äº<code class="language-plaintext highlighter-rouge">Map</code>ï¼Œ<code class="language-plaintext highlighter-rouge">Esper</code>åªæ”¯æŒå¢é‡æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½å¢åŠ <code class="language-plaintext highlighter-rouge">Map</code>ä¸­çš„å±æ€§å®šä¹‰ï¼Œè€Œä¸èƒ½ä¿®æ”¹æˆ–è€…åˆ é™¤æŸä¸ªå±æ€§ã€‚</p>

<p>å®é™…ä¸Šå±æ€§å¢å¤šå¹¶ä¸å½±å“å…¶å¤„ç†æ€§èƒ½ï¼Œæ‰€ä»¥æ²¡æœ‰åˆ é™¤åœ¨æˆ‘çœ‹æ¥ä¹Ÿæ²¡ä»€ä¹ˆã€‚è‡³äºä¿®æ”¹ï¼Œä¹Ÿåªèƒ½æ˜¯å…ˆæ³¨é”€å†æ³¨å†Œäº†ã€‚</p>

<ul>
  <li>
    <p>å®šä¹‰</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  // Personå®šä¹‰  
  Map&lt;String,Object&gt; person = new HashMap&lt;String,Object&gt;();  
  person.put("name", String.class);  
  person.put("age", int.class);  
  person.put("children", List.class);  
  person.put("phones", Map.class);  
	          
  // æ³¨å†ŒPersonåˆ°Esper  
  admin.getConfiguration().addEventType("PersonEvent", person);
	
  select name, age, phones from PersonEvent.win:time(1 min) where age = 20 
</code></pre></div>    </div>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">java.util.Map</code>å‘é€</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Map&lt;String, Object&gt; p1 = new HashMap&lt;String, Object&gt;();
  p1.put("name", "test");
  p1.put("age", 20);
  List&lt;Person&gt; child = new ArrayList&lt;Person&gt;();
  p1.put("children", child);
	
  Map&lt;String, Object&gt; phones = new HashMap&lt;String, Object&gt;();
  phones.put("home", "051088744796");
  phones.put("self", "15051818371");
  p1.put("phones", phones);
	
  epService.getEPRuntime().sendEvent(p1, "PersonEvent");
	
  select name, age, phones from PersonEvent.win:time(1 min) where age = 20 

  {name=test, phones={self=15051818371, home=051088744796}, age=20}
</code></pre></div>    </div>
  </li>
  <li>
    <p>PersonMap ç¤ºä¾‹</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  class Person implements Serializable
  {
    String name;
    int age;
	
    public String getName() {
      return name;
    }
	
    public void setName(String name) {
      this.name = name;
    }
	
    public int getAge() {
      return age;
    }
	
    public void setAge(int age) {
      this.age = age;
    }
	
    @Override
    public String toString() {
      return "Person{" +
          "name='" + name + '\'' +
          ", age=" + age +
          '}';
    }
  }
	
  class PersonMapListener implements UpdateListener
  {
	
    public void update(EventBean[] newEvents, EventBean[] oldEvents)
    {
      if (newEvents != null)
      {
        for (int i = 0; i &lt; newEvents.length; i++) {
          System.out.println(newEvents[i].getUnderlying());
        }
      }
    }
	
  }
	
  public class PersonMap {
    public static void main(String[] args) throws InterruptedException {
      EPServiceProvider epService = EPServiceProviderManager.getDefaultProvider();
	
      EPAdministrator admin = epService.getEPAdministrator();
	
      // Person å®šä¹‰
      Map&lt;String, Object&gt; person = new HashMap&lt;String, Object&gt;();
      person.put("name", String.class);
      person.put("age", int.class);
      person.put("children", List.class);
      person.put("phones", Map.class);
	
      // æ³¨å†ŒPersonåˆ°Esper
      admin.getConfiguration().addEventType("PersonEvent", person);
	
      String epl = "select name, age, phones from PersonEvent.win:time(1 min) where age = 20";
      EPStatement state = admin.createEPL(epl);
      state.addListener(new PersonMapListener());
	
      EPRuntime runtime = epService.getEPRuntime();
	
      Map&lt;String, Object&gt; p1 = new HashMap&lt;String, Object&gt;();
      p1.put("name", "test");
      p1.put("age", 20);
	
      List&lt;Person&gt; child = new ArrayList&lt;Person&gt;();
      Person pc1 = new Person();
      pc1.setName("Child1");
      pc1.setAge(20);
      child.add(pc1);
      p1.put("children", child);
	
      Map&lt;String, Object&gt; phones = new HashMap&lt;String, Object&gt;();
      phones.put("home", "051088744796");
      phones.put("self", "15051818371");
      p1.put("phones", phones);
	
      runtime.sendEvent(p1, "PersonEvent");
	
      // æ–°å¢ä¸€ä¸ªgenderå±æ€§
  //    person.put("gender", int.class);
  //    admin.getConfiguration().updateMapEventType("PersonEvent", person);
    }
  }
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="221-javautilmapè¶…ç±»supertype">2.2.1 <code class="language-plaintext highlighter-rouge">java.util.Map</code>è¶…ç±»(Supertype)</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>epService.getEPAdministrator().getConfiguration().addEventType(
	"AccountUpdate", accountUpdateDef, new String[] {"BaseUpdate"}
);
</code></pre></div></div>

<p>å½“ç»§æ‰¿ä¹‹åï¼Œå¯¹è¶…ç±»è¿›è¡Œ<code class="language-plaintext highlighter-rouge">select</code>æ—¶ï¼Œä¸ç®¡æ˜¯å­ç±»ã€æˆ–è¶…ç±»äº‹ä»¶åˆ°è¾¾ï¼Œéƒ½ä¼šè¿›è¡ŒæŸ¥è¯¢è¾“å‡ºã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select * from BaseUpdate
</code></pre></div></div>

<p>æ¯ä¸ªMap äº‹ä»¶å¯ä»¥æœ‰å¤šä¸ªè¶…ç±»ï¼</p>

<h4 id="222-map-åµŒå¥—">2.2.2 Map åµŒå¥—</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Map&lt;String, Object&gt; updatedFieldDef = new HashMap&lt;String, Object&gt;();
updatedFieldDef.put("name", String.class);
updatedFieldDef.put("addressLine1", String.class);
updatedFieldDef.put("history", UpdateHistory.class);
epService.getEPAdministrator().getConfiguration().
addEventType("UpdatedFieldType", updatedFieldDef);

Map&lt;String, Object&gt; accountUpdateDef = new HashMap&lt;String, Object&gt;();
accountUpdateDef.put("accountId", long.class);
accountUpdateDef.put("fields", "UpdatedFieldType");	
// the latter can also be:  accountUpdateDef.put("fields", updatedFieldDef);

epService.getEPAdministrator().getConfiguration().
addEventType("AccountUpdate", accountUpdateDef);

Map&lt;String, Object&gt; updatedField = new HashMap&lt;String, Object&gt;();
updatedField.put("name", "Joe Doe");
updatedField.put("addressLine1", "40 Popular Street");
updatedField.put("history", new UpdateHistory());

Map&lt;String, Object&gt; accountUpdate = new HashMap&lt;String, Object&gt;();
accountUpdate.put("accountId", 10009901);
accountUpdate.put("fields", updatedField);

epService.getEPRuntime().sendEvent(accountUpdate, "AccountUpdate");


select accountId, fields.name, fields.addressLine1, fields.history.lastUpdate
from AccountUpdate
</code></pre></div></div>

<h4 id="223-map-æ•°ç»„">2.2.3 Map æ•°ç»„</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Map&lt;String, Object&gt; sale = new HashMap&lt;String, Object&gt;();
sale.put("userids", int[].class);
sale.put("salesPersons", SalesPerson[].class);
sale.put("items", "OrderItem[]");	 // The property type is the name itself appended by []

epService.getEPAdministrator().getConfiguration().
    addEventType("SaleEvent", sale);
</code></pre></div></div>

<p>æŸ¥è¯¢è¯­å¥ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select userids[0], salesPersons[1].name, 
items[1], items[1].price.amount from SaleEvent
</code></pre></div></div>

<h3 id="23-object-array">2.3 Object Array</h3>
<p><code class="language-plaintext highlighter-rouge">Object</code> æ•°ç»„è·Ÿ<code class="language-plaintext highlighter-rouge">Map</code>ç±»ä¼¼ï¼Œåªæ˜¯å®šä¹‰çš„æ–¹å¼æœ‰äº›åŒºåˆ«ï¼ŒåŒæ—¶ä¹Ÿåªæ”¯æŒå¢é‡æ›´æ–°ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>String[] propertyNames = {"carId", "direction"};   // order is important
Object[] propertyTypes = {String.class, int.class};  // type order matches name order

epService.getEPAdministrator().getConfiguration().
  addEventType("CarLocUpdateEvent", propertyNames, propertyTypes);

epRuntime.sendEvent(new Object[]{carId, direction}, â€œCarLocUpdateEventâ€);
</code></pre></div></div>

<ul>
  <li>
    <p>æŸ¥è¯¢è¯­å¥ï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select carId from CarLocUpdateEvent .win:time(1 min) where direction = 1
</code></pre></div>    </div>
  </li>
  <li>
    <p>å¢é‡æ›´æ–°ï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  admin.getConfiguration().updateObjectArrayEventType("Person", new String[] { "gender" }, new Object[] { int.class });
</code></pre></div>    </div>
  </li>
  <li>
    <p>ObjectArray å®ä¾‹ï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  class CommonUpdateListener implements UpdateListener {
	
    public void update(EventBean[] newEvents, EventBean[] oldEvents) {
      if (null != newEvents) {
        System.out.print("common update method:  ");
        for (int i = 0; i &lt; newEvents.length; i++) {
          System.out.println(newEvents[i].getUnderlying());
        }
      }
    }
  }
	
  public class ObjectArray {
	
    /**
     * @param args
     */
    public static void main(String[] args)
    {
      EPServiceProvider epService = EPServiceProviderManager.getDefaultProvider();
      EPAdministrator admin = epService.getEPAdministrator();
      EPRuntime runtime = epService.getEPRuntime();
	
      // Addresså®šä¹‰
      String[] addressPropNames = { "road", "street", "houseNo" };
      Object[] addressPropTypes = { String.class, String.class, int.class };
	
      // Childå®šä¹‰
      String[] childPropNames = { "name", "age" };
      Object[] childPropTypes = { String.class, int.class };
	
      // Personå®šä¹‰
      String[] personPropNames = { "name", "age", "children", "phones", "address" };
      Object[] personPropTypes = { String.class, int.class, "Child[]", Map.class, "Address" };
	
      // æ³¨å†ŒAddressåˆ°Esper
      admin.getConfiguration().addEventType("Address", addressPropNames, addressPropTypes);
      // æ³¨å†ŒChildåˆ°Esper
      admin.getConfiguration().addEventType("Child", childPropNames, childPropTypes);
      // æ³¨å†ŒPersonåˆ°Esper
      admin.getConfiguration().addEventType("Person", personPropNames, personPropTypes);
	
      // æ–°å¢ä¸€ä¸ªgenderå±æ€§
      admin.getConfiguration().updateObjectArrayEventType("Person", new String[] { "gender" }, new Object[] { int.class });
	
      /** è¾“å‡ºç»“æœï¼š
       * Person props: [name, age, children, phones, address, gender]
       */
      EventType event = admin.getConfiguration().getEventType("Person");
      System.out.println("Person props: " + Arrays.asList(event.getPropertyNames()));
	
      String epl = "select name, age, phones, address.road, address.street, address.houseNo, children[0].name from Person";
      EPStatement state = admin.createEPL(epl);
      state.addListener(new CommonUpdateListener());
	
      Object[] addr = {"road1", "street1", 1};
      Object[][] child = child;
	
      Map&lt;String, Object&gt; phones = new HashMap&lt;String, Object&gt;();
      phones.put("home", "051088744796");
      phones.put("self", "15051818371");
	
      Object[] person = {"person", 30, child, phones, addr};
	
      runtime.sendEvent(person, "Person");
    }
  }
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="231-object-array-è¶…ç±»supertype">2.3.1 Object Array è¶…ç±»ï¼ˆSupertypeï¼‰</h4>
<p><code class="language-plaintext highlighter-rouge">Object[]</code> å¯ä»¥åœ¨å¼•æ“åˆå§‹åŒ–ã€æˆ–è¿è¡Œæ—¶é€šè¿‡administratoræ¥å£ï¼Œå®šä¹‰ä¸€ä¸ªè¶…ç±»ã€‚</p>

<p>è¶…ç±»å¿…é¡»ä¹Ÿæ˜¯<code class="language-plaintext highlighter-rouge">Object[]</code> äº‹ä»¶ï¼Œä¸”æ‰€æœ‰çš„å±æ€§ä¼šå¯¹å­ç±»å¯è§ï¼ŒåŒåå±æ€§å°†ä¼šè¢«è¦†ç›–ã€‚å®šä¹‰äºè¶…ç±»ä¸Šçš„EPLæŸ¥è¯¢è¯­æ³•ï¼Œå­ç±»äº¦ä¼šè§¦å‘ã€‚</p>

<p>å®šä¹‰ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>create objectarray schema SuperType (p0 String)
create objectarray schema SubType (p1 String, p2 String) inherits SuperType
</code></pre></div></div>

<p>å‘é€ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>epRuntime.sendEvent(new Object[] {"p0_value", "p1_value"}, "SubType");
epRuntime.sendEvent(new Object[] {"p0_value"}, "SuperType");
</code></pre></div></div>

<h4 id="232-object-arrayåµŒå¥—å±æ€§">2.3.2 Object Arrayï¼ˆåµŒå¥—å±æ€§ï¼‰</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>String[] propertyNamesUpdField = {"name", "addressLine1", "history"};
Object[] propertyTypesUpdField = {String.class, String.class, UpdateHistory.class};
epService.getEPAdministrator().getConfiguration().
addEventType("UpdatedFieldType", propertyNamesUpdField, propertyTypesUpdField);

String[] propertyNamesAccountUpdate = {"accountId", "fields"};
Object[] propertyTypesAccountUpdate = {long.class, "UpdatedFieldType"};
epService.getEPAdministrator().getConfiguration().
addEventType("AccountUpdate", propertyNamesAccountUpdate, propertyTypesAccountUpdate);

Object[] updatedField = {"Joe Doe", "40 Popular Street", new UpdateHistory()};
Object[] accountUpdate = {10009901, updatedField};
epService.getEPRuntime().sendEvent(accountUpdate, "AccountUpdate");

select accountId, fields.name, fields.addressLine1, fields.history.lastUpdate
from AccountUpdate
</code></pre></div></div>

<h4 id="233-object-arrayä¸€å¯¹å¤šå±æ€§">2.3.3 Object Arrayï¼ˆä¸€å¯¹å¤šå±æ€§ï¼‰</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>String[] propertyNames = {"userids", "salesPersons", "items"};
Object[] propertyTypes = {int[].class, SalesPerson[].class, "OrderItem[]");

epService.getEPAdministrator().getConfiguration().addEventType("SaleEvent", propertyNames, propertyTypes);
</code></pre></div></div>

<p>æŸ¥è¯¢è¯­å¥ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select userids[0], salesPersons[1].name, 
	items[1], items[1].price.amount from SaleEvent
</code></pre></div></div>

<h3 id="24-xml">2.4 XML</h3>

<ul>
  <li>
    <p>ParseXmlSchema ç¤ºä¾‹</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  class ParseXMLListener implements UpdateListener
  {
	
    public void update(EventBean[] newEvents, EventBean[] oldEvents)
    {
      if (newEvents != null)
      {
        for (int i = 0; i &lt; newEvents.length; i++) {
          System.out.println(newEvents[i].getUnderlying());
        }
      }
    }
	
  }
	
  public class ParseXmlSchema {
    public static void main(String[] args) throws InterruptedException, IOException, ParserConfigurationException, SAXException {
      String xml = "&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;" +
          "&lt;Sensor xmlns=\"SensorSchema\"&gt;" +
          "  &lt;ID&gt;urn:epc:1:4.16.36&lt;/ID&gt;" +
          "  &lt;Observation Command=\"READ_PALLET_TAGS_ONLY\"&gt;" +
          "    &lt;ID&gt;00000001&lt;/ID&gt;" +
          "    &lt;Tag&gt;" +
          "      &lt;ID&gt;urn:epc:1:2.24.400&lt;/ID&gt;" +
          "    &lt;/Tag&gt;" +
          "    &lt;Tag&gt;" +
          "      &lt;ID&gt;urn:epc:1:2.24.401&lt;/ID&gt;" +
          "    &lt;/Tag&gt;" +
          "  &lt;/Observation&gt;" +
          "&lt;/Sensor&gt;";
      URL schemaURL = ParseXmlSchema.class.getResource("sensor.xsd");
      EPServiceProvider epService = EPServiceProviderManager.getDefaultProvider();
	
      EPAdministrator admin = epService.getEPAdministrator();
      epService = EPServiceProviderManager.getDefaultProvider();
      ConfigurationEventTypeXMLDOM sensorcfg = new ConfigurationEventTypeXMLDOM();
      sensorcfg.setRootElementName("Sensor");
      sensorcfg.setSchemaResource(schemaURL.toString());
      epService.getEPAdministrator().getConfiguration()
          .addEventType("SensorEvent", sensorcfg);
	
      String epl = "select ID, Observation.Command, Observation.ID, Observation.Tag[0].ID, Observation.Tag[1].ID from SensorEvent";
      EPStatement state = admin.createEPL(epl);
      state.addListener(new ParseXMLListener());
	
      InputSource source = new InputSource(new StringReader(xml));
      DocumentBuilderFactory builderFactory = DocumentBuilderFactory.newInstance();
      builderFactory.setNamespaceAware(true);
      Document doc = builderFactory.newDocumentBuilder().parse(source);
	
      epService.getEPRuntime().sendEvent(doc);
    }
  }
</code></pre></div>    </div>
  </li>
  <li>
    <p>å¯¹åº”çš„<code class="language-plaintext highlighter-rouge">schema</code>æ–‡ä»¶</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  &lt;?xml version="1.0" encoding="UTF-8"?&gt;
  &lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema"&gt;
	
    &lt;xs:element name="Sensor"&gt;
      &lt;xs:complexType&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element name="ID" type="xs:string"/&gt;
          &lt;xs:element ref="Observation" /&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;
	
    &lt;xs:element name="Observation"&gt;
      &lt;xs:complexType&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element name="ID" type="xs:string"/&gt;
          &lt;xs:element ref="Tag" maxOccurs="unbounded" /&gt;
        &lt;/xs:sequence&gt;
        &lt;xs:attribute name="Command" type="xs:string" use="required" /&gt;
      &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;
	
    &lt;xs:element name="Tag"&gt;
      &lt;xs:complexType&gt;
        &lt;xs:sequence&gt;
          &lt;xs:element name="ID" type="xs:string"/&gt;
        &lt;/xs:sequence&gt;
      &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;
  &lt;/xs:schema&gt;
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="25-äº‹ä»¶ç±»å‹å¯¹æ¯”">2.5 äº‹ä»¶ç±»å‹å¯¹æ¯”</h3>
<p><img src="/images/esper/compare.png" alt="" /></p>

<p><a id="link3"></a></p>

<h2 id="ä¸‰å¤„ç†æ¨¡å‹">ä¸‰ã€å¤„ç†æ¨¡å‹</h2>
<p><code class="language-plaintext highlighter-rouge">Esper</code> è¿›ç¨‹æ¨¡å‹æ˜¯è¿ç»­ä¸é—´æ–­çš„ï¼šæ ¹æ®<code class="language-plaintext highlighter-rouge">event stream</code>ã€<code class="language-plaintext highlighter-rouge">views</code>ã€<code class="language-plaintext highlighter-rouge">filters</code>å’Œ<code class="language-plaintext highlighter-rouge">output rates</code>çš„è¯­å¥é€‰æ‹©èŒƒå›´ï¼Œ</p>

<p><code class="language-plaintext highlighter-rouge">UpdaterListener</code>æ˜¯Esperæä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œç”¨äºç›‘å¬æŸä¸ªEPLåœ¨å¼•æ“ä¸­çš„è¿è¡Œæƒ…å†µï¼Œå³äº‹ä»¶è¿›å…¥å¹¶äº§ç”Ÿç»“æœåä¼šé€šçŸ¥<code class="language-plaintext highlighter-rouge">UpdateListener</code>ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package com.espertech.esper.client;  
  
import com.espertech.esper.client.EventBean;  
  
public interface UpdateListener  
{  
    public void update(EventBean[] newEvents, EventBean[] oldEvents);  
} 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Esper</code>æ˜¯æ€ä¹ˆå¤„ç†äº‹ä»¶çš„ï¼Œå³<code class="language-plaintext highlighter-rouge">Esper</code>çš„è¿›ç¨‹æ¨¡å‹ã€‚</p>

<p>ä¸€ä¸ªupdateæ–¹æ³•ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸¤ä¸ªEventBeanæ•°ç»„ã€‚EventBeanä¸­æœ‰ä¸€ä¸ªæœ€å¸¸ç”¨çš„getæ–¹æ³•ï¼Œæ˜¯ç”¨æ¥å¾—åˆ°EPLä¸­æŸä¸ªå­—æ®µçš„å€¼ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select name from User  
//å‡è®¾newEventsé•¿åº¦ä¸ºä¸€  
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">newEvents[0].get("name")</code>èƒ½å¾—åˆ°è¿›å…¥çš„Useräº‹ä»¶çš„nameå±æ€§å€¼ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select count(*) from User.win:time(5 sec)  
//å‡è®¾newEventsé•¿åº¦ä¸ºä¸€  
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">newEvents[0].get("count(*))</code>èƒ½å¾—åˆ°5ç§’å†…è¿›å…¥å¼•æ“çš„Useräº‹ä»¶æ•°é‡æœ‰å¤šå°‘ã€‚</p>

<h3 id="31-insert-and-remove-stream">3.1 Insert And Remove Stream</h3>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">IR Stream</code></p>

    <p><img src="/images/esper/irstream.png" alt="" /></p>

    <p>ä»æ­¤å›¾å¯ä»¥çœ‹å‡ºï¼Œéšç€æ—¶é—´æ¨ç§»ï¼Œæ¯ä¸ªè¿›å…¥åˆ°å¼•æ“çš„<code class="language-plaintext highlighter-rouge">W</code>äº‹ä»¶éƒ½æ˜¯<code class="language-plaintext highlighter-rouge">newEvents</code>ï¼Œå³<code class="language-plaintext highlighter-rouge">Insert Stream</code>ã€‚<code class="language-plaintext highlighter-rouge">W</code>åæ‹¬å·é‡Œçš„å€¼ä¸ºå±æ€§å€¼ï¼Œå¯å¿½ç•¥ã€‚</p>

    <p><code class="language-plaintext highlighter-rouge">Insert</code>è¡¨ç¤ºäº‹ä»¶è¿›å…¥å¼•æ“ï¼Œ<code class="language-plaintext highlighter-rouge">Remove Stream</code>è¡¨ç¤ºç§»å‡ºå¼•æ“ï¼Œå¯¹åº”äº<code class="language-plaintext highlighter-rouge">UpdateListener</code>ä¸­çš„ <code class="language-plaintext highlighter-rouge">newEvents</code> å’Œ <code class="language-plaintext highlighter-rouge">oldEvents</code>ã€‚</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select * from Withdrawal
</code></pre></div>    </div>

    <p>æ¯å½“å¼•æ“å¤„ç†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Withdrawal</code> æˆ– <code class="language-plaintext highlighter-rouge">Withdrawal</code> å­ç±»å‹çš„äº‹ä»¶æ—¶ï¼Œä¼šè§¦å‘å¯¹åº”æ‰€æœ‰çš„ <code class="language-plaintext highlighter-rouge">update listener</code>ï¼Œå¹¶å°†è¯¥äº‹ä»¶ä¼ é€’ç»™æ¯ä¸ª <code class="language-plaintext highlighter-rouge">EPL</code> è¯­å¥çš„ç›‘å¬å™¨ã€‚</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Window Length</code></p>

    <p>é˜Ÿåˆ—çª—å£(length window)å‘ŠçŸ¥å¼•æ“åªä¿ç•™æœ€æ–°çš„ <code class="language-plaintext highlighter-rouge">N</code> ä¸ªäº‹ä»¶ï¼Œå¦‚ï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select * from Withdrawal.win:length(5)
</code></pre></div>    </div>

    <p>å¼€æ”¾äº†ä¸€ä¸ªå¤§å°ä¸º 5 çš„ç©ºé—´ï¼Œå¯åŒæ—¶å­˜æ”¾ 5 ä¸ªäº‹ä»¶ã€‚</p>

    <p>å¼•æ“å°†æ‰€æœ‰æ¥æ”¶åˆ°çš„äº‹ä»¶ï¼Œè®©å…¥åˆ°ä¸€ä¸ªé•¿åº¦ä¸º 5 çš„ç©ºé—´ä¸­ï¼Œå½“ç©ºé—´æ»¡äº†ä¹‹åï¼Œæœ€è€çš„äº‹ä»¶å°†ä¼šç½®æ¢å‡ºé˜Ÿåˆ—ï¼Œæ–°åˆ°çš„äº‹ä»¶å³ä¸º<code class="language-plaintext highlighter-rouge">newEvent</code>ï¼Œç½®æ¢å‡ºå»çš„å³ä¸º<code class="language-plaintext highlighter-rouge">oldEvent</code>ã€‚</p>

    <p><img src="/images/esper/irstream-win-length.png" alt="" /></p>

    <p>å®é™…ä¸Šè¿™ä¸ªEPLè§¦å‘ç›‘å¬å™¨éƒ½åªèƒ½çœ‹åˆ°<code class="language-plaintext highlighter-rouge">newEvents</code>ï¼Œçœ‹ä¸åˆ°<code class="language-plaintext highlighter-rouge">oldEvents</code>ã€‚å¦‚æœæƒ³çœ‹åˆ°<code class="language-plaintext highlighter-rouge">oldEvents</code>ï¼ŒEPLè¦æ”¹å†™ä¸€ä¸‹ï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select irstream * from Withdrawal.win:length(5)
</code></pre></div>    </div>

    <p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒEsperè®¤ä¸ºä½ åªæƒ³è®©<code class="language-plaintext highlighter-rouge">newEvents</code>è§¦å‘ç›‘å¬å™¨ï¼Œå³<code class="language-plaintext highlighter-rouge">istream</code>(insert stream)ã€‚å¦‚æœæƒ³è®©<code class="language-plaintext highlighter-rouge">oldEvents</code>è§¦å‘ç›‘å¬å™¨ï¼Œé‚£ä¹ˆä¸º<code class="language-plaintext highlighter-rouge">rstream</code>(remove stream)ã€‚å¦‚æœä¸¤ä¸ªéƒ½æƒ³ï¼Œé‚£ä¹ˆä¸º<code class="language-plaintext highlighter-rouge">irstream</code>ã€‚å½“ç„¶è¿™ä¸ªé»˜è®¤æƒ…å†µæ˜¯å¯ä»¥é…ç½®çš„ï¼Œä»¥åä¼šè¯´åˆ°è¿™ä¸ªé—®é¢˜ã€‚</p>

    <p>å½“åªç”¨<code class="language-plaintext highlighter-rouge">rstream</code>æ—¶ï¼Œè¿‡æœŸçš„<code class="language-plaintext highlighter-rouge">oldEvents</code>æ˜¯æ”¾æ¾åˆ°<code class="language-plaintext highlighter-rouge">newEvents</code>ä¸­çš„ã€‚</p>
  </li>
</ul>

<h3 id="32-filter-and-where-causes">3.2 Filter And Where-causes</h3>
<p>EPLæœ‰ä¸¤ç§è¿‡æ»¤äº‹ä»¶çš„æ–¹å¼ï¼š</p>

<ul>
  <li>è¿‡æ»¤äº‹ä»¶è¿›å…¥viewï¼ˆå¯ä»¥æŠŠviewç†è§£ä¸ºä¸€ä¸ªçª—å£ï¼‰ï¼Œå³Filterã€‚</li>
  <li>è®©äº‹ä»¶éƒ½è¿›å…¥viewï¼Œä½†ä¸è§¦å‘UpdateListenerï¼Œå³Whereå­å¥ã€‚</li>
</ul>

<p><i class="red"><strong>Filterï¼š</strong></i></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select * from Withdrawal(amount&gt;=200).win:length(5)
</code></pre></div></div>

<p>æ‰€æœ‰<code class="language-plaintext highlighter-rouge">Withdrawal</code>äº‹ä»¶ä¸­ï¼Œåªæœ‰<code class="language-plaintext highlighter-rouge">amount</code>å±æ€§å€¼ <code class="language-plaintext highlighter-rouge">&gt;= 200</code>çš„æ‰å¯ä»¥è¿›å…¥ <code class="language-plaintext highlighter-rouge">win:length</code>ï¼Œä¸”<code class="language-plaintext highlighter-rouge">win:length</code>å¤§å°ä¸º 5.</p>

<p><img src="/images/esper/irstream-filter-where.png" alt="" /></p>

<p><i class="red"><strong>Where-causesï¼š</strong></i></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select * from Withdrawal.win:length(5) where amount &gt;= 200
</code></pre></div></div>

<p>æ‰€æœ‰<code class="language-plaintext highlighter-rouge">Withdrawal</code>äº‹ä»¶ä¸­ï¼Œéƒ½å¯ä»¥è¿›å…¥ <code class="language-plaintext highlighter-rouge">win:length</code>ï¼Œä¸”<code class="language-plaintext highlighter-rouge">win:length</code>å¤§å°ä¸º 5ï¼Œåªæœ‰<code class="language-plaintext highlighter-rouge">amount</code>å±æ€§ <code class="language-plaintext highlighter-rouge">&gt;= 200</code> çš„æ‰å¯ä»¥è§¦å‘ <code class="language-plaintext highlighter-rouge">UpdateListener</code>ã€‚</p>

<p><img src="/images/esper/irstream-where.png" alt="" /></p>

<h3 id="33-time-windows">3.3 Time Windows</h3>
<ul>
  <li>
    <p>Time Windows</p>

    <p>Time Window æ˜¯åŸºäºè¿‡å»ç³»ç»Ÿæ—¶é—´ä¸Šçš„ï¼Œä¸€ä¸ªç§»åŠ¨çš„æŒ‡å®šæ—¶é—´é—´éš”çš„çª—å£ï¼ŒTime Window èƒ½å¤Ÿé™åˆ¶ä¸€æ¬¡æŸ¥è¯¢ä¸­äº‹ä»¶çš„ä¸ªæ•°ï¼Œç±»ä¼¼äºlength windowã€‚</p>

    <p>ä¾‹å¦‚ï¼Œè¦æŸ¥è¯¢æ‰€æœ‰è¿‡å»4ç§’çš„accountä¸­ï¼Œamountå¤§äº1000çš„withdrawalçš„å¹³å‡å€¼ï¼Œ</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select account, avg(amount)
  from Withdrawal.win:time(4 sec)
  group by account
  having amount &gt; 1000

  select * from Withdrawal.win:time(4 sec)
</code></pre></div>    </div>

    <p><img src="/images/esper/time-window.png" alt="" /></p>

    <ol>
      <li>t+4 ç§’ï¼ŒW1åˆ°è¾¾å¹¶è¿›å…¥windowï¼Œå¼•æ“å°†ä¹‹åé¦ˆç»™ update listeners</li>
      <li>t+5 ç§’ï¼ŒW2åˆ°è¾¾å¹¶è¿›å…¥windowï¼Œå¼•æ“å°†ä¹‹åé¦ˆç»™ update listeners</li>
      <li>t+6.5 ç§’ï¼ŒW3åˆ°è¾¾å¹¶è¿›å…¥windowï¼Œå¼•æ“å°†ä¹‹åé¦ˆç»™ update listeners</li>
      <li>t+8 ç§’ï¼ŒW1ç¦»å¼€time windowï¼Œå¼•æ“å°†ä¹‹ä½œä¸ºä¸€ä¸ªold event å‘ŠçŸ¥update listeners</li>
    </ol>
  </li>
  <li>
    <p>Time Batch</p>

    <p>Time Batchè§†å›¾ç¼“å­˜äº‹ä»¶ï¼Œå¹¶åœ¨æ¯ä¸ªæŒ‡å®šçš„æ—¶é—´é—´éš”æ›´æ–°æ—¶é‡Šæ”¾å®ƒä»¬ï¼Œå¯ä»¥ç†è§£ä¸ºæ‰¹ã€æ‰¹å¤„ç†ã€‚length batchä¹Ÿç±»ä¼¼ã€‚</p>

    <p>ä¾‹å¦‚ï¼Œ</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select * from Withdrawal.win:time_batch(4 sec)
</code></pre></div>    </div>

    <p>ä¸Šè¿°EPLè¯­å¥å¯ä»¥ç†è§£ä¸ºé€šè¿‡æ—¶é—´åˆ†æ‰¹æŸ¥è¯¢ï¼Œæ¯ä¸€æ‰¹ä¸º4ç§’é’Ÿã€‚</p>

    <p><img src="/images/esper/time-batch.png" alt="" /></p>

    <ol>
      <li>åœ¨ t + 1ç§’ï¼ŒW1 åˆ°è¾¾å¹¶è¿›å…¥batchï¼Œä¸è§¦å‘è°ƒç”¨ update listeners</li>
      <li>åœ¨ t + 3ç§’ï¼ŒW2 åˆ°è¾¾å¹¶è¿›å…¥batchï¼Œä¸è§¦å‘è°ƒç”¨ update listeners</li>
      <li>åœ¨ t + 4ç§’ï¼Œå¼•æ“å¤„ç†batchäº‹ä»¶ï¼Œå¹¶å¼€å§‹ä¸€ä¸ªæ–°çš„batchï¼Œå¼•æ“è§¦å‘W1å’ŒW2ç»™update listeners</li>
      <li>åœ¨ t + 6.5ç§’ï¼ŒW3 å¼•æ“å¤„ç†batchäº‹ä»¶ï¼Œå¹¶å¼€å§‹ä¸€ä¸ªæ–°çš„batchï¼Œå¼•æ“è§¦å‘W1å’ŒW2ç»™update listeners</li>
      <li>åœ¨ t + 8ç§’ï¼Œå¼•æ“å¤„ç†batchäº‹ä»¶ï¼Œå¹¶å¼€å§‹ä¸€ä¸ªæ–°çš„batchï¼Œå¼•æ“è§¦å‘W3ç»™update listeners,å¹¶å°†W1å’ŒW2ä½œä¸ºold dataï¼ˆå‰ä¸€ä¸ªbatchï¼‰å‘ç»™update listeners</li>
    </ol>

    <p>æ”¶é›†1ç§’é’Ÿä¹‹å†…åˆ°è¾¾çš„Withdrawaläº‹ä»¶ï¼Œå¹¶åœ¨1ç§’é’Ÿç»“æŸä¹‹åï¼Œå°†ä¹‹ä½œä¸ºnew eventsï¼ˆinsert streamï¼‰å‘é€ç»™å¼•æ“çš„æ¯ä¸ªlistenerï¼Œå°†ä¸Š1ç§’çš„ä½œä¸ºold eventsï¼ˆremove streamï¼‰å‘é€ç»™æ¯ä¸ªlistener</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select account, amount from Withdrawal.win:time_batch(1 sec)
</code></pre></div>    </div>

    <p>1ç§’å†…æ‰€æœ‰Withdrawalæ—¶é—´çš„amountå±æ€§å’Œ</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select sum(amount) as mysum from Withdrawal.win:time_batch(1 sec)
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="34-åˆ†ç»„èšåˆ">3.4 åˆ†ç»„èšåˆ</h3>

<ul>
  <li>
    <p>IStream</p>

    <p>å½“èšåˆå±æ€§å€¼å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œèšåˆäº‹ä»¶è¯­å¥ï¼Œèƒ½å¤Ÿé€šè¿‡èšåˆå‡½æ•°ä¼ é€’(post)remove steamï¼ˆå³èšåˆå‡½æ•°å€¼ä¹Ÿèƒ½ä½œä¸ºè§¦å‘update listenerçš„æ¡ä»¶ï¼‰ã€‚</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select count(*) as mycount from Withdrawal having count(*) = 2   å½“æ¥æ”¶åˆ° 2 ä¸ªWithdrawaläº‹ä»¶æ—¶ï¼Œè¾“å‡ºã€‚

  select istream count(*) as mycount form Withdrawal having count(*) = 2
</code></pre></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">istream</code> æˆ– <code class="language-plaintext highlighter-rouge">rstream</code>å…³é”®å­—èƒ½è¢«ç”¨æ¥æŒ‡å®šä¼ é€’ï¼ˆpostï¼‰ <code class="language-plaintext highlighter-rouge">new events</code> æˆ– <code class="language-plaintext highlighter-rouge">old events</code> ç»™<code class="language-plaintext highlighter-rouge">update listeners</code>ã€‚ä¸Šè¿°è¯­å¥ï¼Œè¡¨ç¤ºå½“ä¸”ä»…å½“ç¬¬äºŒä¸ª<code class="language-plaintext highlighter-rouge">Withdrawal</code>äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œå¼•æ“æ‰ä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">listener</code>ï¼›è‹¥<code class="language-plaintext highlighter-rouge">istream</code>æ”¹ä¸º<code class="language-plaintext highlighter-rouge">rstream</code>ï¼Œåˆ™ä»…å½“ç¬¬ä¸‰ä¸ª<code class="language-plaintext highlighter-rouge">Withdrawal</code>äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œå¼•æ“æ‰ä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">listener</code>ã€‚</p>
  </li>
  <li>
    <p>IR Stream</p>

    <p>ç›‘å¬å™¨æœ‰ä¸¤ä¸ªå‚æ•° newEvents å’Œ oldEventsï¼ŒnewEvents è¡¨ç¤ºé€šå¸¸çš„è®¡ç®—ç»“æœï¼ŒoldEvents å¯ä»¥ç†è§£ä¸ºä¸Šä¸€æ¬¡è®¡ç®—ç»“æœã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒnewEvents æœ‰å€¼ï¼ŒoldEvnets ä¸ºnullã€‚</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select rstream * from Withdrawal   ä¸Šè¿°ç»“æœä¼šå°†ä¸Šä¸€æ¬¡çš„è®¡ç®—ç»“æœæ”¾å…¥åˆ° newEventsï¼Œè€Œä¸æ˜¯ oldEventsï¼Œä¸”æ— æ³•è·å–å½“å‰è®¡ç®—ç»“æœï¼

  select irstream * from Withdrawal   ä¼šå°†å½“å‰è®¡ç®—ç»“æœæ”¾å…¥ newEventsï¼Œä¸Šæ¬¡è®¡ç®—ç»“æœæ”¾å…¥åˆ° oldEventsã€‚

  select istream * from Withdrawal
  select * from Withdrawal   ä¼šå°†å½“å‰è®¡ç®—ç»“æœæ”¾å…¥newEventsï¼Œä¸”æ— æ³•å¾—åˆ°ä¸Šæ¬¡è®¡ç®—ç»“æœï¼Œé»˜è®¤è®¾ç½®ã€‚
</code></pre></div>    </div>
  </li>
  <li>
    <p>Aggregate and Group</p>

    <p>ä¸èšåˆã€ä¸åˆ†ç»„</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  select * from Withdrawal.win:time_batch(1 sec)   åªæœ‰èšåˆï¼Œæ²¡æœ‰åˆ†ç»„

  select sum(amount)
  from Withdrawal.win:time_batch(1 sec)   éèšåˆå±æ€§ã€èšåˆå±æ€§ï¼Œå½“ä¸åˆ†ç»„

  select account, sum(amount)
  from Withdrawlal.win:time_batch(1 sec)   æŸ¥è¯¢è¯­å¥ä¸­çš„èšåˆå±æ€§ã€æ‰€æœ‰éèšåˆå±æ€§ï¼Œéƒ½è¢«group byè¯­å¥åˆ—å‡ºã€‚

  select account, sum(amount)
  from Withdrawal.win:time_batch(1 sec)
  group by account   æŸ¥è¯¢ éèšåˆå±æ€§å’Œèšåˆå±æ€§ï¼Œä»…ç”¨group byåˆ†ç»„äº†éƒ¨åˆ†å±æ€§ã€‚

  select account, accountName, sum(amount) 
  from Withdrawal.win:time_batch(1 sec) 
  group by account
</code></pre></div>    </div>
  </li>
</ul>

<p><a id="link4"></a></p>

<h3 id="æœªå®Œå¾…ç»­">æœªå®Œå¾…ç»­â€¦</h3>
:ET