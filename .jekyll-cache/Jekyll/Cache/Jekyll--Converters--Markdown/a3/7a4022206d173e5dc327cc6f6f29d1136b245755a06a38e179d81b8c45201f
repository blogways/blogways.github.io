I"Á;<p>redisæ˜¯ä¸€ä¸ªè‘—åçš„key-valueå­˜å‚¨ç³»ç»Ÿï¼Œè€Œä½œä¸ºå…¶å®˜æ–¹æ¨èçš„javaç‰ˆå®¢æˆ·ç«¯jedisä¹Ÿéå¸¸å¼ºå¤§å’Œç¨³å®šï¼Œæ”¯æŒäº‹åŠ¡ã€ç®¡é“åŠæœ‰jedisè‡ªèº«å®ç°çš„åˆ†å¸ƒå¼ã€‚</p>

<p>åœ¨è¿™é‡Œå¯¹jediså…³äºäº‹åŠ¡ã€ç®¡é“å’Œåˆ†å¸ƒå¼çš„è°ƒç”¨æ–¹å¼åšä¸€ä¸ªç®€å•çš„ä»‹ç»å’Œå¯¹æ¯”ï¼š</p>

<h3 id="ä¸€æ™®é€šåŒæ­¥æ–¹å¼">ä¸€ã€æ™®é€šåŒæ­¥æ–¹å¼</h3>

<p>æœ€ç®€å•å’ŒåŸºç¡€çš„è°ƒç”¨æ–¹å¼ï¼Œ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Test
public void test1Normal() {
	Jedis jedis = new Jedis("localhost");
	long start = System.currentTimeMillis();
	for (int i = 0; i &lt; 100000; i++) {
	    String result = jedis.set("n" + i, "n" + i);
	}
	long end = System.currentTimeMillis();
	System.out.println("Simple SET: " + ((end - start)/1000.0) + " seconds");
	jedis.disconnect();
}
</code></pre></div></div>

<p>å¾ˆç®€å•å§ï¼Œæ¯æ¬¡<code class="language-plaintext highlighter-rouge">set</code>ä¹‹åéƒ½å¯ä»¥è¿”å›ç»“æœï¼Œæ ‡è®°æ˜¯å¦æˆåŠŸã€‚</p>

<h3 id="äºŒäº‹åŠ¡æ–¹å¼transactions">äºŒã€äº‹åŠ¡æ–¹å¼(Transactions)</h3>

<p>redisçš„äº‹åŠ¡å¾ˆç®€å•ï¼Œä»–ä¸»è¦ç›®çš„æ˜¯ä¿éšœï¼Œä¸€ä¸ªclientå‘èµ·çš„äº‹åŠ¡ä¸­çš„å‘½ä»¤å¯ä»¥è¿ç»­çš„æ‰§è¡Œï¼Œè€Œä¸­é—´ä¸ä¼šæ’å…¥å…¶ä»–clientçš„å‘½ä»¤ã€‚</p>

<p>çœ‹ä¸‹é¢ä¾‹å­ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Test
public void test2Trans() {
	Jedis jedis = new Jedis("localhost");
	long start = System.currentTimeMillis();
	Transaction tx = jedis.multi();
	for (int i = 0; i &lt; 100000; i++) {
	    tx.set("t" + i, "t" + i);
	}
	List&lt;Object&gt; results = tx.exec();
	long end = System.currentTimeMillis();
	System.out.println("Transaction SET: " + ((end - start)/1000.0) + " seconds");
	jedis.disconnect();
}
</code></pre></div></div>

<p>æˆ‘ä»¬è°ƒç”¨<code class="language-plaintext highlighter-rouge">jedis.watch(â€¦)</code>æ–¹æ³•æ¥ç›‘æ§keyï¼Œå¦‚æœè°ƒç”¨åkeyå€¼å‘ç”Ÿå˜åŒ–ï¼Œåˆ™æ•´ä¸ªäº‹åŠ¡ä¼šæ‰§è¡Œå¤±è´¥ã€‚å¦å¤–ï¼Œäº‹åŠ¡ä¸­æŸä¸ªæ“ä½œå¤±è´¥ï¼Œå¹¶ä¸ä¼šå›æ»šå…¶ä»–æ“ä½œã€‚è¿™ä¸€ç‚¹éœ€è¦æ³¨æ„ã€‚è¿˜æœ‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">discard()</code>æ–¹æ³•æ¥å–æ¶ˆäº‹åŠ¡ã€‚</p>

<h3 id="ä¸‰ç®¡é“pipelining">ä¸‰ã€ç®¡é“(Pipelining)</h3>

<p>æœ‰æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é‡‡ç”¨å¼‚æ­¥æ–¹å¼ï¼Œä¸€æ¬¡å‘é€å¤šä¸ªæŒ‡ä»¤ï¼Œä¸åŒæ­¥ç­‰å¾…å…¶è¿”å›ç»“æœã€‚è¿™æ ·å¯ä»¥å–å¾—éå¸¸å¥½çš„æ‰§è¡Œæ•ˆç‡ã€‚è¿™å°±æ˜¯ç®¡é“ï¼Œè°ƒç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Test
public void test3Pipelined() {
	Jedis jedis = new Jedis("localhost");
	Pipeline pipeline = jedis.pipelined();
	long start = System.currentTimeMillis();
	for (int i = 0; i &lt; 100000; i++) {
	    pipeline.set("p" + i, "p" + i);
	}
	List&lt;Object&gt; results = pipeline.syncAndReturnAll();
	long end = System.currentTimeMillis();
	System.out.println("Pipelined SET: " + ((end - start)/1000.0) + " seconds");
	jedis.disconnect();
}
</code></pre></div></div>

<h3 id="å››ç®¡é“ä¸­è°ƒç”¨äº‹åŠ¡">å››ã€ç®¡é“ä¸­è°ƒç”¨äº‹åŠ¡</h3>

<p>å°±Jedisæä¾›çš„æ–¹æ³•è€Œè¨€ï¼Œæ˜¯å¯ä»¥åšåˆ°åœ¨ç®¡é“ä¸­ä½¿ç”¨äº‹åŠ¡ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Test
public void test4combPipelineTrans() {
	jedis = new Jedis("localhost"); 
	long start = System.currentTimeMillis();
	Pipeline pipeline = jedis.pipelined();
	pipeline.multi();
	for (int i = 0; i &lt; 100000; i++) {
	    pipeline.set("" + i, "" + i);
	}
	pipeline.exec();
	List&lt;Object&gt; results = pipeline.syncAndReturnAll();
	long end = System.currentTimeMillis();
	System.out.println("Pipelined transaction: " + ((end - start)/1000.0) + " seconds");
	jedis.disconnect();
}
</code></pre></div></div>

<p>ä½†æ˜¯ç»æµ‹è¯•ï¼ˆè§æœ¬æ–‡åç»­éƒ¨åˆ†ï¼‰ï¼Œå‘ç°å…¶æ•ˆç‡å’Œå•ç‹¬ä½¿ç”¨äº‹åŠ¡å·®ä¸å¤šï¼Œç”šè‡³è¿˜ç•¥å¾®å·®ç‚¹ã€‚</p>

<h3 id="äº”åˆ†å¸ƒå¼ç›´è¿åŒæ­¥è°ƒç”¨">äº”ã€åˆ†å¸ƒå¼ç›´è¿åŒæ­¥è°ƒç”¨</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Test
public void test5shardNormal() {
	List&lt;JedisShardInfo&gt; shards = Arrays.asList(
			new JedisShardInfo("localhost",6379),
			new JedisShardInfo("localhost",6380));
			
	ShardedJedis sharding = new ShardedJedis(shards);
	
	long start = System.currentTimeMillis();
	for (int i = 0; i &lt; 100000; i++) {
	    String result = sharding.set("sn" + i, "n" + i);
	}
	long end = System.currentTimeMillis();
	System.out.println("Simple@Sharing SET: " + ((end - start)/1000.0) + " seconds");
	
	sharding.disconnect();
}
</code></pre></div></div>

<p>è¿™ä¸ªæ˜¯åˆ†å¸ƒå¼ç›´æ¥è¿æ¥ï¼Œå¹¶ä¸”æ˜¯åŒæ­¥è°ƒç”¨ï¼Œæ¯æ­¥æ‰§è¡Œéƒ½è¿”å›æ‰§è¡Œç»“æœã€‚ç±»ä¼¼åœ°ï¼Œè¿˜æœ‰å¼‚æ­¥ç®¡é“è°ƒç”¨ã€‚</p>

<h3 id="å…­åˆ†å¸ƒå¼ç›´è¿å¼‚æ­¥è°ƒç”¨">å…­ã€åˆ†å¸ƒå¼ç›´è¿å¼‚æ­¥è°ƒç”¨</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Test
public void test6shardpipelined() {
	List&lt;JedisShardInfo&gt; shards = Arrays.asList(
			new JedisShardInfo("localhost",6379),
			new JedisShardInfo("localhost",6380));
			
	ShardedJedis sharding = new ShardedJedis(shards);
	
	ShardedJedisPipeline pipeline = sharding.pipelined();
	long start = System.currentTimeMillis();
	for (int i = 0; i &lt; 100000; i++) {
	    pipeline.set("sp" + i, "p" + i);
	}
	List&lt;Object&gt; results = pipeline.syncAndReturnAll();
	long end = System.currentTimeMillis();
	System.out.println("Pipelined@Sharing SET: " + ((end - start)/1000.0) + " seconds");
	
	sharding.disconnect();
}
</code></pre></div></div>

<h3 id="ä¸ƒåˆ†å¸ƒå¼è¿æ¥æ± åŒæ­¥è°ƒç”¨">ä¸ƒã€åˆ†å¸ƒå¼è¿æ¥æ± åŒæ­¥è°ƒç”¨</h3>

<p>å¦‚æœï¼Œä½ çš„åˆ†å¸ƒå¼è°ƒç”¨ä»£ç æ˜¯è¿è¡Œåœ¨çº¿ç¨‹ä¸­ï¼Œé‚£ä¹ˆä¸Šé¢ä¸¤ä¸ªç›´è¿è°ƒç”¨æ–¹å¼å°±ä¸åˆé€‚äº†ï¼Œå› ä¸ºç›´è¿æ–¹å¼æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä½ å°±å¿…é¡»é€‰æ‹©è¿æ¥æ± è°ƒç”¨ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Test
public void test7shardSimplePool() {
	List&lt;JedisShardInfo&gt; shards = Arrays.asList(
			new JedisShardInfo("localhost",6379),
			new JedisShardInfo("localhost",6380));

	ShardedJedisPool pool = new ShardedJedisPool(new JedisPoolConfig(), shards);

	ShardedJedis one = pool.getResource();
	
	long start = System.currentTimeMillis();
	for (int i = 0; i &lt; 100000; i++) {
	    String result = one.set("spn" + i, "n" + i);
	}
	long end = System.currentTimeMillis();
	pool.returnResource(one);
	System.out.println("Simple@Pool SET: " + ((end - start)/1000.0) + " seconds");
	
	pool.destroy();
}
</code></pre></div></div>

<p>ä¸Šé¢æ˜¯åŒæ­¥æ–¹å¼ï¼Œå½“ç„¶è¿˜æœ‰å¼‚æ­¥æ–¹å¼ã€‚</p>

<h3 id="å…«åˆ†å¸ƒå¼è¿æ¥æ± å¼‚æ­¥è°ƒç”¨">å…«ã€åˆ†å¸ƒå¼è¿æ¥æ± å¼‚æ­¥è°ƒç”¨</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Test
public void test8shardPipelinedPool() {
	List&lt;JedisShardInfo&gt; shards = Arrays.asList(
			new JedisShardInfo("localhost",6379),
			new JedisShardInfo("localhost",6380));

	ShardedJedisPool pool = new ShardedJedisPool(new JedisPoolConfig(), shards);

	ShardedJedis one = pool.getResource();
	
	ShardedJedisPipeline pipeline = one.pipelined();
	
	long start = System.currentTimeMillis();
	for (int i = 0; i &lt; 100000; i++) {
	    pipeline.set("sppn" + i, "n" + i);
	}
	List&lt;Object&gt; results = pipeline.syncAndReturnAll();
	long end = System.currentTimeMillis();
	pool.returnResource(one);
	System.out.println("Pipelined@Pool SET: " + ((end - start)/1000.0) + " seconds");
	pool.destroy();
}
</code></pre></div></div>

<h3 id="ä¹éœ€è¦æ³¨æ„çš„åœ°æ–¹">ä¹ã€éœ€è¦æ³¨æ„çš„åœ°æ–¹</h3>

<ol>
  <li>
    <p>äº‹åŠ¡å’Œç®¡é“éƒ½æ˜¯å¼‚æ­¥æ¨¡å¼ã€‚åœ¨äº‹åŠ¡å’Œç®¡é“ä¸­ä¸èƒ½åŒæ­¥æŸ¥è¯¢ç»“æœã€‚æ¯”å¦‚ä¸‹é¢ä¸¤ä¸ªè°ƒç”¨ï¼Œéƒ½æ˜¯ä¸å…è®¸çš„ï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Transaction tx = jedis.multi();
 for (int i = 0; i &lt; 100000; i++) {
     tx.set("t" + i, "t" + i);
 }
 System.out.println(tx.get("t1000").get());  //ä¸å…è®¸
	
 List&lt;Object&gt; results = tx.exec();
	
 â€¦
 â€¦
	
 Pipeline pipeline = jedis.pipelined();
 long start = System.currentTimeMillis();
 for (int i = 0; i &lt; 100000; i++) {
     pipeline.set("p" + i, "p" + i);
 }
 System.out.println(pipeline.get("p1000").get()); //ä¸å…è®¸
	
 List&lt;Object&gt; results = pipeline.syncAndReturnAll();
</code></pre></div>    </div>
  </li>
  <li>äº‹åŠ¡å’Œç®¡é“éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸ªäººæ„Ÿè§‰ï¼Œåœ¨ç®¡é“ä¸­å†è¿›è¡Œäº‹åŠ¡è°ƒç”¨ï¼Œæ²¡æœ‰å¿…è¦ï¼Œä¸å¦‚ç›´æ¥è¿›è¡Œäº‹åŠ¡æ¨¡å¼ã€‚</li>
  <li>
    <p>åˆ†å¸ƒå¼ä¸­ï¼Œè¿æ¥æ± çš„æ€§èƒ½æ¯”ç›´è¿çš„æ€§èƒ½ç•¥å¥½(è§åç»­æµ‹è¯•éƒ¨åˆ†)ã€‚</p>
  </li>
  <li>
    <p>åˆ†å¸ƒå¼è°ƒç”¨ä¸­ä¸æ”¯æŒäº‹åŠ¡ã€‚</p>

    <p>å› ä¸ºäº‹åŠ¡æ˜¯åœ¨æœåŠ¡å™¨ç«¯å®ç°ï¼Œè€Œåœ¨åˆ†å¸ƒå¼ä¸­ï¼Œæ¯æ‰¹æ¬¡çš„è°ƒç”¨å¯¹è±¡éƒ½å¯èƒ½è®¿é—®ä¸åŒçš„æœºå™¨ï¼Œæ‰€ä»¥ï¼Œæ²¡æ³•è¿›è¡Œäº‹åŠ¡ã€‚</p>
  </li>
</ol>

<h3 id="åæµ‹è¯•">åã€æµ‹è¯•</h3>

<p>è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œè¿›è¡Œæµ‹è¯•ï¼Œå…¶ç»“æœå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Simple SET: 5.227 seconds

Transaction SET: 0.5 seconds
Pipelined SET: 0.353 seconds
Pipelined transaction: 0.509 seconds

Simple@Sharing SET: 5.289 seconds
Pipelined@Sharing SET: 0.348 seconds

Simple@Pool SET: 5.039 seconds
Pipelined@Pool SET: 0.401 seconds
</code></pre></div></div>

<p>å¦å¤–ï¼Œç»æµ‹è¯•åˆ†å¸ƒå¼ä¸­ç”¨åˆ°çš„æœºå™¨è¶Šå¤šï¼Œè°ƒç”¨ä¼šè¶Šæ…¢ã€‚ä¸Šé¢æ˜¯2ç‰‡ï¼Œä¸‹é¢æ˜¯5ç‰‡ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Simple@Sharing SET: 5.494 seconds
Pipelined@Sharing SET: 0.51 seconds
Simple@Pool SET: 5.223 seconds
Pipelined@Pool SET: 0.518 seconds
</code></pre></div></div>

<p>ä¸‹é¢æ˜¯10ç‰‡ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Simple@Sharing SET: 5.9 seconds
Pipelined@Sharing SET: 0.794 seconds
Simple@Pool SET: 5.624 seconds
Pipelined@Pool SET: 0.762 seconds
</code></pre></div></div>

<p>ä¸‹é¢æ˜¯100ç‰‡ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Simple@Sharing SET: 14.055 seconds
Pipelined@Sharing SET: 8.185 seconds
Simple@Pool SET: 13.29 seconds
Pipelined@Pool SET: 7.767 seconds
</code></pre></div></div>

<p>åˆ†å¸ƒå¼ä¸­ï¼Œè¿æ¥æ± æ–¹å¼è°ƒç”¨ä¸ä½†çº¿ç¨‹å®‰å…¨å¤–ï¼Œæ ¹æ®ä¸Šé¢çš„æµ‹è¯•æ•°æ®ï¼Œä¹Ÿå¯ä»¥çœ‹å‡ºè¿æ¥æ± æ¯”ç›´è¿çš„æ•ˆç‡æ›´å¥½ã€‚</p>

<h3 id="åä¸€å®Œæ•´çš„æµ‹è¯•ä»£ç ">åä¸€ã€å®Œæ•´çš„æµ‹è¯•ä»£ç </h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package com.example.nosqlclient;

import java.util.Arrays;
import java.util.List;

import org.junit.AfterClass;
import org.junit.BeforeClass;
import org.junit.Test;

import redis.clients.jedis.Jedis;
import redis.clients.jedis.JedisPoolConfig;
import redis.clients.jedis.JedisShardInfo;
import redis.clients.jedis.Pipeline;
import redis.clients.jedis.ShardedJedis;
import redis.clients.jedis.ShardedJedisPipeline;
import redis.clients.jedis.ShardedJedisPool;
import redis.clients.jedis.Transaction;

import org.junit.FixMethodOrder;
import org.junit.runners.MethodSorters;

@FixMethodOrder(MethodSorters.NAME_ASCENDING)
public class TestJedis {

	private static Jedis jedis;
	private static ShardedJedis sharding;
	private static ShardedJedisPool pool;
	
	@BeforeClass
	public static void setUpBeforeClass() throws Exception {
		List&lt;JedisShardInfo&gt; shards = Arrays.asList(
				new JedisShardInfo("localhost",6379),
				new JedisShardInfo("localhost",6379)); //ä½¿ç”¨ç›¸åŒçš„ip:port,ä»…ä½œæµ‹è¯•
		
		
		jedis = new Jedis("localhost"); 
		sharding = new ShardedJedis(shards);
		
		pool = new ShardedJedisPool(new JedisPoolConfig(), shards);
	}

	@AfterClass
	public static void tearDownAfterClass() throws Exception {
		jedis.disconnect();
		sharding.disconnect();
		pool.destroy();
	}

	@Test
	public void test1Normal() {
		long start = System.currentTimeMillis();
		for (int i = 0; i &lt; 100000; i++) {
			String result = jedis.set("n" + i, "n" + i);
		}
		long end = System.currentTimeMillis();
		System.out.println("Simple SET: " + ((end - start)/1000.0) + " seconds");
	}
	
	@Test
	public void test2Trans() {
		long start = System.currentTimeMillis();
		Transaction tx = jedis.multi();
		for (int i = 0; i &lt; 100000; i++) {
			tx.set("t" + i, "t" + i);
		}
		//System.out.println(tx.get("t1000").get());
		
		List&lt;Object&gt; results = tx.exec();
		long end = System.currentTimeMillis();
		System.out.println("Transaction SET: " + ((end - start)/1000.0) + " seconds");
	}
	
	@Test
	public void test3Pipelined() {
		Pipeline pipeline = jedis.pipelined();
		long start = System.currentTimeMillis();
		for (int i = 0; i &lt; 100000; i++) {
			pipeline.set("p" + i, "p" + i);
		}
		//System.out.println(pipeline.get("p1000").get());
		List&lt;Object&gt; results = pipeline.syncAndReturnAll();
		long end = System.currentTimeMillis();
		System.out.println("Pipelined SET: " + ((end - start)/1000.0) + " seconds");
	}
	
	@Test
	public void test4combPipelineTrans() {
		long start = System.currentTimeMillis();
		Pipeline pipeline = jedis.pipelined();
		pipeline.multi();
		for (int i = 0; i &lt; 100000; i++) {
			pipeline.set("" + i, "" + i);
		}
		pipeline.exec();
		List&lt;Object&gt; results = pipeline.syncAndReturnAll();
		long end = System.currentTimeMillis();
		System.out.println("Pipelined transaction: " + ((end - start)/1000.0) + " seconds");
	}

	@Test
	public void test5shardNormal() {
		long start = System.currentTimeMillis();
		for (int i = 0; i &lt; 100000; i++) {
			String result = sharding.set("sn" + i, "n" + i);
		}
		long end = System.currentTimeMillis();
		System.out.println("Simple@Sharing SET: " + ((end - start)/1000.0) + " seconds");
	}
	
	@Test
	public void test6shardpipelined() {
		ShardedJedisPipeline pipeline = sharding.pipelined();
		long start = System.currentTimeMillis();
		for (int i = 0; i &lt; 100000; i++) {
			pipeline.set("sp" + i, "p" + i);
		}
		List&lt;Object&gt; results = pipeline.syncAndReturnAll();
		long end = System.currentTimeMillis();
		System.out.println("Pipelined@Sharing SET: " + ((end - start)/1000.0) + " seconds");
	}
	
	@Test
	public void test7shardSimplePool() {
		ShardedJedis one = pool.getResource();
		
		long start = System.currentTimeMillis();
		for (int i = 0; i &lt; 100000; i++) {
			String result = one.set("spn" + i, "n" + i);
		}
		long end = System.currentTimeMillis();
		pool.returnResource(one);
		System.out.println("Simple@Pool SET: " + ((end - start)/1000.0) + " seconds");
	}
	
	@Test
	public void test8shardPipelinedPool() {
		ShardedJedis one = pool.getResource();
		
		ShardedJedisPipeline pipeline = one.pipelined();
		
		long start = System.currentTimeMillis();
		for (int i = 0; i &lt; 100000; i++) {
			pipeline.set("sppn" + i, "n" + i);
		}
		List&lt;Object&gt; results = pipeline.syncAndReturnAll();
		long end = System.currentTimeMillis();
		pool.returnResource(one);
		System.out.println("Pipelined@Pool SET: " + ((end - start)/1000.0) + " seconds");
	}
}
</code></pre></div></div>

:ET