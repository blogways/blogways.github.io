I"·<p>åŸæ–‡ï¼š<a href="http://expressjs.com/guide/error-handling.html">http://expressjs.com/guide/error-handling.html</a></p>

<h2 id="é”™è¯¯å¤„ç†">é”™è¯¯å¤„ç†</h2>

<p>å®šä¹‰é”™è¯¯å¤„ç†ä¸­é—´ä»¶å’Œå®šä¹‰å…¶ä»–ä¸­é—´ä»¶ä¸€æ ·ï¼Œé™¤äº†éœ€è¦ 4 ä¸ªå‚æ•°ï¼Œè€Œä¸æ˜¯ 3 ä¸ªï¼Œå…¶æ ¼å¼å¦‚ä¸‹ (err, req, res, next)ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(function(err, req, res, next) {
  console.error(err.stack);
  res.status(500).send('Something broke!');
}); åœ¨å…¶ä»– app.use() å’Œè·¯ç”±è°ƒç”¨åï¼Œæœ€åå®šä¹‰é”™è¯¯å¤„ç†ä¸­é—´ä»¶ï¼Œæ¯”å¦‚ï¼š

var bodyParser = require('body-parser');
var methodOverride = require('method-override');

app.use(bodyParser());
app.use(methodOverride());
app.use(function(err, req, res, next) {
  // ä¸šåŠ¡é€»è¾‘
}); ä¸­é—´ä»¶è¿”å›çš„å“åº”æ˜¯éšæ„çš„ï¼Œå¯ä»¥å“åº”ä¸€ä¸ª HTML é”™è¯¯é¡µé¢ã€ä¸€å¥ç®€å•çš„è¯ã€ä¸€ä¸ª JSON å­—ç¬¦ä¸²ï¼Œæˆ–è€…å…¶ä»–ä»»ä½•æ‚¨æƒ³è¦çš„ä¸œè¥¿ã€‚
</code></pre></div></div>

<p>ä¸ºäº†ä¾¿äºç»„ç»‡ï¼ˆæ›´é«˜çº§çš„æ¡†æ¶ï¼‰ï¼Œæ‚¨å¯èƒ½ä¼šåƒå®šä¹‰å¸¸è§„ä¸­é—´ä»¶ä¸€æ ·ï¼Œå®šä¹‰å¤šä¸ªé”™è¯¯å¤„ç†ä¸­é—´ä»¶ã€‚æ¯”å¦‚æ‚¨æƒ³ä¸ºä½¿ç”¨ XHR çš„è¯·æ±‚å®šä¹‰ä¸€ä¸ªï¼Œè¿˜æƒ³ä¸ºæ²¡æœ‰ä½¿ç”¨çš„å®šä¹‰ä¸€ä¸ªï¼Œé‚£ä¹ˆï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var bodyParser = require('body-parser');
var methodOverride = require('method-override');

app.use(bodyParser());
app.use(methodOverride());
app.use(logErrors);
app.use(clientErrorHandler);
app.use(errorHandler);
</code></pre></div></div>

<p>logErrors å°†è¯·æ±‚å’Œé”™è¯¯ä¿¡æ¯å†™å…¥æ ‡å‡†é”™è¯¯è¾“å‡ºã€æ—¥å¿—æˆ–ç±»ä¼¼æœåŠ¡ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function logErrors(err, req, res, next) {
  console.error(err.stack);
  next(err);
} clientErrorHandler çš„å®šä¹‰å¦‚ä¸‹ï¼ˆæ³¨æ„è¿™é‡Œå°†é”™è¯¯ç›´æ¥ä¼ ç»™äº† nextï¼‰ï¼š

function clientErrorHandler(err, req, res, next) {
  if (req.xhr) {
    res.status(500).send({ error: 'Something blew up!' });
  } else {
    next(err);
  }
} errorHandler èƒ½æ•è·æ‰€æœ‰é”™è¯¯ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

function errorHandler(err, req, res, next) {
  res.status(500);
  res.render('error', { error: err });
} å¦‚æœå‘ next() ä¼ å…¥å‚æ•°ï¼ˆé™¤äº† â€˜routeâ€™ å­—ç¬¦ä¸²ï¼‰ï¼ŒExpress ä¼šè®¤ä¸ºå½“å‰è¯·æ±‚æœ‰é”™è¯¯çš„è¾“å‡ºï¼Œå› æ­¤è·³è¿‡åç»­å…¶ä»–éé”™è¯¯å¤„ç†å’Œè·¯ç”±/ä¸­é—´ä»¶å‡½æ•°ã€‚å¦‚æœéœ€åšç‰¹æ®Šå¤„ç†ï¼Œéœ€è¦åˆ›å»ºæ–°çš„é”™è¯¯å¤„ç†è·¯ç”±ï¼Œå¦‚ä¸‹èŠ‚æ‰€ç¤ºã€‚
</code></pre></div></div>

<p>å¦‚æœè·¯ç”±å¥æŸ„æœ‰å¤šä¸ªå›è°ƒå‡½æ•°ï¼Œå¯ä½¿ç”¨ â€˜routeâ€™ å‚æ•°è·³åˆ°ä¸‹ä¸€ä¸ªè·¯ç”±å¥æŸ„ã€‚æ¯”å¦‚ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.get('/a_route_behind_paywall', 
  function checkIfPaidSubscriber(req, res, next) {
    if(!req.user.hasPaid) { 
    
      // ç»§ç»­å¤„ç†è¯¥è¯·æ±‚
      next('route');
    }
  }, function getPaidContent(req, res, next) {
    PaidContent.find(function(err, doc) {
      if(err) return next(err);
      res.json(doc);
    });
}); åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¥æŸ„ getPaidContent ä¼šè¢«è·³è¿‡ï¼Œä½† app ä¸­ä¸º /a_route_behind_paywall å®šä¹‰çš„å…¶ä»–å¥æŸ„åˆ™ä¼šç»§ç»­æ‰§è¡Œã€‚
</code></pre></div></div>

<blockquote>
  <p>next() å’Œ next(err) ç±»ä¼¼äº Promise.resolve() å’Œ Promise.reject()ã€‚å®ƒä»¬è®©æ‚¨å¯ä»¥å‘ Express å‘ä¿¡å·ï¼Œå‘Šè¯‰å®ƒå½“å‰å¥æŸ„æ‰§è¡Œç»“æŸå¹¶ä¸”å¤„äºä»€ä¹ˆçŠ¶æ€ã€‚next(err) ä¼šè·³è¿‡åç»­å¥æŸ„ï¼Œé™¤äº†é‚£äº›ç”¨æ¥å¤„ç†é”™è¯¯çš„å¥æŸ„ã€‚</p>
</blockquote>

<h2 id="ç¼ºçœé”™è¯¯å¤„ç†å¥æŸ„">ç¼ºçœé”™è¯¯å¤„ç†å¥æŸ„</h2>

<p>Express å†…ç½®äº†ä¸€ä¸ªé”™è¯¯å¤„ç†å¥æŸ„ï¼Œå®ƒå¯ä»¥æ•è·åº”ç”¨ä¸­å¯èƒ½å‡ºç°çš„ä»»æ„é”™è¯¯ã€‚è¿™ä¸ªç¼ºçœçš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶å°†è¢«æ·»åŠ åˆ°ä¸­é—´ä»¶å †æ ˆçš„åº•éƒ¨ã€‚</p>

<p>å¦‚æœä½ å‘ next() ä¼ é€’äº†ä¸€ä¸ª error ï¼Œè€Œä½ å¹¶æ²¡æœ‰åœ¨é”™è¯¯å¤„ç†å¥æŸ„ä¸­å¤„ç†è¿™ä¸ª errorï¼ŒExpress å†…ç½®çš„ç¼ºçœé”™è¯¯å¤„ç†å¥æŸ„å°±æ˜¯æœ€åå…œåº•çš„ã€‚æœ€åé”™è¯¯å°†è¢«è¿åŒå †æ ˆè¿½è¸ªä¿¡æ¯ä¸€åŒåé¦ˆåˆ°å®¢æˆ·ç«¯ã€‚å †æ ˆè¿½è¸ªä¿¡æ¯å¹¶ä¸ä¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­åé¦ˆåˆ°å®¢æˆ·ç«¯ã€‚</p>

<blockquote>
  <p>è®¾ç½®ç¯å¢ƒå˜é‡ NODE_ENV ä¸º â€œproductionâ€ å°±å¯ä»¥è®©åº”ç”¨è¿è¡Œåœ¨ç”Ÿäº§ç¯å¢ƒæ¨¡å¼ä¸‹ã€‚</p>
</blockquote>

<p>å¦‚æœä½ å·²ç»å¼€å§‹å‘ response è¾“å‡ºæ•°æ®äº†ï¼Œè¿™æ—¶æ‰è°ƒç”¨ next() å¹¶ä¼ é€’äº†ä¸€ä¸ª errorï¼Œæ¯”å¦‚ä½ åœ¨å°†å‘å®¢æˆ·ç«¯è¾“å‡ºæ•°æ®æµæ—¶é‡åˆ°ä¸€ä¸ªé”™è¯¯ï¼ŒExpress å†…ç½®çš„ç¼ºçœé”™è¯¯å¤„ç†å¥æŸ„å°†å¸®ä½ å…³é—­è¿æ¥å¹¶å‘ŠçŸ¥ request è¯·æ±‚å¤±è´¥ã€‚</p>

<p>å› æ­¤ï¼Œå½“ä½ æ·»åŠ äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„é”™è¯¯å¤„ç†å¥æŸ„åï¼Œå¦‚æœå·²ç»å‘å®¢æˆ·ç«¯å‘é€åŒ…å¤´ä¿¡æ¯äº†ï¼Œä½ è¿˜å¯ä»¥å°†é”™è¯¯å¤„ç†äº¤ç»™ Express å†…ç½®çš„é”™è¯¯å¤„ç†æœºåˆ¶ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function errorHandler(err, req, res, next) {
  if (res.headersSent) {
    return next(err);
  }
  res.status(500);
  res.render('error', { error: err });
}
</code></pre></div></div>
:ET