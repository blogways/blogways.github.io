I"±½<p>åŸæ–‡ï¼š<a href="http://expressjs.com/en/3x/api.html">http://expressjs.com/en/3x/api.html</a></p>

<h2 id="ä¸€express">ä¸€ã€express()</h2>

<p>åˆ›å»ºä¸€ä¸ªexpressåº”ç”¨ç¨‹åºï¼Œexpress()å‡½æ•°æ˜¯ä¸€ä¸ªé¡¶å±‚å‡½æ•°expressæ¨¡å—çš„å¯¼å‡ºã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var express = require('express');	
var app = express();	

app.get('/', function(req, res){	
res.send('hello world');	
});	

app.listen(3000);	
</code></pre></div></div>

<h2 id="äºŒapplicationåº”ç”¨">äºŒã€Applicationï¼ˆåº”ç”¨ï¼‰</h2>

<h3 id="appsetnamevalue">app.set(name,value)</h3>

<p>ç”¨ç”¨äºæŒ‡å®šå˜é‡çš„å€¼ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.set('title', 'My Site');    
app.get('title');	
// =&gt; "My Site"		
</code></pre></div></div>

<h3 id="appgetname">app.get(name)</h3>

<p>è·å¾—è®¾ç½®é¡¹çš„å€¼</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.get('title');    
// =&gt; undefined		

app.set('title', 'My Site');  
app.get('title');  
// =&gt; "My Site"	
</code></pre></div></div>

<h3 id="appenablename">app.enable(name)</h3>

<p>å°†è®¾ç½®é¡¹ name çš„å€¼è®¾ä¸º true ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.enable('trust proxy');  
app.get('trust proxy');  
// =&gt; true	
</code></pre></div></div>

<h3 id="appdisablename">app.disable(name)</h3>

<p>å°†è®¾ç½®é¡¹ name çš„å€¼è®¾ä¸º false ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.disable('trust proxy');  
app.get('trust proxy');  
// =&gt; false	
</code></pre></div></div>

<h3 id="appenabledname">app.enabled(name)</h3>

<p>æ£€æŸ¥è®¾ç½®é¡¹ name æ˜¯å¦å·²å¯ç”¨ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.enabled('trust proxy');	  
// =&gt; false	  
app.enable('trust proxy');  
app.enabled('trust proxy');	  
// =&gt; true	
</code></pre></div></div>

<h3 id="appdisabledname">app.disabled(name)</h3>

<p>æ£€æŸ¥è®¾ç½®é¡¹ name æ˜¯å¦å·²ç¦ç”¨ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.disabled('trust proxy');  
// =&gt; true	

app.enable('trust proxy');	
app.disabled('trust proxy');  	
// =&gt; false	
</code></pre></div></div>

<h3 id="appconfigureenv-callback">app.configure([env], callback)</h3>

<p>å½“ env å’Œ app.get(â€˜envâ€™) (ä¹Ÿå°±æ˜¯ process.env.NODE_ENV) åŒ¹é…æ—¶, è°ƒç”¨ callback ã€‚		
ä¿ç•™è¿™ä¸ªæ–¹æ³•æ˜¯å‡ºäºå†å²åŸå› ï¼Œåé¢åˆ—å‡ºçš„ if è¯­å¥çš„ä»£ç å…¶å®æ›´åŠ é«˜æ•ˆã€ç›´æ¥ã€‚  		
ä½¿ç”¨ app.set é…åˆå…¶å®ƒä¸€äº›é…ç½®æ–¹æ³•å,æ²¡æœ‰å¿…è¦å†ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	// æ‰€æœ‰ç¯å¢ƒ  

	app.configure(function(){    
	app.set('title', 'My Application');		
	})		
	
	// å¼€å‘ç¯å¢ƒ  
	app.configure('development', function(){  
	app.set('db uri', 'localhost/dev');  
	})	

	// åªç”¨äºç”Ÿäº§ç¯å¢ƒ	
	app.configure('production', function(){	
	app.set('db uri', 'n.n.n.n/prod');  
	})	
</code></pre></div></div>

<p>æ›´é«˜æ•ˆä¸”ç›´æ¥çš„ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	// æ‰€æœ‰ç¯å¢ƒ	
	app.set('title', 'My Application');	
	// åªç”¨äºå¼€å‘ç¯å¢ƒ	
	if ('development' == app.get('env')) {	
	app.set('db uri', 'localhost/dev');	
	}	
	// åªç”¨äºç”Ÿäº§ç¯å¢ƒ	
	if ('production' == app.get('env')) {	
	app.set('db uri', 'n.n.n.n/prod');	
	}	
</code></pre></div></div>

<h3 id="appusepath-function">app.use([path], function)</h3>

<p>ä½¿ç”¨ä¸­é—´ä»¶ functionï¼Œå¯é€‰å‚æ•° path é»˜è®¤æ˜¯ â€œ/â€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	var express = require('express');  
	var app = express();	
	
	// ä¸€ä¸ªç®€å•çš„ logger  
	app.use(function(req, res, next){	
	console.log('%s %s', req.method, req.url);	
  	next();	
	});	
	
	// å“åº”
	app.use(function(req, res, next){  
	res.send('Hello World');	
	});  
	
	app.listen(3000);  
</code></pre></div></div>

<p>æŒ‚è½½è·¯å¾„è¢«å‰¥ç¦»å‡ºæ¥ï¼Œå¯¹äºä¸­é—´ä»¶å‡½æ•°æ¥è¯´æ˜¯ä¸å¯è§çš„ã€‚	
è¿™ä¹ˆè®¾è®¡æ˜¯ä¸ºäº†è®©ä¸­é—´ä»¶åœ¨ä¸ç”¨ä¿®æ”¹ä»»ä½•ä»£ç çš„æƒ…å†µä¸‹å°±å¯ä»¥åœ¨ä»»æ„å‰ç¼€çš„è·¯å¾„ä¸‹æ‰§è¡Œã€‚</p>

<p>è·¯ç”±å°†åŒ¹é…ä»»ä½•è·¯å¾„ï¼Œä»¥éµå¾ªâ€œ/â€ã€â€œ./â€ã€‚	
ä¾‹å¦‚ï¼šapp.use(â€˜/appleâ€™,â€¦)å°†ä¼šåŒ¹é… /apple, /apple/images, /apple/images/news, /apple.html,/apple.html.txtç­‰ç­‰ã€‚</p>

<p>è¿™é‡Œæœ‰ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œé€šè¿‡express.static()æ–¹æ³•ä½¿ç”¨./publicæ¥ç®¡ç†æ–‡ä»¶æœåŠ¡ç”¨ä¾‹çš„ä¸­é—´ä»¶ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// GET /javascripts/jquery.js	
// GET /style.css	
// GET /favicon.ico	
app.use(express.static(__dirname + '/public'));	
</code></pre></div></div>

<p>ä¾‹å¦‚ä½ æƒ³ä¸ºè‡ªæœ‰çš„é™æ€æ–‡ä»¶å¢åŠ å‰ç¼€â€™/staticâ€™ï¼Œä½ å¯ä»¥ä½¿ç”¨â€™mountingâ€™åŠŸèƒ½ã€‚	
æŒ‚è½½çš„ä¸­é—´ä»¶å‡½æ•°ä¸ä¼šè¢«è°ƒç”¨ï¼Œé™¤éreq.urlåŒ…å«è¿™ä¸ªå‰ç¼€ï¼Œå½“å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå‰ç¼€æ˜¯è¢«å‰¥ç¦»å‡ºå»çš„ã€‚	
å½“ç„¶è¿™åªä¼šå½±å“åˆ°è¿™ä¸ªå‡½æ•°ï¼ŒæŒ‚è½½å¥½åéšåçš„ä¸­é—´ä»¶è¿˜æ˜¯ä¼šé€šè¿‡åŒ…å«/staticçš„req.urlæŸ¥çœ‹åˆ°ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// GET /static/javascripts/jquery.js	
// GET /static/style.css	
// GET /static/favicon.ico	
app.use('/static', express.static(__dirname + '/public'));
</code></pre></div></div>

<p>ä¸­é—´ä»¶ä½¿ç”¨app.use()å®šä¹‰çš„é¡ºåºæ˜¯éå¸¸é‡è¦çš„ï¼Œå®ƒä»¬ä¾æ¬¡è¢«è°ƒç”¨ï¼Œå› æ­¤è¿™ä¸ªå†³å®šäº†ä¸­é—´ä»¶çš„ä¼˜å…ˆçº§ã€‚	
ä¾‹å¦‚ï¼Œä¸€èˆ¬æ¥è¯´æ—¥å¿—ä¸­é—´ä»¶æ˜¯ä½ è¦ç”¨åˆ°çš„ç¬¬ä¸€ä¸ªä¸­é—´ä»¶ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(express.logger());	
app.use(express.static(__dirname + '/public'));
app.use(function(req, res){
res.send('Hello');
});	
</code></pre></div></div>

<p>ç°åœ¨å‡è®¾ä½ æƒ³å¿½ç•¥é™æ€æ–‡ä»¶çš„è¯·æ±‚æ—¥å¿—ï¼Œ	
ä½†åˆæƒ³åœ¨logger()å®šä¹‰ä¹‹åç»§ç»­ä½¿ç”¨æ—¥å¿—è·¯ç”±ï¼Œä½ åªéœ€è¦å°†static()ç§»åŠ¨å‰é¢å°±å¯ä»¥äº†ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(express.static(__dirname + '/public'));	
app.use(logger());	
app.use(function(req, res){	
res.send('Hello');	
});	
</code></pre></div></div>

<p>å¦ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ˜¯ä»ä¼—å¤šçš„ç›®å½•æ–‡ä»¶æœåŠ¡ä¸­ï¼Œç»™äºˆâ€./publicâ€æœ€é«˜çš„ä¼˜å…ˆçº§ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(express.static(__dirname + '/public'));		
app.use(express.static(__dirname + '/files'));			
app.use(express.static(__dirname + '/uploads'));  	
</code></pre></div></div>

<h3 id="settings">settings</h3>

<p>ä¸‹é¢çš„å†…å»ºçš„å¯ä»¥æ”¹å˜ Express è¡Œä¸ºçš„è®¾ç½®ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>env è¿è¡Œæ—¶ç¯å¢ƒï¼Œé»˜è®¤ä¸º process.env.NODE_ENV æˆ–è€… â€œdevelopmentâ€
trust proxy æ¿€æ´»åå‘ä»£ç†ï¼Œé»˜è®¤æ˜¯æœªæ¿€æ´»çŠ¶æ€
jsonp callback name ä¿®æ”¹ ?callback= çš„é»˜è®¤ callback çš„åå­—
json replacer JSON æ›¿æ¢æ—¶çš„å›è°ƒ, é»˜è®¤ä¸º null
json spaces JSON å“åº”è¢«æ ¼å¼åŒ–æ—¶çš„ç©ºæ ¼æ•°é‡ï¼Œå¼€å‘ç¯å¢ƒä¸‹æ˜¯ 2 ï¼Œç”Ÿäº§ç¯å¢ƒæ˜¯ 0
case sensitive routing è·¯ç”±çš„å¤§å°å†™æ•æ„Ÿ, é»˜è®¤æ˜¯å…³é—­çŠ¶æ€ï¼Œâ€/Fooâ€ å’Œ â€œ/fooâ€ è¢«è®¤ä¸ºæ˜¯ä¸€æ ·çš„
strict routingè·¯ç”±çš„ä¸¥æ ¼æ ¼å¼, é»˜è®¤æƒ…å†µä¸‹ â€œ/fooâ€ å’Œ â€œ/foo/â€ è¢«è·¯ç”±è®¤ä¸ºæ˜¯ä¸€æ ·çš„
view cache Eæ¨¡æ¿ç¼“å­˜ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯é»˜è®¤å¼€å¯çš„
view engine é»˜è®¤çš„æ¨¡æ¿å¼•æ“
views æ¨¡æ¿çš„ç›®å½•, é»˜è®¤æ˜¯ â€œprocess.cwd() + â€˜/viewsâ€™â€ 
</code></pre></div></div>

<h3 id="appengineext-callback">app.engine(ext, callback)</h3>

<p>æ³¨å†Œæ¨¡æ¿å¼•æ“çš„ callback ç”¨æ¥å¤„ç† ext æ‰©å±•åçš„æ–‡ä»¶ã€‚
æ³¨å†Œç»™å®šçš„æ¨¡æ¿å¼•æ“çš„callbacké»˜è®¤ç”¨æ¥å¤„ç†æ‰©å±•åä¸ºextçš„æ–‡ä»¶ã€‚
ä¾‹å¦‚ï¼Œå¦‚æœä½ è¯•å›¾æ¸²æŸ“ä¸€ä¸ªâ€foo.jadeâ€æ–‡ä»¶ï¼ŒExpresså°†åœ¨å†…éƒ¨è°ƒç”¨ä»¥ä¸‹ä»£ç ï¼Œå¹¶ç¼“å­˜require()ç»™åç»­è°ƒç”¨ä»¥æé«˜æ€§èƒ½ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.engine('jade', require('jade').__express);
</code></pre></div></div>

<p>å¼•æ“æ²¡æœ‰æä¾›._expressæ¸²æŸ“æ–¹æ³•ï¼Œæˆ–è€…ä½ æƒ³æ˜ å°„ä¸€ä¸ªä¸ä¸€æ ·çš„æ‰©å±•ååœ¨æ¨¡æ¿å¼•æ“ä¸Šï¼Œä½ å¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•ã€‚
ä¾‹å¦‚æ˜ å°„EJSæ¨¡æ¿å¼•æ“æ¥æ¸²æŸ“â€.htmlâ€æ–‡ä»¶ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.engine('html', require('ejs').renderFile);
</code></pre></div></div>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒEJSæä¾›.renderFile()æ–¹æ³•ä½¿ç”¨Expresså®šä¹‰çš„å‚æ•°ï¼š(path, options, callback)ï¼Œ
ä½†è¦æ³¨æ„è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨å†…éƒ¨ç»™ejs._expresså–ä¸€ä¸ªåˆ«åï¼Œå¦‚æœä½ ä½¿ç”¨â€.ejsâ€å¯ä»¥ä»€ä¹ˆéƒ½ä¸è¦åšã€‚</p>

<p>æœ‰äº›æ¨¡æ¿å¼•æ“å¹¶ä¸éµå¾ªè¿™ä¸€è§„åˆ™ï¼Œconsolidate.jsåº“çš„å»ºç«‹æ˜¯ä¸ºäº†æ˜ å°„æ‰€æœ‰çš„nodeæµè¡Œæ¨¡æ¿å¼•æ“éµå¾ªè¿™ä¸€è§„åˆ™ï¼Œ
ä»è€Œä½¿å¾—ä»–ä»¬åœ¨Expresså†…æ— ç¼å·¥ä½œã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var engines = require('consolidate');
app.engine('haml', engines.haml);
app.engine('html', engines.hogan);  
</code></pre></div></div>

<h3 id="appparamname-callback">app.param([name], callback)</h3>
<p>æ˜ å°„è·¯ç”±å‚æ•°è§„åˆ™ã€‚<br />
ä¾‹å¦‚å½“:userå­˜åœ¨äºä¸€ä¸ªè·¯ç”±è·¯å¾„ä¸­ï¼Œä½ éœ€è¦è‡ªåŠ¨æä¾›req.userç»™è·¯ç”±æ˜ å°„å¯åŠ¨é€»è¾‘ï¼Œæˆ–è€…æ‰§è¡Œè¾“å…¥å‚æ•°éªŒè¯ã€‚</p>

<p>ä¸‹é¢çš„ä»£ç è¯´æ˜äº†å¦‚æœcallbackå¾ˆåƒä¸­é—´ä»¶ï¼Œä»è€Œæ”¯æŒå¼‚å¸¸æ“ä½œï¼Œ
ä½†å´å¢åŠ äº†ä¸€ä¸ªå‚æ•°ï¼Œè¿™é‡Œå‘½åä¸ºidã€‚ç„¶åå°è¯•æ‰§è¡ŒåŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œèµ‹å€¼ç»™req.userï¼Œå¦åˆ™ä¼ é€’ä¸€ä¸ªé”™è¯¯åˆ°next(err)ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.param('user', function(req, res, next, id){
	User.find(id, function(err, user){
		if (err) {
  		next(err);
			} else if (user) {
  				req.user = user;
  				next();
			} else {
  					next(new Error('failed to load user'));
					}
				});
});  
</code></pre></div></div>

<p>å¦å¤–ï¼Œä½ å¯èƒ½åªä¼ é€’ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œ
åœ¨è¿™ç§æƒ…å†µä¸‹ä½ æœ‰æœºä¼šæ”¹å˜app.param()APIã€‚ä¾‹å¦‚express-paramså®šä¹‰äº†ä¸‹é¢çš„å›è°ƒå‡½æ•°ï¼Œå®ƒå…è®¸ä½ ä½¿ç”¨ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼é™åˆ¶å‚æ•°ã€‚</p>

<p>è¿™ä¸ªä¾‹å­æœ‰ç‚¹æ›´å…ˆè¿›ï¼Œæ£€æŸ¥å½“ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿”å›å›è°ƒå‡½æ•°å¾ˆåƒâ€userâ€å‚æ•°ä¾‹å­ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.param(function(name, fn){
	if (fn instanceof RegExp) {
	return function(req, res, next, val){
  	var captures;
  	if (captures = fn.exec(String(val))) {
    req.params[name] = captures;
    next();
  	} else {
    		next('route');
  			}
		}
	}
}); è¯¥æ–¹æ³•å¯ä»¥è¢«ç”¨æ¥æœ‰æ•ˆçš„éªŒè¯å‚æ•°ï¼Œæˆ–è€…è§£ææä¾›åŒ¹é…åˆ†ç»„ï¼š

app.param('id', /^\d+$/);  

app.get('/user/:id', function(req, res){
res.send('user ' + req.params.id);
});
app.param('range', /^(\w+)\.\.(\w+)?$/);

app.get('/range/:range', function(req, res){
	var range = req.params.range;
res.send('from ' + range[1] + ' to ' + range[2]);
});
</code></pre></div></div>

<h3 id="appverbpath-callback-callback">app.VERB(path, [callbackâ€¦], callback)</h3>

<p>Expressä¸­App.WEB()æ–¹æ³•æä¾›äº†è·¯ç”±åŠŸèƒ½ï¼Œå…¶ä¸­VERBæ˜¯ä¸€ä¸ªHTTPåŠ¨ä½œï¼Œè·Ÿapp.post()ç±»ä¼¼ã€‚
å¯æä¾›å¤šä¸ªå›è°ƒå‡½æ•°ï¼Œéƒ½æ˜¯ä¸€è§†åŒä»ï¼Œè¡¨ç°è·Ÿä¸­é—´ä»¶ä¸€æ ·ï¼Œå”¯ä¸€ä¸ä¸€æ ·çš„æ˜¯é€šè¿‡è°ƒç”¨next(â€˜routeâ€™)æ¥ç»§ç»­å…¶ä½™çš„è·¯ç”±å›è°ƒã€‚
è¿™ä¸ªæœºåˆ¶å¯ä»¥ç”¨æ¥æ‰§è¡Œè·¯ç”±çš„å‰ææ¡ä»¶ï¼Œç„¶åå°†æ§åˆ¶æƒä¼ é€’ç»™éšåçš„è·¯ç”±ï¼Œæ²¡æœ‰ç†ç”±è¿›è¡Œè·¯ç”±çš„åŒ¹é…ã€‚</p>

<p>ä¸‹é¢çš„ä»£ç è¯´æ˜äº†å¤šä¸ªç®€å•è·¯ç”±å®šä¹‰çš„å¯è¡Œæ€§ã€‚Expresså°†è·¯å¾„å­—ç¬¦ä¸²è½¬æ¢æˆæ­£ç”±è¡¨è¾¾å¼ï¼Œç”¨æ¥åœ¨å†…éƒ¨åŒ¹é…åˆ°æ¥çš„è¯·æ±‚ã€‚
åœ¨æ‰§è¡Œè¿™äº›åŒ¹é…æ—¶æŸ¥è¯¢å­—ç¬¦ä¸²ä¸è€ƒè™‘ï¼Œä¾‹å¦‚â€GET /â€å°†åŒ¹é…ä»¥ä¸‹çš„è·¯ç”±ï¼Œå¦‚â€GET /?name=tobiâ€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.get('/', function(req, res){
	res.send('hello world');
});
</code></pre></div></div>

<p>æ­£ç”±è¡¨è¾¾å¼ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œå¦‚æœä½ æœ‰éå¸¸ç‰¹æ®Šçš„é™åˆ¶å¯èƒ½æ˜¯æœ‰ç”¨çš„ï¼Œ
ä¾‹å¦‚ä¸‹é¢çš„â€GET /commits/71dbb9câ€è¡¨è¾¾å¼å°†å¾ˆå¥½çš„åŒ¹é…â€GET /commits/71dbb9c..4c084f9â€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.get(/^\/commits\/(\w+)(?:\.\.(\w+))?$/, function(req, res){
	var from = req.params[0];
	var to = req.params[1] || 'HEAD';
res.send('commit range ' + from + '..' + to);
});
</code></pre></div></div>

<p>å¯ä»¥ä¼ é€’ä¸€äº›å›è°ƒå‡½æ•°ï¼Œå¯¹äºåˆ©ç”¨ä¸­é—´ä»¶åŠ è½½èµ„æºã€æ‰§è¡ŒéªŒè¯ç­‰å¾ˆæœ‰ç”¨ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.get('/user/:id', user.load, function(){
// ... 
})
</code></pre></div></div>

<p>å¦‚æœä½ æœ‰å¤šä¸ªå…±åŒçš„ä¸­é—´ä»¶è·¯ç”±ï¼Œå¯ä»¥ä½¿ç”¨è·¯ç”±apiçš„allã€‚ä¸¤ä¸ªä¸­é—´ä»¶å°†ç”¨æ¥å¤„ç†GETå’ŒPOSTè¯·æ±‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var middleware = [loadForum, loadThread];

app.route('/forum/:fid/thread/:tid')
	.all(loadForum)
	.all(loadThread)
	.get(function() { //... });
	.post(function() { //... });
</code></pre></div></div>

<h3 id="appallpath-callback-callback">app.all(path, [callbackâ€¦], callback)</h3>

<p>æ­¤æ–¹æ³•åŠŸèƒ½å°±åƒapp.VERB()æ–¹æ³•ï¼Œä½†å®ƒåŒ¹é…æ‰€æœ‰HTTPçš„åŠ¨ä½œã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.all('*', requireAuthentication, loadUser);
</code></pre></div></div>

<p>ç­‰ä»·äºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.all('*', requireAuthentication)
app.all('*', loadUser);
</code></pre></div></div>

<p>å¦ä¸€ä¸ªéå¸¸èµçš„ä¾‹å­æ˜¯â€œå…¨å±€â€ç™½åå•å‡½æ•°ã€‚
è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­è·Ÿå‰ä¸€ä¸ªå¾ˆåƒï¼Œä½†æ˜¯å®ƒé™åˆ¶å‰ç¼€ä¸º â€œ/apiâ€:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.all('/api/*', requireAuthentication);
</code></pre></div></div>

<h3 id="applocals">app.locals</h3>

<p>åº”ç”¨æœ¬åœ°å˜é‡ä¼šé™„åŠ ç»™æ‰€æœ‰çš„åœ¨è¿™ä¸ªåº”ç”¨ç¨‹åºå†…æ¸²æŸ“çš„æ¨¡æ¿ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ¨¡æ¿å‡½æ•°ï¼Œå°±åƒåº”ç”¨ç¨‹åºçº§æ•°æ®ä¸€æ ·ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.locals.title = 'My App';
app.locals.strftime = require('strftime');
</code></pre></div></div>

<p>app.locals å¯¹è±¡æ˜¯ä¸€ä¸ª JavaScript Functionï¼Œæ‰§è¡Œçš„æ—¶å€™å®ƒä¼šæŠŠå±æ€§åˆå¹¶åˆ°å®ƒè‡ªèº«ï¼Œ
æä¾›äº†ä¸€ç§ç®€å•å±•ç¤ºå·²æœ‰å¯¹è±¡ä½œä¸ºæœ¬åœ°å˜é‡çš„æ–¹æ³•ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.locals({
  title: 'My App',
  phone: '1-250-858-9990',
  email: 'me@myapp.com'
});

app.locals.title
// =&gt; 'My App'

app.locals.email
// =&gt; 'me@myapp.com'
</code></pre></div></div>

<p>app.locals å¯¹è±¡æœ€ç»ˆä¼šæ˜¯ä¸€ä¸ª Javascript å‡½æ•°å¯¹è±¡ï¼Œä½ ä¸å¯ä»¥ä½¿ç”¨ Functions å’Œ Objects å†…ç½®çš„å±æ€§ï¼Œ
æ¯”å¦‚ nameã€applyã€bindã€callã€argumentsã€lengthã€constructorã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.locals({name: 'My App'});

app.locals.name
// =&gt; è¿”å› 'app.locals' è€Œä¸æ˜¯ 'My App' (app.locals æ˜¯ä¸€ä¸ªå‡½æ•° !)
// =&gt; å¦‚æœ name å˜é‡ç”¨åœ¨ä¸€ä¸ªæ¨¡æ¿é‡Œï¼Œåˆ™è¿”å›ä¸€ä¸ª ReferenceError ã€‚
</code></pre></div></div>

<p>å…¨éƒ¨çš„ä¿ç•™å­—åˆ—è¡¨å¯ä»¥åœ¨å¾ˆå¤šè§„èŒƒé‡Œæ‰¾åˆ°ã€‚ JavaScript è§„èŒƒä»‹ç»äº†åŸæ¥çš„å±æ€§ï¼Œ
æœ‰ä¸€äº›è¿˜ä¼šè¢«ç°ä»£çš„ JavaScript å¼•æ“è¯†åˆ«ï¼ŒEcmaScript è§„èŒƒåœ¨å®ƒçš„åŸºç¡€ä¸Šï¼Œ
ç»Ÿä¸€äº†å€¼ï¼Œæ·»åŠ äº†ä¸€äº›ï¼Œåˆ é™¤äº†ä¸€äº›åºŸå¼ƒçš„ã€‚å¦‚æœæ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹çœ‹ Functions å’Œ Objects çš„å±æ€§å€¼ã€‚</p>

<p>é»˜è®¤æƒ…å†µä¸‹Expressåªæœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºçº§æœ¬åœ°å˜é‡ï¼Œå®ƒæ˜¯ settingsã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.set('title', 'My App');
// åœ¨ view é‡Œä½¿ç”¨ settings.title
</code></pre></div></div>

<h3 id="apprenderview-options-callback">app.render(view, [options], callback)</h3>

<p>ä½¿ç”¨å›è°ƒå‡½æ•°è¿”å›çš„æ¸²æŸ“å­—ç¬¦ä¸²æ¸²æŸ“è§†å›¾ã€‚è¿™æ˜¯res.render()çš„åº”ç”¨ç¨‹åºçº§åˆ«çš„ç‰ˆæœ¬ï¼Œå®ƒä»¬çš„è¡Œä¸ºæ˜¯ä¸€æ ·çš„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.render('email', function(err, html){
  // ...
});

app.render('email', { name: 'Tobi' }, function(err, html){
  // ...
});
</code></pre></div></div>

<h3 id="approutes">app.routes</h3>

<p>The app.routes å¯¹è±¡å­˜å‚¨äº†æ‰€æœ‰çš„è¢« HTTP åŠ¨ä½œå®šä¹‰çš„è·¯ç”±ã€‚è¿™ä¸ªå¯¹è±¡å¯ä»¥ç”¨åœ¨ä¸€äº›å†…éƒ¨åŠŸèƒ½ä¸Šï¼Œ
æ¯”å¦‚ Express ä¸ä»…ç”¨å®ƒæ¥åšè·¯ç”±åˆ†å‘ï¼ŒåŒæ—¶åœ¨æ²¡æœ‰ app.options() å®šä¹‰çš„æƒ…å†µä¸‹ç”¨å®ƒæ¥å¤„ç†é»˜è®¤çš„
OPTIONS
è¡Œä¸ºã€‚ä½ çš„åº”ç”¨ç¨‹åºæˆ–è€…æ¡†æ¶ä¹Ÿå¯ä»¥å¾ˆè½»æ¾çš„é€šè¿‡åœ¨è¿™ä¸ªå¯¹è±¡é‡Œç§»é™¤è·¯ç”±æ¥è¾¾åˆ°åˆ é™¤è·¯ç”±çš„ç›®çš„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>console.log(app.routes)

{ get: 
   [ { path: '/',
       method: 'get',
       callbacks: [Object],
       keys: [],
       regexp: /^\/\/?$/i },
     { path: '/user/:id',
       method: 'get',
       callbacks: [Object],
       keys: [{ name: 'id', optional: false }],
       regexp: /^\/user\/(?:([^\/]+?))\/?$/i } ],
  delete: 
   [ { path: '/user/:id',
       method: 'delete',
       callbacks: [Object],
       keys: [Object],
       regexp: /^\/user\/(?:([^\/]+?))\/?$/i } ] }

app.listen()
</code></pre></div></div>

<p>åœ¨ç»™å®šçš„ä¸»æœºå’Œç«¯å£ä¸Šç›‘å¬è¯·æ±‚ï¼Œè¿™ä¸ªå’Œ node æ–‡æ¡£ä¸­çš„ http.Server#listen() æ˜¯ä¸€è‡´çš„ã€‚
	var express = require(â€˜expressâ€™);
	var app = express();
	app.listen(3000);</p>

<p>express() è¿”å›çš„ app å®é™…ä¸Šæ˜¯ä¸€ä¸ª JavaScript  Function,å®ƒè¢«è®¾è®¡ä¸ºä¼ ç»™ node çš„ http servers ä½œä¸ºå¤„ç†è¯·æ±‚çš„å›è°ƒå‡½æ•°ã€‚
å› ä¸º app ä¸æ˜¯ä» HTTP æˆ–è€… HTTPS ç»§æ‰¿æ¥çš„ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç®€å•çš„å›è°ƒå‡½æ•°ï¼Œä½ å¯ä»¥ä»¥åŒä¸€ä»½ä»£ç åŒæ—¶å¤„ç† HTTP å’Œ HTTPS ç‰ˆæœ¬çš„æœåŠ¡ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var express = require('express');
var https = require('https');
var http = require('http');
var app = express();

http.createServer(app).listen(80);
https.createServer(options, app).listen(443);
</code></pre></div></div>

<h2 id="ä¸‰request">ä¸‰ã€Request</h2>

<h3 id="reqparams">req.params</h3>

<p>æ­¤å±æ€§æ˜¯ä¸€ä¸ªåŒ…å«æ˜ å°„è·¯ç”±â€parametersâ€çš„å¯¹è±¡ã€‚ä¾‹å¦‚ä½ ä½¿ç”¨/user/:nameè·¯ç”±ï¼Œé‚£ä¹ˆâ€nameâ€å±æ€§å¯¹ä½ æ¥è¯´å°±æ˜¯ä¸€ä¸ªreq.params.nameå˜é‡ã€‚
è¯¥å¯¹è±¡é»˜è®¤ä¸º{}ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// GET /user/tj
req.params.name
// =&gt; "tj"
</code></pre></div></div>

<p>å½“åœ¨å®šä¹‰è·¯ç”±è§„åˆ™æ—¶ä½¿ç”¨äº†æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½¿ç”¨req.params[N]è·å–æ‰€æœ‰å‚æ•°åŒ¹é…æ•°ç»„ï¼Œå…¶ä¸­Nè¡¨ç¤ºæ•°ç»„çš„ç¬¬å‡ ä¸ªã€‚æ­¤è§„åˆ™é€‚ç”¨äºåŒ…å«æœªå®šä¹‰çš„é€šé…ç¬¦çš„è·¯ç”±å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚/file/*ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// GET /file/javascripts/jquery.js
req.params[0]
// =&gt; "javascripts/jquery.js"

req.query æ­¤å±æ€§æ˜¯ä¸€ä¸ªåŒ…å«è§£ææŸ¥è¯¢å­—ç¬¦ä¸²çš„å¯¹è±¡ï¼Œé»˜è®¤ä¸º{}ã€‚

// GET /search?q=tobi+ferret
req.query.q
// =&gt; "tobi ferret"

// GET /shoes?order=desc&amp;shoe[color]=blue&amp;shoe[type]=converse
req.query.order
// =&gt; "desc"

req.query.shoe.color
// =&gt; "blue"

req.query.shoe.type
// =&gt; "converse"
</code></pre></div></div>

<h3 id="reqbody">req.body</h3>

<p>æ­¤å±æ€§æ˜¯ä¸€ä¸ªåŒ…å«è§£æçš„è¯·æ±‚ä½“çš„å¯¹è±¡ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯æä¾›ä¸€ä¸ªbodyParser()ä¸­é—´ä»¶ã€‚è™½ç„¶å…¶ä»–çš„ä½“è§£æä¸­é—´ä»¶ä¹Ÿéµå¾ªæ­¤çº¦å®šï¼Œ
å½“ä½¿ç”¨bodyparserï¼ˆï¼‰ä½¿ç”¨æ—¶ï¼Œé»˜è®¤å€¼ä¸º{}ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// POST user[name]=tobi&amp;user[email]=tobi@learnboost.com
req.body.user.name
// =&gt; "tobi"

req.body.user.email
// =&gt; "tobi@learnboost.com"

// POST { "name": "tobi" }
req.body.name
// =&gt; "tobi"
</code></pre></div></div>

<h3 id="reqfiles">req.files</h3>
<p>è¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªä¸Šä¼ æ–‡ä»¶çš„å¯¹è±¡ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯æä¾›ä¸€ä¸ªbodyParser()ä¸­é—´ä»¶ã€‚è™½ç„¶å…¶ä»–çš„ä½“è§£æä¸­é—´ä»¶ä¹Ÿéµå¾ªæ­¤çº¦å®šï¼Œ
å½“ä½¿ç”¨bodyparserï¼ˆï¼‰ä½¿ç”¨æ—¶ï¼Œé»˜è®¤å€¼ä¸º{}ã€‚</p>

<p>ä¾‹å¦‚ä¸€ä¸ªæ–‡ä»¶å­—æ®µè¢«å‘½åä¸ºâ€œimageâ€ï¼Œå’Œä¸€ä¸ªæ–‡ä»¶è¢«ä¸Šä¼ ï¼Œreq.files.imageåŒ…å«å¦‚ä¸‹æ–‡ä»¶å¯¹è±¡ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ size: 74643,
  path: '/tmp/8ef9c52abe857867fd0a4e9a819d1876',
  name: 'edge.png',
  type: 'image/png',
  hash: false,
  lastModifiedDate: Thu Aug 09 2012 20:07:51 GMT-0700 (PDT),
  _writeStream: 
   { path: '/tmp/8ef9c52abe857867fd0a4e9a819d1876',
     fd: 13,
     writable: false,
     flags: 'w',
     encoding: 'binary',
     mode: 438,
     bytesWritten: 74643,
     busy: false,
     _queue: [],
     _open: [Function],
     drainable: true },
  length: [Getter],
  filename: [Getter],
  mime: [Getter] }
</code></pre></div></div>

<p>bodyparser()ä¸­é—´ä»¶åˆ©ç”¨èŠ‚ç‚¹å¼ºå¤§çš„æ¨¡å—å†…éƒ¨ï¼Œå¹¶æ¥å—ç›¸åŒçš„é€‰é¡¹ã€‚ä¸€ä¸ªä¾‹å­æ˜¯keepextensionså¼ºå¤§çš„é€‰é¡¹ï¼Œ
åœ¨ç»™å‡ºæ–‡ä»¶åâ€œ/tmp/8ef9c52abe857867fd0a4e9a819d1876â€.pngæ‰©å±•åçš„æƒ…å†µä¸‹é»˜è®¤å€¼æ˜¯falseã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(express.bodyParser({ keepExtensions: true, uploadDir: '/my/files' }));
</code></pre></div></div>

<h3 id="reqparamname">req.param(name)</h3>
<p>è¿”å›å½“å‰å‚æ•°nameçš„å€¼
		// ?name=tobi
		req.param(â€˜nameâ€™)
		// =&gt; â€œtobiâ€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	// POST name=tobi
	req.param('name')
	// =&gt; "tobi"

	// /user/tobi for /user/:name 
	req.param('name')
	// =&gt; "tobi"
</code></pre></div></div>

<p>æŸ¥æ‰¾ä¼˜å…ˆçº§å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	req.params
	req.body
	req.query
</code></pre></div></div>

<p>ç›´æ¥ä½¿ç”¨req.bodyï¼Œreq.paramsï¼Œå’Œreq.queryåº”è¯¥æ›´æ–°æ¸…æ™°ï¼Œé™¤éä½ ç¡®å®éœ€è¦æ¥æ”¶æ¯ä¸ªå¯¹è±¡çš„è¾“å…¥ã€‚</p>

<h3 id="reqroute">req.route</h3>

<p>å½“å‰åŒ¹é…çš„è·¯ç”±åŒ…å«å¤šä¸ªå±æ€§ï¼Œå¦‚è·¯ç”±çš„åŸå§‹è·¯å¾„å­—ç¬¦ä¸²ä»¥åŠè½¬æ¢åçš„æ­£åˆ™è¡¨è¾¾å¼ç­‰ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.get('/user/:id?', function(req, res){
  console.log(req.route);
});
ä¸Šé¢çš„ä»£ç è¾“å‡ºç»“æœï¼š

{ path: '/user/:id?',
  keys: [ { name: 'id', optional: true } ],
  regexp: /^\/user(?:\/([^\/]+?))?\/?$/i,
  params: [ id: '12' ] }
</code></pre></div></div>

<h3 id="reqcookies">req.cookies</h3>

<p>å½“cookieParser()ä¸­é—´ä»¶ä½¿ç”¨æ—¶è¯¥å¯¹è±¡é»˜è®¤ä¸º{}ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜åŒ…å«ç”±ç”¨æˆ·ä»£ç†å‘é€çš„cookiesã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Cookie: name=tj
req.cookies.name
// =&gt; "tj" å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®è¯·å‚é˜…cookie-parseré™„åŠ æ–‡æ¡£ã€‚
</code></pre></div></div>

<h3 id="reqsignedcookies">req.signedCookies</h3>

<p>å½“cookieParser(secret)ä¸­é—´ä»¶ä½¿ç”¨è¯¥å¯¹è±¡é»˜è®¤ä¸º{}ï¼Œè¿˜åŒ…æ‹¬ç”¨æˆ·ä»£ç†å‘é€çš„ç­¾åcookiesï¼Œæœªç­¾åä»¥åŠå‡†å¤‡ä½¿ç”¨çš„ã€‚ç­¾åcookieså­˜æ”¾äºä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡ï¼Œä»¥æ˜¾ç¤ºå¼€å‘è€…çš„æ„å›¾ï¼Œå¦åˆ™å¯ä»¥é€šè¿‡åœ¨req.cookieè®¾ç½®å€¼å‘èµ·æ¶æ„æ”»å‡»ï¼Œä»è€Œå¾ˆè½»æ˜“çš„æ¬ºéª—ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ç­¾åçš„cookieå¹¶ä¸æ„å‘³ç€å®ƒæ˜¯éšè—çš„æˆ–è€…æ˜¯åŠ å¯†çš„ï¼Œè¿™ä¸ªé˜²æ­¢ç¯¡æ”¹çš„ç§˜å¯†åªæ˜¯ç®€å•çš„å°†ç­¾åç§æœ‰åŒ–ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Cookie: user=tobi.CP7AWaXDfAKIRfH49dQzKJx7sKzzSoPq7/AcBBRVwlI3
req.signedCookies.user
// =&gt; "tobi" å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®è¯·å‚é˜…cookie-parseré™„åŠ æ–‡æ¡£ã€‚
</code></pre></div></div>

<h3 id="reqgetfield">req.get(field)</h3>
<p>è·å–è¯·æ±‚å¤´å†…çš„fieldå­—æ®µï¼Œä¸åŒºåˆ†å¤§å°å†™ã€‚Referrerå’ŒRefererå­—æ®µå¯ä»¥äº’æ¢ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	req.get('Content-Type');
	// =&gt; "text/plain"
	
	req.get('content-type');
	// =&gt; "text/plain"
	
	req.get('Something');
	// =&gt; undefined åˆ«åä¸ºreq.header(field)ã€‚
</code></pre></div></div>

<p>æ£€æŸ¥ç»™å®šçš„typesæ˜¯ä¸æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå½“ç»“æœä¸ºtrueæ—¶è¿”å›æœ€ä½³åŒ¹é…ï¼Œå¦åˆ™è¿”å›undefinedï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä½ åº”è¯¥è¿”å›406â€Not Acceptableâ€ã€‚</p>

<p>typeå¯ä»¥æ˜¯å•ä¸€çš„mineç±»å‹çš„å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚â€application/jsonâ€ï¼Œæ‰©å±•åå¦‚â€jsonâ€ï¼Œä¹Ÿå¯ä»¥æ˜¯ä»¥é€—å·åˆ†éš”çš„åˆ—è¡¨æˆ–è€…æ•°ç»„ã€‚å½“ä¸ºåˆ—è¡¨æˆ–æ•°ç»„æ—¶å°†è¿”å›æœ€ä½³åŒ¹é…ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Accept: text/html
req.accepts('html');
// =&gt; "html"

// Accept: text/*, application/json
req.accepts('html');
// =&gt; "html"
req.accepts('text/html');
// =&gt; "text/html"
req.accepts('json, text');
// =&gt; "json"
req.accepts('application/json');
// =&gt; "application/json"

// Accept: text/*, application/json
req.accepts('image/png');
req.accepts('png');
// =&gt; undefined

// Accept: text/*;q=.5, application/json
req.accepts(['html', 'json']);
req.accepts('html, json');
// =&gt; "json" å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®ï¼Œè¯·å‚é˜…acceptsé™„åŠ æ–‡æ¡£ã€‚
</code></pre></div></div>

<h3 id="reqacceptscharsetcharset">req.acceptsCharset(charset)</h3>

<p>æ£€æŸ¥ç»™å®šçš„å­—ç¬¦é›†æ˜¯å¦å¯ä»¥æ”¯æŒã€‚
å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®ï¼Œè¯·å‚é˜…acceptsé™„åŠ æ–‡æ¡£ã€‚</p>

<h3 id="reqacceptslanguagelang">req.acceptsLanguage(lang)</h3>

<p>æ£€æŸ¥ç»™å®šçš„langæ˜¯å¦æ”¯æŒã€‚
å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®ï¼Œè¯·å‚é˜…acceptsé™„åŠ æ–‡æ¡£ã€‚</p>

<h3 id="reqistype">req.is(type)</h3>

<p>æ£€æŸ¥ä¼ å…¥è¯·æ±‚å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«äº†â€Content-Typeâ€å¤´å­—æ®µï¼Œå¹¶ä¸”ç»™å‡ºåŒ¹é…çš„mineç±»å‹ã€‚
	// With Content-Type: text/html; charset=utf-8
	req.is(â€˜htmlâ€™);
	req.is(â€˜text/htmlâ€™);
	req.is(â€˜text/*â€™);
	// =&gt; true</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// When Content-Type is application/json
req.is('json');
req.is('application/json');
req.is('application/*');
// =&gt; true

req.is('html');
// =&gt; false å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®ï¼Œè¯·å‚é˜…type-isé™„åŠ æ–‡æ¡£ã€‚
</code></pre></div></div>

<h3 id="reqip">req.ip</h3>
<p>è¿”å›è¿œç¨‹åœ°å€ï¼Œæˆ–è€…å½“ä¿¡ä»»ä»£ç†å·²å¯ç”¨æ—¶è¿”å›ä»£ç†åœ°å€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>req.ip
// =&gt; "127.0.0.1"
</code></pre></div></div>

<h3 id="reqips">req.ips</h3>

<p>å½“ä¿¡ä»»ä»£ç†ä¸ºtrueæ—¶ï¼Œè§£æâ€X-Forwarded-Forâ€ipåœ°å€åˆ—è¡¨è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªç©ºæ•°ç»„ã€‚
ä¾‹å¦‚å½“å€¼ä¸ºâ€client, proxy1, proxy2â€æ—¶ä½ ä¼šè·å¾—[â€œclientâ€, â€œproxy1â€, â€œproxy2â€]æ•°ç»„ï¼Œå…¶ä¸­â€proxy2â€æ˜¯æœ€è¿œçš„ä¸‹æ¸¸åœ°å€ã€‚</p>

<h3 id="reqpath">req.path</h3>
<p>è¿”å›è¯·æ±‚çš„URLè·¯å¾„åã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// example.com/users?sort=desc
req.path
// =&gt; "/users"
</code></pre></div></div>

<h3 id="reqfresh">req.fresh</h3>
<p>æ£€æŸ¥è¯·æ±‚æ˜¯å¦åˆ·æ–°ï¼Œé€šè¿‡å¯¹Last-Modifiedå’Œ/æˆ–ETagè¿›è¡ŒåŒ¹é…ï¼Œè¡¨æ˜èµ„æºæ˜¯ä¸æ˜¯æœ€æ–°çš„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>req.fresh
// =&gt; true å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®ï¼Œè¯·å‚é˜…freshé™„åŠ æ–‡æ¡£ã€‚
</code></pre></div></div>

<h3 id="reqstale">req.stale</h3>
<p>æ£€æŸ¥è¯·æ±‚æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœLast-Modifiedå’Œ/æˆ–ETagä¸åŒ¹é…ï¼Œè¡¨æœ‰èµ„æºæ˜¯è¿‡æœŸçš„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>req.stale
// =&gt; true
</code></pre></div></div>

<h3 id="reqxhr">req.xhr</h3>
<p>æ£€æŸ¥è¯·æ±‚å¤´é‡Œæ˜¯å¦åŒ…å«â€X-Requested-Withâ€å­—æ®µå¹¶ä¸”å€¼ä¸ºâ€XMLHttpRequestâ€(jQueryç­‰)ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>req.xhr
// =&gt; true
</code></pre></div></div>

<h3 id="reqprotocol">req.protocol</h3>
<p>å½“ä½¿ç”¨TLSè¯·æ±‚æ—¶è¿”å›â€httpâ€æˆ–â€httpsâ€åè®®å­—ç¬¦ä¸²ã€‚å½“ä¿¡ä»»è·¯ç”±è®¾ç½®ä¸ºå¼€å¯æ—¶â€X-Forwarded-Protoâ€å¤´å­—æ®µå°†è¢«ä¿¡ä»»ã€‚
å¦‚æœä½ æ­£åœ¨è¿è¡Œä¸€ä¸ªæ”¯æŒhttpsåè®®çš„åå‘ä»£ç†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ˜¯æ”¯æŒçš„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>req.protocol
// =&gt; "http"
</code></pre></div></div>

<h3 id="reqsecure">req.secure</h3>
<p>æ£€æŸ¥TLSè¿æ¥æ˜¯å¦å»ºç«‹ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å†™ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'https' == req.protocol;
</code></pre></div></div>

<h3 id="reqsubdomains">req.subdomains</h3>
<p>è¿”å›å­åŸŸæ•°ç»„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Host: "tobi.ferrets.example.com"
req.subdomains
// =&gt; ["ferrets", "tobi"]
</code></pre></div></div>

<h3 id="reqoriginalurl">req.originalUrl</h3>
<p>æ­¤å±æ€§å¾ˆåƒreq.urlï¼Œä½†å®ƒä¿ç•™äº†åŸå§‹è¯·æ±‚çš„urlï¼Œå…è®¸ä½ åœ¨åšå†…éƒ¨è·¯ç”±æ—¶è‡ªç”±é‡å†™req.urlã€‚
ä¾‹å¦‚app.use()ä¸­é—´ä»¶å°†é‡å†™req.urlé‡æ–°å®šä¹‰æŒ‚è½½ç‚¹ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// GET /search?q=something
req.originalUrl
// =&gt; "/search?q=something"
</code></pre></div></div>

<h2 id="å››response">å››ã€Response</h2>

<h3 id="resstatuscode">res.status(code)</h3>
<p>res.statusCode=å¯é“¾æ¥èŠ‚ç‚¹çš„åˆ«å</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.status(404).sendfile('path/to/404.png');
</code></pre></div></div>

<h3 id="ressetfield-value">res.set(field, [value])</h3>
<p>è®¾ç½®å“åº”å¤´å†…å­—æ®µå€¼ï¼Œæˆ–è€…é€šè¿‡ä¸€ä¸ªå¯¹è±¡ä¸€æ¬¡è®¾ç½®å¤šä¸ªå­—æ®µã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.set('Content-Type', 'text/plain');
res.set({
	 'Content-Type': 'text/plain',
	 'Content-Length': '123',
	 'ETag': '12345'
}) res.header(field, [value])åˆ«åã€‚
</code></pre></div></div>

<h3 id="resgetfield">res.get(field)</h3>
<p>è·å–å“åº”å¤´å†…å­—æ®µå€¼ï¼Œä¸åŒºåˆ†å¤§å°å†™ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	res.get('Content-Type');
	// =&gt; "text/plain"
</code></pre></div></div>

<h3 id="rescookiename-value-options">res.cookie(name, value, [options])</h3>
<p>è®¾ç½®cookieåç§°å’Œå€¼ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–è€…å¯¹è±¡è½¬æ¢æˆçš„JSONã€‚è·¯å¾„é€‰é¡¹é»˜è®¤ä¸ºâ€/â€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	res.cookie('name', 'tobi', { domain: '.example.com', path: '/admin', secure: true });
	res.cookie('rememberme', '1', { expires: new Date(Date.now() + 900000), httpOnly: true });
</code></pre></div></div>

<p>maxAgeé€‰é¡¹å¯ä»¥å¾ˆæ–¹ä¾¿çš„è®¾ç½®ä»å½“å‰æ—¶é—´å¼€å§‹ä»¥æ¯«ç§’ä¸ºå•ä½çš„è¿‡æœŸæ—¶é—´ã€‚ä¸‹é¢çš„å†™æ³•ç­‰åŒäºä¸Šä¸€ä¸ªä¾‹å­ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.cookie('rememberme', '1', { maxAge: 900000, httpOnly: true })
</code></pre></div></div>

<p>ä¸€ä¸ªå¯¹è±¡å¯ä»¥é€šè¿‡åºåˆ—åŒ–æˆJSONä¼ é€’ï¼Œå®ƒç”±bodyParser()ä¸­é—´ä»¶è‡ªåŠ¨è§£æã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.cookie('cart', { items: [1,2,3] });
res.cookie('cart', { items: [1,2,3] }, { maxAge: 900000 }); è¿™ç§æ–¹æ³•ä¹Ÿæ”¯æŒç­¾åcookieã€‚æ·»åŠ ä¸€ä¸ªç®€å•çš„signedé€‰é¡¹ã€‚ res.cookie()å°†éšè—ä¼ é€’ç»™cookieParser(secret)å¯¹å€¼ç­¾åã€‚

res.cookie('name', 'tobi', { signed: true });
</code></pre></div></div>

<p>ç„¶åä½ å¯ä»¥ä½¿ç”¨req.signedCookieæ¥è®¿é—®è¿™ä¸ªå€¼ã€‚</p>

<h3 id="resclearcookiename-options">res.clearCookie(name, [options])</h3>
<p>åˆ é™¤cookieé‡Œé¢å€¼ã€‚é»˜è®¤è·¯å¾„ä¸ºâ€/â€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.cookie('name', 'tobi', { path: '/admin' });
res.clearCookie('name', { path: '/admin' });
</code></pre></div></div>

<h3 id="resredirectstatus-url">res.redirect([status], url)</h3>
<p>é‡å®šå‘åˆ°ç»™å®šçš„urlï¼Œå¯é€‰çŠ¶æ€ç¼–ç é»˜è®¤ä¸º302â€Foundâ€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.redirect('/foo/bar');
res.redirect('http://example.com');
res.redirect(301, 'http://example.com');
res.redirect('../login');
</code></pre></div></div>

<p>Expressæ”¯æŒå‡ ç§å½¢å¼çš„é‡å®šå‘ï¼Œé¦–å…ˆä¸€ä¸ªå®Œæ•´åˆæ ¼çš„URIé‡å®šå‘åˆ°ä¸åŒçš„åŸŸåï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.redirect('http://google.com');
</code></pre></div></div>

<p>ç¬¬äºŒç§å½¢å¼æ˜¯ç›¸å¯¹è·¯å¾„çš„é‡å®šå‘ï¼Œä¾‹å¦‚ä½ æ­£åœ¨http://example.com/admin/post/newï¼Œ
æ¥ç€é‡å®šå‘åˆ°/adminï¼Œä½ å°†ä¼šç™»å½•http://example.com/adminï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.redirect('/admin');
</code></pre></div></div>

<h3 id="reslocation">res.location</h3>
<p>è®¾ç½®ä½ç½®å¤´</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.location('/foo/bar');
res.location('foo/bar');
res.location('http://example.com');
res.location('../login');
res.location('back'); ä½ å¯ä»¥ä½¿ç”¨res.redirect()ç›¸åŒçš„urlsã€‚ ä¾‹å¦‚ä½ çš„åº”ç”¨æŒ‚è½½åœ¨/blogä¸‹ï¼Œä½¿ç”¨ä¸‹é¢çš„ä»£ç è®¾ç½®locationå¤´ä¸º/blog/adminï¼š

res.location('admin')
</code></pre></div></div>

<h3 id="rescharset">res.charset</h3>
<p>åˆ†é…å­—ç¬¦é›†ã€‚é»˜è®¤çš„ä¸ºâ€œutf-8â€.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.charset = 'value';
res.send('&lt;p&gt;some html&lt;/p&gt;');
// =&gt; Content-Type: text/html; charset=value
</code></pre></div></div>

<h3 id="ressendbodystatus-body">res.send([body|status], [body])</h3>
<p>å‘é€ä¸€ä¸ªå“åº”</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.send(new Buffer('whoop'));
res.send({ some: 'json' });
res.send('&lt;p&gt;some html&lt;/p&gt;');
res.send(404, 'Sorry, we cannot find that!');
res.send(500, { error: 'something blew up' });
res.send(200);
</code></pre></div></div>

<p>æ­¤æ–¹æ³•é€‚ç”¨äºæ‰§è¡Œå¤§é‡çš„ç®€å•éæµå¼çš„å“åº”ä»»åŠ¡ï¼Œä¾‹å¦‚åœ¨æœªæå‰å®šä¹‰å’Œæä¾›è‡ªåŠ¨HEADå’ŒHTTPç¼“å­˜åˆ·æ–°æ”¯æŒçš„æƒ…å†µä¸‹è‡ªåŠ¨è®¾å®šContent-Lengthã€‚ <br />
å½“ä¼ å…¥çš„å†…å®¹ä¸ºBufferï¼Œé‚£ä¹ˆContent-Typeä¼šè¢«è®¾ç½®ä¸ºâ€application/octet-streamâ€ï¼Œé™¤éé¢„å…ˆå®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.set('Content-Type', 'text/html');
res.send(new Buffer('&lt;p&gt;some html&lt;/p&gt;')); å½“å‘é€å­—ç¬¦ä¸²æ—¶Content-Typeè®¾ç½®é»˜è®¤ä¸º"text/html"ï¼š

res.send('&lt;p&gt;some html&lt;/p&gt;'); å½“å‘é€æ•°ç»„æˆ–è€…å¯¹è±¡æ—¶Expresså°†ä¼šè½¬æ¢æˆJSONæ ¼å¼ï¼š

res.send({ user: 'tobi' })
res.send([1,2,3])
</code></pre></div></div>

<p>æœ€åå¦‚æœè¿”å›çš„æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œæ²¡æœ‰å‰é¢æåˆ°çš„ä»»ä½•ä¸€ä¸ªå“åº”ä½“ï¼ŒExpressä¼šä¸ºä½ è®¾ç½®ä¸€ä¸ªå“åº”å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚200å°†ä¼šå“åº”æ–‡æœ¬â€OKâ€ï¼Œ400å“åº”â€Not Foundâ€ç­‰ç­‰ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.send(200)
res.send(404)
res.send(500)
</code></pre></div></div>

<h3 id="resjsonstatusbody-body">res.json([status|body], [body])</h3>
<p>å‘é€ä¸€ä¸ªJSONå“åº”ï¼Œå½“è¿”å›å¯¹è±¡æˆ–è€…æ•°ç»„æ—¶è¯¥æ–¹æ³•ä¸res.send()ç›¸åŒï¼Œç„¶è€Œå®ƒå¯ä»¥ç”¨æ¥å°†éå¯¹è±¡(null, undefined, ç­‰ç­‰)è½¬æ¢æˆç²¾å‡†çš„JSONï¼Œå°½ç®¡ä¸¥æ ¼æ¥è¯´è¿™äº›å¹¶ä¸æ˜¯æœ‰æ•ˆçš„JSONã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.json(null)
res.json({ user: 'tobi' })
res.json(500, { error: 'message' })
</code></pre></div></div>

<h3 id="resjsonpstatusbody-body">res.jsonp([status|body], [body])</h3>
<p>ä½¿ç”¨JSONPå‘é€JSONå“åº”ã€‚è¯¥æ–¹æ³•ä¸res.json()ç›¸åŒï¼Œä½†å¤šäº†å¯¹JSONPå›è°ƒçš„æ”¯æŒã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.jsonp(null)
// =&gt; null
	
res.jsonp({ user: 'tobi' })
// =&gt; { "user": "tobi" }
	
res.jsonp(500, { error: 'message' })
// =&gt; { "error": "message" }
</code></pre></div></div>

<p>é»˜è®¤JSONPå›è°ƒå‡½æ•°åæ˜¯callbackï¼Œä½†ä½ å¯ä»¥é€šè¿‡ä¿®æ”¹jsonp callback nameå‚æ•°é‡æ–°å®šä¹‰ã€‚ä»¥ä¸‹æ˜¯JSONPå“åº”çš„ä¸€äº›ä¾‹å­ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ?callback=foo
res.jsonp({ user: 'tobi' })
// =&gt; foo({ "user": "tobi" })

app.set('jsonp callback name', 'cb');

// ?cb=foo
res.jsonp(500, { error: 'message' })
// =&gt; foo({ "error": "message" })
</code></pre></div></div>

<h3 id="restypetype">res.type(type)</h3>
<p>è®¾ç½®Content-Typeç±»å‹ä¸ºmimeæŸ¥æ‰¾çš„ç±»å‹ï¼Œæˆ–è€…å½“â€/â€å­˜åœ¨æ—¶Content-Typeè¢«ç®€å•çš„è®¾ç½®æˆè¯¥ç±»å‹ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.type('.html');
res.type('html');
res.type('json');
res.type('application/json');
res.type('png');
</code></pre></div></div>

<h3 id="resformatobject">res.format(object)</h3>
<p>æ‰§è¡Œè¯·æ±‚æ—¶å­˜åœ¨è¯·æ±‚Acceptå¤´ä¸Šä¸‹æ–‡è½¬æ¢ã€‚è¯¥æ–¹æ³•ä½¿ç”¨req.acceptedï¼Œè¿™æ˜¯ä¸€ä¸ªæŒ‰å¯æ¥å—ç±»å‹é‡è¦æ€§æ’åºçš„æ•°ç»„ï¼Œå¦åˆ™ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°è¢«è°ƒç”¨ã€‚å½“æ²¡æœ‰åŒ¹é…çš„å›è°ƒå‡½æ•°æ‰§è¡Œæ—¶æœåŠ¡å™¨è¿”å›406 â€œNot Acceptableâ€ï¼Œæˆ–è€…è°ƒç”¨é»˜è®¤çš„å›è°ƒå‡½æ•°ã€‚</p>

<p>è®¾ç½®Content-Typeä¸ºä½ é€‰æ‹©ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œä½†ä½ å¯ä»¥åœ¨å›è°ƒå‡½æ•°ä¸­ä½¿ç”¨res.set()æˆ–è€…res.type()ç­‰ä¿®æ”¹ã€‚</p>

<p>ä¸‹ä¾‹å½“Acceptå¤´å­—æ®µè®¾ç½®æˆâ€application/jsonâ€æˆ–â€/jsonâ€æ—¶å“åº”{ â€œmessageâ€: â€œheyâ€ }ï¼Œä½†å¦‚æœè®¾ç½®æˆâ€/*â€œæ—¶å°†ä¼šå“åº”â€heyâ€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.format({
  'text/plain': function(){
    res.send('hey');
  },

  'text/html': function(){
    res.send('&lt;p&gt;hey&lt;/p&gt;');
  },

  'application/json': function(){
    res.send({ message: 'hey' });
  }
});
</code></pre></div></div>

<p>é™¤äº†è§„èŒƒåŒ–çš„MIMEç±»å‹ä½ è¿˜å¯ä»¥ä½¿ç”¨æ‰©å±•åæ˜ å°„è¿™äº›ç±»å‹ï¼Œæä¾›ä¸€ä¸ªå†—é•¿å®æ–½ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.format({
  text: function(){
    res.send('hey');
  },

  html: function(){
    res.send('&lt;p&gt;hey&lt;/p&gt;');
  },

  json: function(){
    res.send({ message: 'hey' });
  }
});
</code></pre></div></div>

<h3 id="resattachmentfilename">res.attachment([filename])</h3>
<p>è®¾ç½®Contentâ€”â€”dispositionå¤´å­—æ®µä¸ºâ€œattachmentâ€ã€‚å¦‚æœç»™å®šä¸€ä¸ªæ–‡ä»¶åï¼Œé‚£ä¹ˆContent-Typeå°†ä¼šé€šè¿‡res.type()è‡ªåŠ¨è®¾ç½®æˆåŸºäºæ‰©å±•åçš„ç±»å‹ï¼ŒContent-Dispositionçš„â€filename=â€å‚æ•°åŒæ—¶ä¹Ÿè¢«è®¾ç½®ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.attachment();  
// Content-Disposition: attachment
		
res.attachment('path/to/logo.png');  
// Content-Disposition: attachment;   filename="logo.png"  
// Content-Type: image/png
</code></pre></div></div>

<h3 id="ressendfilepath-options-fn">res.sendfile(path, [options], [fn])</h3>
<p>ä¼ è¾“æ–‡ä»¶åˆ°ç»™å®šçš„è·¯å¾„ã€‚<br />
è‡ªåŠ¨è®¾ç½®é»˜è®¤åŸºäºæ–‡ä»¶æ‰©å±•åçš„Content-Typeå“åº”å¤´ã€‚å½“ä¼ è¾“å‘ç”Ÿé”™è¯¯æ—¶fn(err)å›è°ƒå‡½æ•°è¢«è°ƒç”¨ã€‚<br />
é€‰é¡¹ï¼š</p>

<blockquote>
  <ul>
    <li>maxAge ä»¥æ¯«ç§’ä¸ºå•ä½é»˜è®¤ä¸º0</li>
    <li>root ç›¸å¯¹æ–‡ä»¶åæ ¹ç›®å½•</li>
  </ul>
</blockquote>

<p>åœ¨ä¸‹ä¾‹ä¸­è¯¥æ–¹æ³•ä¸ºæ–‡ä»¶æœåŠ¡æä¾›ç»†ç²’åº¦æ”¯æŒï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>		app.get('/user/:uid/photos/:file', function(req, res){
		  var uid = req.params.uid
		    , file = req.params.file;
		
		  req.user.mayViewFilesFrom(uid, function(yes){
		    if (yes) {
		      res.sendfile('/uploads/' + uid + '/' + file);
		    } else {
		      res.send(403, 'Sorry! you cant see that.');
		    }
		  });
		});
</code></pre></div></div>

<h3 id="resdownloadpath-filename-fn">res.download(path, [filename], [fn])</h3>
<p>ä¼ è¾“è·¯å¾„ä¸­çš„æ–‡ä»¶ä½œä¸ºé™„ä»¶ï¼Œé€šå¸¸æµè§ˆå™¨ä¼šæé†’ç”¨æˆ·ä¸‹è½½ã€‚Content-Disposition â€œfilename=â€å‚æ•°ï¼Œä¹Ÿå°±æ˜¯æ˜¾ç¤ºåœ¨æµè§ˆå™¨å¯¹è¯æ¡†çš„é»˜è®¤æ–‡ä»¶åï¼Œä½ ä¹Ÿå¯ä»¥æä¾›ä¸€ä¸ªè‡ªå®šä¹‰æ–‡ä»¶åã€‚</p>

<p>å½“ä¼ è¾“å®Œæˆæˆ–è€…ä¸­é€”å‘ç”Ÿé”™è¯¯æ—¶å°†ä¼šè°ƒç”¨fnå›è°ƒå‡½æ•°ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨res.sendfile()æ¥ä¼ è¾“æ–‡ä»¶ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	res.download('/report-12345.pdf');
	
	res.download('/report-12345.pdf', 'report.pdf');
	
	res.download('/report-12345.pdf', 'report.pdf', function(err){
	  if (err) {
	    // handle error, keep in mind the response may be partially-sent
	    // so check res.headersSent
	  } else {
	    // decrement a download credit etc
	  }
	});
</code></pre></div></div>

<h3 id="reslinkslinks">res.links(links)</h3>
<p>åŠ å…¥ç»™å®šçš„é“¾æ¥æ¥å¡«å……â€Linkâ€å“åº”å¤´å­—æ®µã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	res.links({
	  next: 'http://api.example.com/users?page=2',
	  last: 'http://api.example.com/users?page=5'
	}); å¤„ç†å  

	Link: &amp;lt;http://api.example.com/users?page=2&amp;gt;; rel="next", 
	      &amp;lt;http://api.example.com/users?page=5&amp;gt;; rel="last"
</code></pre></div></div>

<h3 id="reslocals">res.locals</h3>
<p>å“åº”æœ¬åœ°åŒ–å˜é‡ä½œç”¨åŸŸä¸ºrequestï¼Œå› æ­¤åªé€‚ç”¨äºåœ¨è¯¥request/responseå‘¨æœŸå†…å‘ˆç°çš„è§†å›¾ï¼Œå¦‚æœæœ‰çš„è¯ã€‚å…¶å®è¯¥APIè·Ÿapp.localsæ˜¯ç­‰åŒçš„ã€‚<br />
è¿™ä¸ªå¯¹è±¡é€‚ç”¨äºçš„requestçº§åˆ«çš„ä¿¡æ¯ï¼Œä¾‹å¦‚requestè·¯å¾„ï¼Œç”¨æˆ·è®¤è¯ï¼Œç”¨æˆ·è®¾ç½®ç­‰ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	app.use(function(req, res, next){
	  res.locals.user = req.user;
	  res.locals.authenticated = ! req.user.anonymous;
	  next();
	});
</code></pre></div></div>

<h3 id="resrenderview-locals-callback">res.render(view, [locals], callback)</h3>
<p>æ¸²æŸ“ä¸€ä¸ªè§†å›¾ï¼ŒåŒæ—¶å‘å›è°ƒå‡½æ•°ä¼ é€’æ¸²æŸ“åçš„å­—ç¬¦ä¸²ã€‚å‘ç”Ÿé”™è¯¯æ—¶å†…éƒ¨è°ƒç”¨next(err)ã€‚å›è°ƒå‡½æ•°ä¼ å…¥å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ä»¥åŠæ¸²æŸ“åçš„é¡µé¢ï¼Œè¿™æ ·å°±ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œå“åº”äº†ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	res.render('index', function(err, html){
	  // ...
	});
	
	res.render('user', { name: 'Tobi' }, function(err, html){
	  // ...
	});
</code></pre></div></div>

<h2 id="äº”middleware">äº”ã€Middleware</h2>

<h3 id="basicauth">basicAuth()</h3>
<p>åŸºæœ¬èº«ä»½éªŒè¯çš„ä¸­é—´ä»¶ï¼Œåœ¨req.useré‡Œæ·»åŠ ç”¨æˆ·å<br />
ç”¨æˆ·åå­—å’Œå¯†ç çš„ä¾‹å­ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(express.basicAuth('username', 'password'));   æ ¡éªŒå›è°ƒï¼š 
 
app.use(express.basicAuth(function(user, pass){
	 return 'tj' == user &amp;&amp; 'wahoo' == pass;
}));
</code></pre></div></div>

<p>å¼‚æ­¥æ ¡éªŒæ¥å—å‚æ•°fn(err, user), ä¸‹é¢çš„ä¾‹å­req.user å°†ä¼šä½œä¸ºuserå¯¹è±¡ä¼ é€’.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(connect.basicAuth(function(user, pass, fn){
	 User.authenticate({ user: user, pass: pass }, fn);
}))
</code></pre></div></div>

<h3 id="bodyparser">bodyParser()</h3>
<p>æ”¯æŒ JSON, urlencodedå’Œmultipart requestsçš„è¯·æ±‚ä½“è§£æä¸­é—´ä»¶ã€‚ è¿™ä¸ªä¸­é—´ä»¶æ˜¯json(), urlencoded(),å’Œmultipart() è¿™å‡ ä¸ªä¸­é—´ä»¶çš„ç®€å•å°è£…</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(express.bodyParser());
// ç­‰åŒäº:
app.use(express.json());
app.use(express.urlencoded());
app.use(express.multipart());
</code></pre></div></div>

<p>ä»å®‰å…¨ä¸Šè€ƒè™‘ï¼Œå¦‚æœä½ çš„åº”ç”¨ç¨‹åºä¸éœ€è¦æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼Œæœ€å¥½å…³é—­å®ƒã€‚æˆ‘ä»¬åªä½¿ç”¨æˆ‘ä»¬éœ€è¦çš„ä¸­é—´ä»¶ã€‚ä¾‹å¦‚ï¼šæˆ‘ä»¬ä¸ä½¿ç”¨bodyParserã€multipart() è¿™ä¸¤ä¸ªä¸­é—´ä»¶ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(express.json());
app.use(express.urlencoded());
</code></pre></div></div>

<h3 id="compress">compress()</h3>
<p>é€šè¿‡gzip / deflateå‹ç¼©å“åº”æ•°æ®. è¿™ä¸ªä¸­é—´ä»¶åº”è¯¥æ”¾ç½®åœ¨æ‰€æœ‰çš„ä¸­é—´ä»¶æœ€å‰é¢ä»¥ä¿è¯æ‰€æœ‰çš„è¿”å›éƒ½æ˜¯è¢«å‹ç¼©çš„</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(express.logger());
app.use(express.compress());
app.use(express.methodOverride());
app.use(express.bodyParser());
</code></pre></div></div>

<h3 id="cookieparser">cookieParser()</h3>
<p>è§£æè¯·æ±‚å¤´é‡Œçš„Cookie, å¹¶ç”¨cookieåå­—çš„é”®å€¼å¯¹å½¢å¼æ”¾åœ¨ req.cookies ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¼ é€’ä¸€ä¸ªsecret å­—ç¬¦ä¸²æ¿€æ´»ç­¾åäº†çš„cookie</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(express.cookieParser());
app.use(express.cookieParser('some secret'));
</code></pre></div></div>

<h3 id="cookiesession">cookieSession()</h3>
<p>æä¾›ä¸€ä¸ªä»¥cookieä¸ºåŸºç¡€çš„sessions, è®¾ç½®åœ¨req.sessioné‡Œã€‚ è¿™ä¸ªä¸­é—´ä»¶æœ‰ä»¥ä¸‹å‡ ä¸ª<br />
é€‰é¡¹:</p>
<blockquote>
  <ul>
    <li>key cookie çš„åå­—ï¼Œé»˜è®¤æ˜¯ connect.sess</li>
    <li>secret é˜²æ­¢ç¯¡æ”¹</li>
    <li>cookie session cookie è®¾ç½®, é»˜è®¤æ˜¯ { path: â€˜/â€™, httpOnly: true, maxAge: null }</li>
    <li>proxy å½“è®¾ç½®å®‰å…¨cookiesæ—¶ä¿¡ä»»åå‘ä»£ç† (é€šè¿‡ â€œx-forwarded-protoâ€)</li>
  </ul>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(express.cookieSession()); æ¸…æ‰ä¸€ä¸ªcookie, åªéœ€è¦åœ¨å“åº”å‰æŠŠnullèµ‹å€¼ç»™session:

req.session = null
</code></pre></div></div>

<h3 id="csrf">csrf()</h3>
<p>CSRFé˜²æŠ¤ä¸­é—´ä»¶<br />
é»˜è®¤æƒ…å†µä¸‹è¿™ä¸ªä¸­é—´ä»¶ä¼šäº§ç”Ÿä¸€ä¸ªåä¸ºâ€_csrfâ€çš„æ ‡å¿—ï¼Œè¿™ä¸ªæ ‡å¿—åº”è¯¥æ·»åŠ åˆ°é‚£äº›éœ€è¦æœåŠ¡å™¨æ›´æ”¹çš„è¯·æ±‚é‡Œï¼Œå¯ä»¥æ”¾åœ¨ä¸€ä¸ªè¡¨å•çš„éšè—åŸŸï¼Œè¯·æ±‚å‚æ•°ç­‰ã€‚è¿™ä¸ªæ ‡å¿—å¯ä»¥é€šè¿‡ req.csrfToken()æ–¹æ³•è¿›è¡Œæ ¡éªŒã€‚</p>

<p>bodyParser() ä¸­é—´ä»¶äº§ç”Ÿçš„ req.body , query()äº§ç”Ÿçš„req.query,è¯·æ±‚å¤´é‡Œçš„â€X-CSRF-Tokenâ€æ˜¯é»˜è®¤çš„ value å‡½æ•°æ£€æŸ¥çš„é¡¹</p>

<p>è¿™ä¸ªä¸­é—´ä»¶éœ€è¦sessionæ”¯æŒï¼Œå› æ­¤å®ƒçš„ä»£ç åº”è¯¥æ”¾åœ¨session()ä¹‹å.</p>

<h3 id="directory">directory()</h3>
<p>æ–‡ä»¶å¤¹æœåŠ¡ä¸­é—´ä»¶ï¼Œç”¨ path æä¾›æœåŠ¡ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(express.directory('public'))
app.use(express.static('public'))
</code></pre></div></div>

<p>è¿™ä¸ªä¸­é—´ä»¶æ¥æ”¶å¦‚ä¸‹å‚æ•°ï¼š</p>

<blockquote>
  <ul>
    <li>hidden æ˜¾ç¤ºéšè—æ–‡ä»¶ï¼Œé»˜è®¤æ˜¯false</li>
    <li>icon æ˜¾ç¤ºå›¾æ ‡ï¼Œé»˜è®¤å€¼æ˜¯false</li>
    <li>filter åœ¨æ–‡ä»¶ä¸Šåº”ç”¨è¿™äº›è¿‡æ»¤å‡½æ•°ï¼Œé»˜è®¤å€¼æ˜¯false</li>
  </ul>
</blockquote>

:ET