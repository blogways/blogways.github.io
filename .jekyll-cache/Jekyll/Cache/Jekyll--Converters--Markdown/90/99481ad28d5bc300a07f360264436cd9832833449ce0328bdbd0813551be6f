I"‚6<h2 id="express4x-api-ç¿»è¯‘3--response">Express4.x API ç¿»è¯‘[3] â€“ Response</h2>

<h3 id="resstatuscode">res.status(code)</h3>
<p>node <code class="language-plaintext highlighter-rouge">res.statusCode=</code>å¯é“¾æ¥çš„åˆ«å</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.status(404).sendfile('path/to/404.png'); ### res.set(field, [value]) è®¾ç½®å“åº”å¤´å†…å­—æ®µå€¼ï¼Œæˆ–è€…é€šè¿‡ä¸€ä¸ªå¯¹è±¡ä¸€æ¬¡è®¾ç½®å¤šä¸ªå­—æ®µã€‚

res.set('Content-Type', 'text/plain');

res.set({
  'Content-Type': 'text/plain',
  'Content-Length': '123',
  'ETag': '12345'
})
</code></pre></div></div>

<p>res.header(field, [value])åˆ«åã€‚</p>

<h3 id="resgetfield">res.get(field)</h3>
<p>è·å–å“åº”å¤´å†…å­—æ®µå€¼ï¼Œä¸åŒºåˆ†å¤§å°å†™ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.get('Content-Type');
// =&gt; "text/plain" ### res.cookie(name, value, [options]) è®¾ç½®cookieåç§°å’Œå€¼ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–è€…å¯¹è±¡è½¬æ¢æˆçš„JSONã€‚è·¯å¾„é€‰é¡¹é»˜è®¤ä¸º"/"ã€‚

res.cookie('name', 'tobi', { domain: '.example.com', path: '/admin', secure: true });
res.cookie('rememberme', '1', { expires: new Date(Date.now() + 900000), httpOnly: true });
</code></pre></div></div>

<p>maxAgeé€‰é¡¹å¯ä»¥å¾ˆæ–¹ä¾¿çš„è®¾ç½®ä»å½“å‰æ—¶é—´å¼€å§‹ä»¥æ¯«ç§’ä¸ºå•ä½çš„è¿‡æœŸæ—¶é—´ã€‚ä¸‹é¢çš„å†™æ³•ç­‰åŒäºä¸Šä¸€ä¸ªä¾‹å­ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.cookie('rememberme', '1', { maxAge: 900000, httpOnly: true })
</code></pre></div></div>

<p>ä¸€ä¸ªå¯¹è±¡å¯ä»¥é€šè¿‡åºåˆ—åŒ–æˆJSONä¼ é€’ï¼Œå®ƒç”±bodyParser()ä¸­é—´ä»¶è‡ªåŠ¨è§£æã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.cookie('cart', { items: [1,2,3] });
res.cookie('cart', { items: [1,2,3] }, { maxAge: 900000 });
</code></pre></div></div>

<p>è¿™ç§æ–¹æ³•ä¹Ÿæ”¯æŒç­¾åcookieã€‚æ·»åŠ ä¸€ä¸ªç®€å•çš„signedé€‰é¡¹ã€‚res.cookie()å°†éšè—ä¼ é€’ç»™cookieParser(secret)å¯¹å€¼ç­¾åã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.cookie('name', 'tobi', { signed: true });
</code></pre></div></div>

<p>ç„¶åä½ å¯ä»¥ä½¿ç”¨req.signedCookieæ¥è®¿é—®è¿™ä¸ªå€¼ã€‚</p>

<h3 id="resclearcookiename-options">res.clearCookie(name, [options])</h3>
<p>åˆ é™¤cookieé‡Œé¢å€¼ã€‚é»˜è®¤è·¯å¾„ä¸ºâ€/â€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.cookie('name', 'tobi', { path: '/admin' });
res.clearCookie('name', { path: '/admin' }); ### res.redirect([status], url)
</code></pre></div></div>

<p>é‡å®šå‘åˆ°ç»™å®šçš„urlï¼Œå¯é€‰çŠ¶æ€ç¼–ç é»˜è®¤ä¸º302â€Foundâ€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.redirect('/foo/bar');
res.redirect('http://example.com');
res.redirect(301, 'http://example.com');
res.redirect('../login');
</code></pre></div></div>

<p>Expressæ”¯æŒå‡ ç§å½¢å¼çš„é‡å®šå‘ï¼Œé¦–å…ˆä¸€ä¸ªå®Œæ•´åˆæ ¼çš„URIé‡å®šå‘åˆ°ä¸åŒçš„åŸŸåï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.redirect('http://google.com');
</code></pre></div></div>

<p>ç¬¬äºŒç§å½¢å¼æ˜¯ç›¸å¯¹è·¯å¾„çš„é‡å®šå‘ï¼Œä¾‹å¦‚ä½ æ­£åœ¨http://example.com/admin/post/newï¼Œæ¥ç€é‡å®šå‘åˆ°/adminï¼Œä½ å°†ä¼šç™»å½•http://example.com/adminï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.redirect('/admin');
</code></pre></div></div>

<p>å…¶æ¬¡ç›¸å¯¹äºåº”ç”¨ç¨‹åºæŒ‚è½½ç‚¹çš„ç›¸å¯¹é‡å®šå‘ã€‚ä¾‹å¦‚ä½ æœ‰ä¸€ä¸ªåšå®¢åº”ç”¨ç¨‹åºæŒ‚è½½åœ¨/blogä¸‹ï¼Œç†è®ºä¸Šæ¥è¯´å¹¶ä¸çŸ¥é“å®ƒæŒ‚è½½åœ¨å“ªè¾¹ï¼Œå› æ­¤é‡å®šå‘åˆ°/admin/post/newå°†ä¼šè·³è½¬åˆ°http://example.com/admin/post/newï¼Œç›¸å¯¹æŒ‚è½½ç‚¹çš„é‡å®šå‘å°†ä¼šè·³è½¬åˆ°http://example.com/blog/admin/post/newï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.redirect('admin/post/new');
</code></pre></div></div>

<p>å½“ç„¶ç›¸å¯¹è·¯å¾„çš„é‡å®šå‘ä¹Ÿæ˜¯æ”¯æŒçš„ã€‚å¦‚æœä½ åœ¨http://example.com/admin/post/newï¼Œä¸‹é¢çš„é‡å®šå‘è½¬è·³è½¬åˆ°http://example.com/admin/postï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.redirect('..');
</code></pre></div></div>

<p>æœ€åä¸€ä¸ªç‰¹æ®Šæƒ…å†µæ˜¯backé‡å®šå‘ï¼Œé‡å®šå‘åˆ°Referer(æˆ–Refererer)ï¼Œæ‰¾ä¸åˆ°é»˜è®¤ä¸º/ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.redirect('back');
</code></pre></div></div>

<h3 id="reslocation">res.location</h3>
<p>è®¾ç½®locationå¤´ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.location('/foo/bar');
res.location('foo/bar');
res.location('http://example.com');
res.location('../login');
res.location('back');
</code></pre></div></div>

<p>ä½ å¯ä»¥ä½¿ç”¨res.redirect()ç›¸åŒçš„urlsã€‚</p>

<p>ä¾‹å¦‚ä½ çš„åº”ç”¨æŒ‚è½½åœ¨/blogä¸‹ï¼Œä½¿ç”¨ä¸‹é¢çš„ä»£ç è®¾ç½®locationå¤´ä¸º/blog/adminï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.location('admin') ### res.send([body|status], [body]) å‘é€ä¸€ä¸ªå“åº”ã€‚

res.send(new Buffer('whoop'));
res.send({ some: 'json' });
res.send('
some html

');
res.send(404, 'Sorry, we cannot find that!');
res.send(500, { error: 'something blew up' });
res.send(200);
</code></pre></div></div>

<p>æ­¤æ–¹æ³•é€‚ç”¨äºæ‰§è¡Œå¤§é‡çš„ç®€å•éæµå¼çš„å“åº”ä»»åŠ¡ï¼Œä¾‹å¦‚åœ¨æœªæå‰å®šä¹‰å’Œæä¾›è‡ªåŠ¨HEADå’ŒHTTPç¼“å­˜åˆ·æ–°æ”¯æŒçš„æƒ…å†µä¸‹è‡ªåŠ¨è®¾å®šContent-Lengthã€‚
å½“ä¼ å…¥çš„å†…å®¹ä¸ºBufferï¼Œé‚£ä¹ˆContent-Typeä¼šè¢«è®¾ç½®ä¸ºâ€application/octet-streamâ€ï¼Œé™¤éé¢„å…ˆå®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.set('Content-Type', 'text/html');
res.send(new Buffer('
some html

'));
</code></pre></div></div>

<p>å½“å‘é€å­—ç¬¦ä¸²æ—¶Content-Typeè®¾ç½®é»˜è®¤ä¸ºâ€text/htmlâ€ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.send('
some html

');
</code></pre></div></div>

<p>å½“å‘é€æ•°ç»„æˆ–è€…å¯¹è±¡æ—¶Expresså°†ä¼šè½¬æ¢æˆJSONæ ¼å¼ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.send({ user: 'tobi' })
res.send([1,2,3])
</code></pre></div></div>

<p>æœ€åå¦‚æœè¿”å›çš„æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œæ²¡æœ‰å‰é¢æåˆ°çš„ä»»ä½•ä¸€ä¸ªå“åº”ä½“ï¼ŒExpressä¼šä¸ºä½ è®¾ç½®ä¸€ä¸ªå“åº”å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚200å°†ä¼šå“åº”æ–‡æœ¬â€OKâ€ï¼Œ400å“åº”â€Not Foundâ€ç­‰ç­‰ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.send(200)
res.send(404)
res.send(500) ### res.json([status|body], [body])
</code></pre></div></div>

<p>å‘é€ä¸€ä¸ªJSONè¿”å›ã€‚å½“è¿”å›å¯¹è±¡æˆ–è€…æ•°ç»„æ—¶è¯¥æ–¹æ³•ä¸res.send()ç›¸åŒï¼Œç„¶è€Œå®ƒå¯ä»¥ç”¨æ¥å°†éå¯¹è±¡(null, undefined, ç­‰ç­‰)è½¬æ¢æˆç²¾å‡†çš„JSONï¼Œå°½ç®¡ä¸¥æ ¼æ¥è¯´è¿™äº›å¹¶ä¸æ˜¯æœ‰æ•ˆçš„JSONã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.json(null)
res.json({ user: 'tobi' })
res.json(500, { error: 'message' }) ### res.jsonp([status|body], [body])
</code></pre></div></div>

<p>ä½¿ç”¨JSONPå‘é€JSONå“åº”ã€‚è¯¥æ–¹æ³•ä¸res.json()ç›¸åŒï¼Œä½†å¤šäº†å¯¹JSONPå›è°ƒçš„æ”¯æŒã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.jsonp(null)
// =&gt; null

res.jsonp({ user: 'tobi' })
// =&gt; { "user": "tobi" }

res.jsonp(500, { error: 'message' })
// =&gt; { "error": "message" }
</code></pre></div></div>

<p>é»˜è®¤JSONPå›è°ƒå‡½æ•°åæ˜¯callbackï¼Œä½†ä½ å¯ä»¥é€šè¿‡ä¿®æ”¹jsonp callback nameå‚æ•°é‡æ–°å®šä¹‰ã€‚ä»¥ä¸‹æ˜¯JSONPå“åº”çš„ä¸€äº›ä¾‹å­ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ?callback=foo
res.jsonp({ user: 'tobi' })
// =&gt; foo({ "user": "tobi" })

app.set('jsonp callback name', 'cb');

// ?cb=foo
res.jsonp(500, { error: 'message' })
// =&gt; foo({ "error": "message" }) ### res.type(type)
</code></pre></div></div>

<p>è®¾ç½®Content-Typeç±»å‹ä¸ºmimeçš„ç±»å‹ï¼Œæˆ–è€…å½“â€/â€å­˜åœ¨æ—¶Content-Typeè¢«ç®€å•çš„è®¾ç½®æˆè¯¥ç±»å‹ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.type('.html');
res.type('html');
res.type('json');
res.type('application/json');
res.type('png'); ### res.format(object)
</code></pre></div></div>

<p>æ‰§è¡Œè¯·æ±‚æ—¶å­˜åœ¨è¯·æ±‚Acceptå¤´ä¸Šä¸‹æ–‡è½¬æ¢ã€‚è¯¥æ–¹æ³•ä½¿ç”¨req.acceptedï¼Œè¿™æ˜¯ä¸€ä¸ªæŒ‰å¯æ¥å—ç±»å‹é‡è¦æ€§æ’åºçš„æ•°ç»„ï¼Œå¦åˆ™ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°è¢«è°ƒç”¨ã€‚å½“æ²¡æœ‰åŒ¹é…çš„å›è°ƒå‡½æ•°æ‰§è¡Œæ—¶æœåŠ¡å™¨è¿”å›406 â€œNot Acceptableâ€ï¼Œæˆ–è€…è°ƒç”¨é»˜è®¤çš„å›è°ƒå‡½æ•°ã€‚</p>

<p>è®¾ç½®Content-Typeä¸ºä½ é€‰æ‹©ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œä½†ä½ å¯ä»¥åœ¨å›è°ƒå‡½æ•°ä¸­ä½¿ç”¨res.set()æˆ–è€…res.type()ç­‰ä¿®æ”¹ã€‚</p>

<p>ä¸‹ä¾‹å½“Acceptå¤´å­—æ®µè®¾ç½®æˆâ€application/jsonâ€æˆ–â€<em>/jsonâ€æ—¶å“åº”{ â€œmessageâ€: â€œheyâ€ }ï¼Œä½†å¦‚æœè®¾ç½®æˆâ€</em>/*â€œæ—¶å°†ä¼šå“åº”â€heyâ€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.format({
  'text/plain': function(){
    res.send('hey');
  },
  
  'text/html': function(){
    res.send('
hey

');
  },
  
  'application/json': function(){
    res.send({ message: 'hey' });
  }
});
</code></pre></div></div>

<p>é™¤äº†è§„èŒƒåŒ–çš„MIMEç±»å‹ä½ è¿˜å¯ä»¥ä½¿ç”¨æ‰©å±•åæ˜ å°„è¿™äº›ç±»å‹ï¼Œæä¾›ä¸€ä¸ªç¨å¾®ä¸é‚£ä¹ˆè¯¦ç»†çš„å®ç°ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.format({
  text: function(){
    res.send('hey');
  },
  
  html: function(){
    res.send('
hey

');
  },
  
  json: function(){
    res.send({ message: 'hey' });
  }
}); ### res.attachment([filename])
</code></pre></div></div>

<p>è®¾ç½®Content-Dispositionå¤´å­—æ®µä¸ºâ€attachmentâ€ã€‚å¦‚æœç»™å®šä¸€ä¸ªæ–‡ä»¶åï¼Œé‚£ä¹ˆContent-Typeå°†ä¼šé€šè¿‡res.type()è‡ªåŠ¨è®¾ç½®æˆåŸºäºæ‰©å±•åçš„ç±»å‹ï¼ŒContent-Dispositionçš„â€filename=â€å‚æ•°åŒæ—¶ä¹Ÿè¢«è®¾ç½®ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.attachment();
// Content-Disposition: attachment

res.attachment('path/to/logo.png');
// Content-Disposition: attachment; filename="logo.png"
// Content-Type: image/png ### res.sendfile(path, [options], [fn]])
</code></pre></div></div>

<p>ä¼ è¾“æ–‡ä»¶åˆ°ç»™å®šçš„è·¯å¾„ã€‚</p>

<p>è‡ªåŠ¨è®¾ç½®é»˜è®¤åŸºäºæ–‡ä»¶æ‰©å±•åçš„Content-Typeå“åº”å¤´ã€‚å½“ä¼ è¾“å‘ç”Ÿé”™è¯¯æ—¶fn(err)å›è°ƒå‡½æ•°è¢«è°ƒç”¨ã€‚</p>

<p>é€‰é¡¹ï¼š</p>

<ul>
  <li>maxAge ä»¥æ¯«ç§’ä¸ºå•ä½é»˜è®¤ä¸º0</li>
  <li>root ç›¸å¯¹æ–‡ä»¶åæ ¹ç›®å½•</li>
</ul>

<p>åœ¨ä¸‹ä¾‹ä¸­è¯¥æ–¹æ³•ä¸ºæ–‡ä»¶æœåŠ¡æä¾›ç»†ç²’åº¦æ”¯æŒï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.get('/user/:uid/photos/:file', function(req, res){
  var uid = req.params.uid
    , file = req.params.file;
    
  req.user.mayViewFilesFrom(uid, function(yes){
    if (yes) {
      res.sendfile('/uploads/' + uid + '/' + file);
    } else {
      res.send(403, 'Sorry! you cant see that.');
    }
  });
});
</code></pre></div></div>

<p>å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–è€…ç–‘é—®è¯·å‚é˜…sendé™„åŠ æ–‡æ¡£ã€‚</p>

<h3 id="resdownloadpath-filename-fn">res.download(path, [filename], [fn])</h3>

<p>ä¼ è¾“è·¯å¾„ä¸­çš„æ–‡ä»¶ä½œä¸ºé™„ä»¶ï¼Œé€šå¸¸æµè§ˆå™¨ä¼šæé†’ç”¨æˆ·ä¸‹è½½ã€‚Content-Disposition â€œfilename=â€å‚æ•°ï¼Œä¹Ÿå°±æ˜¯æ˜¾ç¤ºåœ¨æµè§ˆå™¨å¯¹è¯æ¡†çš„é»˜è®¤æ–‡ä»¶åï¼Œä½ ä¹Ÿå¯ä»¥æä¾›ä¸€ä¸ªè‡ªå®šä¹‰æ–‡ä»¶åã€‚</p>

<p>å½“ä¼ è¾“å®Œæˆæˆ–è€…ä¸­é€”å‘ç”Ÿé”™è¯¯æ—¶å°†ä¼šè°ƒç”¨fnå›è°ƒå‡½æ•°ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨res.sendfile()æ¥ä¼ è¾“æ–‡ä»¶ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.download('/report-12345.pdf');

res.download('/report-12345.pdf', 'report.pdf');

res.download('/report-12345.pdf', 'report.pdf', function(err){
  if (err) {
    // handle error, keep in mind the response may be partially-sent
    // so check res.headersSent
  } else {
    // decrement a download credit etc
  }
}); ### res.links(links) åŠ å…¥ç»™å®šçš„é“¾æ¥æ¥å¡«å……"Link"å“åº”å¤´å­—æ®µã€‚

res.links({
  next: 'http://api.example.com/users?page=2',
  last: 'http://api.example.com/users?page=5'
}); å¤„ç†åï¼š

Link: &lt;http://api.example.com/users?page=2&gt;; rel="next", 
      &lt;http://api.example.com/users?page=5&gt;; rel="last" ### res.locals
</code></pre></div></div>

<p>å“åº”æœ¬åœ°åŒ–å˜é‡ä½œç”¨åŸŸä¸ºrequestï¼Œå› æ­¤åªé€‚ç”¨äºåœ¨è¯¥request/responseå‘¨æœŸå†…å‘ˆç°çš„è§†å›¾ï¼Œå¦‚æœæœ‰çš„è¯ã€‚å…¶å®è¯¥APIè·Ÿapp.localsæ˜¯ç­‰åŒçš„ã€‚</p>

<p>è¿™ä¸ªå¯¹è±¡é€‚ç”¨äºçš„requestçº§åˆ«çš„ä¿¡æ¯ï¼Œä¾‹å¦‚requestè·¯å¾„ï¼Œç”¨æˆ·è®¤è¯ï¼Œç”¨æˆ·è®¾ç½®ç­‰ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.use(function(req, res, next){
  res.locals.user = req.user;
  res.locals.authenticated = ! req.user.anonymous;
  next();
}); ### res.render(view, [locals], callback)
</code></pre></div></div>

<p>æ¸²æŸ“ä¸€ä¸ªè§†å›¾ï¼ŒåŒæ—¶å‘å›è°ƒå‡½æ•°ä¼ é€’æ¸²æŸ“åçš„å­—ç¬¦ä¸²ã€‚å‘ç”Ÿé”™è¯¯æ—¶å†…éƒ¨è°ƒç”¨next(err)ã€‚å›è°ƒå‡½æ•°ä¼ å…¥å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ä»¥åŠæ¸²æŸ“åçš„é¡µé¢ï¼Œè¿™æ ·å°±ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œå“åº”äº†ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res.render('index', function(err, html){
  // ...
});

res.render('user', { name: 'Tobi' }, function(err, html){
  // ...
});
</code></pre></div></div>
:ET